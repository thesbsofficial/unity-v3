<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📦 SBS Media Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #000000, #1a1a2e, #16213e);
            color: #00ff41;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(15, 15, 35, 0.9);
            border: 2px solid #D4AF37;
            border-radius: 20px;
        }

        .header h1 {
            font-size: 3rem;
            color: #D4AF37;
            margin-bottom: 10px;
        }

        .controls {
            background: rgba(15, 15, 35, 0.9);
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .button {
            padding: 12px 24px;
            background: #D4AF37;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
        }

        .button:hover {
            background: #00ff41;
        }

        .button.active {
            background: #00ff41;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
            padding: 20px;
        }

        .item-card {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff41, transparent);
            transition: left 0.5s ease;
        }

        .item-card:hover::before {
            left: 100%;
        }

        .item-card:hover {
            transform: translateY(-5px);
            border-color: #00ff41;
            box-shadow: 0 10px 30px rgba(0, 255, 65, 0.2);
        }

        .item-image {
            width: 100%;
            height: 320px; /* 9:16 aspect ratio - if width is ~180px, height should be 320px */
            object-fit: contain; /* Shows full image without cropping */
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(0, 255, 65, 0.1), rgba(212, 175, 55, 0.1));
            /* Center the image in the container */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .item-image:hover {
            border-color: #D4AF37;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .item-name {
            color: #D4AF37;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1.3;
        }

        .item-price {
            color: #00ff41;
            font-weight: bold;
            font-size: 22px;
            margin-bottom: 12px;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tag {
            background: linear-gradient(45deg, rgba(212, 175, 55, 0.3), rgba(212, 175, 55, 0.2));
            color: #D4AF37;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid rgba(212, 175, 55, 0.5);
            text-transform: uppercase;
        }

        /* Specific tag styles for sections */
        .tag-featured { 
            background: linear-gradient(45deg, #ff4444, #ff6666); 
            color: white; 
            border-color: #ff4444;
        }
        
        .tag-sale { 
            background: linear-gradient(45deg, #ff8800, #ffaa33); 
            color: white; 
            border-color: #ff8800;
        }
        
        .tag-new { 
            background: linear-gradient(45deg, #00ff44, #66ff88); 
            color: black; 
            border-color: #00ff44;
        }
        
        .tag-live { 
            background: linear-gradient(45deg, #00ff00, #44ff44); 
            color: black; 
            border-color: #00ff00;
        }
        
        .tag-test {
            background: linear-gradient(45deg, #9944ff, #bb66ff);
            color: white;
            border-color: #9944ff;
        }
        
        .tag-deleted {
            background: linear-gradient(45deg, #ff4444, #ff6666);
            color: white;
            border-color: #ff4444;
            font-weight: bold;
        }
        
        .deleted-item {
            opacity: 0.6;
            border: 2px dashed #ff4444 !important;
            position: relative;
        }
        
        .deleted-item::after {
            content: "DELETED FROM CLOUDFLARE";
            position: absolute;
            top: -10px;
            left: -10px;
            background: #ff4444;
            color: white;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            font-weight: bold;
            z-index: 10;
        }
        
        .deleted-image-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #f5f5f5, #e0e0e0);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ccc;
            border-radius: 8px;
        }
        
        .deleted-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }
        
        .deleted-text {
            color: #666;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tag-trending {
            background: linear-gradient(45deg, #4488ff, #66aaff);
            color: white;
            border-color: #4488ff;
        }
        
        .tag-staff-picks {
            background: linear-gradient(45deg, #ff44ff, #ff66ff);
            color: white;
            border-color: #ff44ff;
        }
        
        .tag-limited {
            background: linear-gradient(45deg, #ffaa00, #ffcc44);
            color: black;
            border-color: #ffaa00;
        }
        
        .tag-bestseller {
            background: linear-gradient(45deg, #ffd700, #fff44f);
            color: black;
            border-color: #ffd700;
        }
        
        .tag-premium {
            background: linear-gradient(45deg, #8a2be2, #9370db);
            color: white;
            border-color: #8a2be2;
        }
        
        .tag-clearance {
            background: linear-gradient(45deg, #dc143c, #ff6347);
            color: white;
            border-color: #dc143c;
        }
        
        .tag-category, .tag-size {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border-color: rgba(0, 255, 65, 0.5);
        }

        .item-details {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .status-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            z-index: 10;
            background: rgba(0, 255, 65, 0.2);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #00ff41;
        }

        .loading {
            text-align: center;
            color: #00ff41;
            font-size: 18px;
            padding: 50px;
        }

        /* Gallery View */
        .gallery-view .inventory-grid {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .gallery-view .item-card {
            padding: 20px;
        }

        .gallery-view .item-image {
            width: 90px;
            height: 160px; /* 9:16 aspect ratio for thumbnails (90x160) */
            object-fit: contain; /* Shows full image */
            float: left;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        /* Customer View */
        .customer-view .inventory-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .customer-view .item-card {
            text-align: center;
            padding: 20px;
        }

        .customer-view .item-image {
            height: 280px; /* 9:16 aspect ratio for customer view (~157x280) */
            object-fit: contain; /* Shows full image without cropping */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📦 SBS Media Hub - Admin Module</h1>
            <p>Cloudflare Integration Module for Main Admin System</p>
            <button class="button" onclick="showHelp()" style="position: absolute; top: 20px; right: 20px; padding: 8px 12px; font-size: 14px;">❓ Help</button>
        </div>

        <!-- Controls -->
        <div class="controls">
            <h3 style="color: #D4AF37; margin-bottom: 15px;">� Admin Test Controls</h3>
            
            <button class="button" onclick="showUpload()">📤 Upload Images</button>
            
            <div style="margin-top: 15px;">
                <button class="button active" id="gridBtn" onclick="setView('grid')">� Load Images & Grid View</button>


            </div>

            <!-- Admin Test Sections -->
            <div style="margin-top: 20px; border-top: 2px solid #D4AF37; padding-top: 15px;">
                <h4 style="color: #D4AF37; margin-bottom: 10px;">🧪 Test Section Filters</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button class="button active" id="allBtn" onclick="loadImagesAndShowSection('all')" style="font-size: 12px;">� Load All Items</button>


                </div>
                <div style="margin-top: 10px;">
                    <select id="tagFilter" onchange="filterByTag()" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41; font-size: 12px;">
                        <option value="all">🏷️ All Tags</option>
                        <option value="featured">🔥 Featured</option>
                        <option value="sale">💰 Sale</option>
                        <option value="new">✨ New Arrivals</option>
                        <option value="trending">📈 Trending</option>
                        <option value="staff-picks">⭐ Staff Picks</option>
                        <option value="limited">⚡ Limited Stock</option>
                        <option value="bestseller">🏆 Bestseller</option>
                        <option value="premium">💎 Premium</option>
                        <option value="clearance">🏷️ Clearance</option>
                        <option value="deleted">❌ Deleted Items</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <button class="button" id="toggleDeletedBtn" onclick="toggleShowDeleted()" style="font-size: 11px; background: #666;">👁️ Show Deleted (Hidden)</button>
                </div>
                <p style="color: #aaa; font-size: 12px; margin-top: 8px;">Load items and filter by different tags</p>
            </div>

            <div id="status" style="margin-top: 15px; color: #00ff41; font-weight: bold;"></div>
            
            <!-- Database vs Cloudflare Summary -->
            <div id="comparisonSummary" style="display: none; background: rgba(20, 20, 40, 0.8); border: 1px solid #444; border-radius: 8px; padding: 15px; margin: 15px 0; font-size: 12px;">
                <h4 style="color: #D4AF37; margin: 0 0 10px 0; font-size: 14px;">📊 Database vs Cloudflare Comparison</h4>
                <div id="comparisonDetails"></div>
            </div>
        </div>

        <!-- Inventory Display -->
        <div id="inventoryContainer">
            <div class="loading">
                📦 Start API proxy first, then click "🔄 Load All Items" to view your images...
            </div>
        </div>

        <!-- Upload Section (Hidden by default) -->
        <div id="uploadSection" style="display: none; background: rgba(15, 15, 35, 0.9); border: 2px solid #D4AF37; border-radius: 15px; padding: 30px; margin-top: 30px;">
            <h2 style="color: #D4AF37; text-align: center; margin-bottom: 20px;">📸 Upload New Stock to Cloudflare</h2>
            
            <div id="dropZone" style="border: 2px dashed #D4AF37; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 20px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                <div class="drop-zone-text" style="color: #D4AF37; font-size: 18px; margin-bottom: 10px;">📸 Tap to Select JPEG Photos</div>
                <div style="color: #00ff41; font-size: 14px;">Upload to your Cloudflare Images account</div>
                <div style="color: #ff9900; font-size: 12px; margin-top: 10px;">⚠️ JPEG files only (.jpg, .jpeg)</div>
            </div>
            
            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,image/jpeg" style="display: none;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: #D4AF37; display: block; margin-bottom: 5px;">Category & Condition:</label>
                    <select id="category" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                        <option value="">Select Category & Condition</option>
                        <option value="BN-CLOTHES">Brand New • Clothes</option>
                        <option value="BN-SHOES">Brand New • Shoes</option>
                        <option value="PO-CLOTHES">Pre-Owned • Clothes</option>
                        <option value="PO-SHOES">Pre-Owned • Shoes</option>
                    </select>
                </div>

                <div>
                    <label style="color: #D4AF37; display: block; margin-bottom: 5px;">Size:</label>
                    <select id="size" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                        <option value="">Select Category First</option>
                    </select>
                </div>
            </div>

            <!-- Smart Filename Generator -->
            <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid #8a2be2; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #8a2be2; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                    ⚡ Auto Smart Naming
                    <span style="font-size: 12px; color: #00ff41; background: rgba(0, 255, 65, 0.1); padding: 3px 8px; border-radius: 12px;">Automatic Timestamp + Tags</span>
                </h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Optional Description (leave blank for auto-naming):</label>
                    <input type="text" id="itemDescription" placeholder="Optional: Nike Air Max, Adidas Hoodie... (leave blank for timestamp only)" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #8a2be2; border-radius: 8px; color: #00ff41;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Filename Format:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="button" onclick="setFilenameFormat('auto-timestamp')" id="btnAutoTimestamp" style="font-size: 11px; background: #8a2be2;">⚡ Auto (Timestamp)</button>
                        <button class="button" onclick="setFilenameFormat('category-first')" id="btnCategoryFirst" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">🏷️ Category First</button>
                        <button class="button" onclick="setFilenameFormat('clean')" id="btnClean" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">✨ Clean Format</button>
                        <button class="button" onclick="setFilenameFormat('simple')" id="btnSimple" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">📝 Simple</button>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Preview Generated Name:</label>
                    <div id="filenamePreview" style="background: rgba(0, 0, 0, 0.3); border: 1px solid #8a2be2; padding: 12px; border-radius: 8px; color: #8a2be2; font-family: monospace; font-weight: bold; min-height: 20px;">Select category and size to see preview</div>
                    
                    <div id="filenameBreakdown" style="background: rgba(0, 0, 0, 0.2); border: 1px solid #666; border-radius: 8px; padding: 10px; margin-top: 8px; font-size: 11px; display: none;">
                        <div style="color: #aaa; margin-bottom: 5px;">🔍 Component Breakdown:</div>
                        <div id="breakdownContent" style="line-height: 1.6;"></div>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; border-radius: 8px; padding: 12px;">
                    <h4 style="color: #ffff00; margin: 0 0 10px 0;">💡 Self-Explaining Filename Examples:</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                        <li><strong>Auto (Default):</strong> CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-TIME-1430-BATCH-B09251430-ITEM-001.jpeg</li>
                        <li><strong>With Description:</strong> DESC-Nike-Air-Max-CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-BATCH-B09251430-ITEM-001.jpeg</li>
                        <li><strong>Category First:</strong> CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-TIME-1430-BATCH-B09251430-ITEM-002.jpeg</li>
                        <li><strong>Simple:</strong> SBS-BATCH-B09251430-ITEM-003-DATE-20250925-TIME-1430.jpeg</li>
                    </ul>
                    
                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h5 style="color: #ffff00; margin: 0 0 10px 0;">🔍 Self-Explaining Component Guide:</h5>
                        <div style="font-family: monospace; font-size: 13px; line-height: 1.8;">
                            <div style="color: #8a2be2;">DESC-Nike-Air-Max-CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-BATCH-B09251430-ITEM-001.jpeg</div>
                            <div style="margin-top: 8px; font-size: 11px;">
                                <span style="color: #ff6b6b;">📝 DESC-Nike-Air-Max</span> = Custom Description (Optional)<br>
                                <span style="color: #4ecdc4;">🏷️ CAT-BN-SHOES</span> = Category & Condition<br>
                                <span style="color: #45b7d1;">📏 SIZE-UK-9</span> = Size Information<br>
                                <span style="color: #96ceb4;">📅 DATE-20250925</span> = Date (YYYYMMDD)<br>
                                <span style="color: #feca57;">📦 BATCH-B09251430</span> = Batch ID (MMDDHHMM)<br>
                                <span style="color: #ff9ff3;">🔢 ITEM-001</span> = Sequential Item Number<br>
                                <span style="color: #a8a8a8;">📄 .jpeg</span> = File Extension
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 0, 0.1); border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <p style="color: #ffff00; margin: 0; font-size: 11px;"><strong>💡 Key Benefits:</strong> Each filename is completely self-explaining! You can instantly identify DESC (description), CAT (category), SIZE, DATE, BATCH, and ITEM just by looking at the filename.</p>
                        </div>
                    </div>
                    
                    <p style="color: #ffff00; margin: 8px 0 0 0; font-size: 11px;"><strong>📦 Marker System:</strong> Every component has a clear prefix so you know exactly what each part means!</p>
                </div>
            </div>

            <!-- Admin Test Controls -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: #D4AF37; display: block; margin-bottom: 5px;">Site Section Tag:</label>
                    <select id="siteSection" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                        <option value="featured">🔥 Featured Section</option>
                        <option value="sale">💰 Sale Section</option>
                        <option value="new">✨ New Arrivals</option>
                        <option value="trending">📈 Trending</option>
                        <option value="staff-picks">⭐ Staff Picks</option>
                    </select>
                </div>
                
                <div>
                    <label style="color: #D4AF37; display: block; margin-bottom: 5px;">Additional Tags:</label>
                    <select id="additionalTag" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                        <option value="">None</option>
                        <option value="limited">⚡ Limited Stock</option>
                        <option value="bestseller">🏆 Bestseller</option>
                        <option value="premium">💎 Premium</option>
                        <option value="clearance">🏷️ Clearance</option>
                    </select>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="button" onclick="processUpload()">🚀 Upload Images</button>
                <button class="button" onclick="hideUpload()" style="background: #666; margin-left: 10px;">❌ Cancel</button>
                <button class="button" onclick="toggleLogs()" style="background: #333; margin-left: 10px;">📋 Show Logs</button>
            </div>
            <div id="uploadProgress" style="margin-top: 20px; display: none;">
                <div style="background: rgba(26, 26, 46, 0.9); border-radius: 8px; padding: 15px;">
                    <div id="progressBar" style="width: 0%; height: 20px; background: linear-gradient(90deg, #D4AF37, #00ff41); border-radius: 10px; transition: width 0.3s ease;"></div>
                    <div id="progressText" style="color: #00ff41; text-align: center; margin-top: 10px;">Preparing upload...</div>
                </div>
            </div>
            
            <!-- Log Viewer -->
            <div id="logViewer" style="display: none; margin-top: 20px; background: rgba(0, 0, 0, 0.8); border-radius: 8px; padding: 15px;">
                <div style="color: #D4AF37; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <span>📋 Upload Logs</span>
                    <button onclick="clearLogs()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">Clear Logs</button>
                </div>
                <div id="logContent" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4; color: #00ff41; white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15, 15, 35, 0.95); border: 2px solid #D4AF37; border-radius: 20px; padding: 30px; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #D4AF37; margin: 0;">❓ How to Use SBS Media Hub</h2>
                <button onclick="hideHelp()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;">✕</button>
            </div>
            
            <div style="color: #00ff41; line-height: 1.6; font-size: 14px;">
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">� Security & Setup</h3>
                <p><strong>Important:</strong> This system now uses a secure API proxy for enhanced security.</p>
                <p><strong>Before using:</strong> Run <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"START-API-PROXY.bat"</span> to start the proxy server on port 3001.</p>
                <p>All API tokens are now stored server-side for security - no sensitive data in the browser!</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">�🔄 Loading Your Images</h3>
                <p><strong>Step 1:</strong> Click the <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"🔄 Load All Items"</span> button to fetch all your images from Cloudflare.</p>
                <p>This will load your inventory and display it in the grid view automatically.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">🔲 View Controls</h3>
                <p><strong>Grid View:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"🔲 Grid View"</span> to switch to the grid layout (default view).</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">🏷️ Filtering by Tags</h3>
                <p><strong>Tag Dropdown:</strong> Use the dropdown menu to filter items by specific tags:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>🔥 Featured - Highlighted items</li>
                    <li>💰 Sale - Items on sale</li>
                    <li>✨ New Arrivals - Recently added items</li>
                    <li>📈 Trending - Popular items</li>
                    <li>⭐ Staff Picks - Recommended by staff</li>
                    <li>⚡ Limited Stock - Low inventory items</li>
                    <li>🏆 Bestseller - Top selling items</li>
                    <li>💎 Premium - High-end items</li>
                    <li>🏷️ Clearance - Discounted items</li>
                </ul>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">📤 Uploading New Images</h3>
                <p><strong>Upload Images:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"📤 Upload Images"</span> to add new images to your Cloudflare account.</p>
                <p>Select category, size, and tags before uploading JPEG files.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">💡 Quick Start Guide</h3>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Click "🔄 Load All Items" to see your inventory</li>
                    <li>Use the tag dropdown to filter specific items</li>
                    <li>Switch views using the "🔲 Grid View" button</li>
                    <li>Upload new items with "📤 Upload Images"</li>
                </ol>

                <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <p style="color: #ffff00; margin: 0;"><strong>💡 Tip:</strong> Always load your items first before using filters or view controls!</p>
                </div>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">📋 Recent Changes & Progress Tracker</h3>
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">✅ Step 1 - Clean Page (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">✓</span> Modernized upload controls (removed "test" terminology)</li>
                        <li><span style="color: #00ff41;">✓</span> Added system font theme and iPhone-first design</li>
                        <li><span style="color: #00ff41;">✓</span> Implemented in-app help system with progress tracking</li>
                        <li><span style="color: #00ff41;">✓</span> Cleaned up legacy test controls while keeping functionality</li>
                    </ul>
                </div>
                
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">✅ Step 2 - API Proxy Security (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">✓</span> Created PowerShell API proxy server (api-proxy-server.ps1)</li>
                        <li><span style="color: #00ff41;">✓</span> Added START-API-PROXY.bat for easy server startup</li>
                        <li><span style="color: #00ff41;">✓</span> Removed all API tokens from client-side code</li>
                        <li><span style="color: #00ff41;">✓</span> Updated all API calls to use secure proxy</li>
                        <li><span style="color: #00ff41;">✓</span> Enhanced security with server-side token storage</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">✅ Step 3 - Tag Filtering System (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">✓</span> Replaced individual filter buttons with dropdown</li>
                        <li><span style="color: #00ff41;">✓</span> Added comprehensive tag options (Featured, Sale, New, etc.)</li>
                        <li><span style="color: #00ff41;">✓</span> Implemented filterByTag() function for dropdown filtering</li>
                        <li><span style="color: #00ff41;">✓</span> Created loadImagesAndShowSection() for combined operations</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">✅ Step 4 - Help System Implementation (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">✓</span> Added "❓ Help" button in header</li>
                        <li><span style="color: #00ff41;">✓</span> Created comprehensive help modal with step-by-step guides</li>
                        <li><span style="color: #00ff41;">✓</span> Documented all features and new functionality</li>
                        <li><span style="color: #00ff41;">✓</span> Added progress tracker for transparency</li>
                    </ul>
                </div>

                <div style="background: rgba(46, 26, 26, 0.9); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">⏳ Next Planned Steps (From Build Plan)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #ff8800;">⏳</span> Step 5 - Items API (JSON store + CRUD + audit)</li>
                        <li><span style="color: #ff8800;">⏳</span> Step 6 - Grid with View More 9 (virtualization)</li>
                        <li><span style="color: #ff8800;">⏳</span> Step 7 - Constants Wired (preset validation)</li>
                        <li><span style="color: #ff8800;">⏳</span> Step 8 - Bulk Selection Model (select all filtered)</li>
                        <li><span style="color: #ff8800;">⏳</span> Step 9 - Bulk Actions System (add/remove tags, set status)</li>
                    </ul>
                </div>

                <div style="background: rgba(35, 35, 15, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 10px; margin: 15px 0 5px 0; text-align: center;">
                    <p style="color: #D4AF37; margin: 0; font-size: 12px;"><strong>📝 Feedback Welcome:</strong> Each step will be documented here for review and iteration</p>
                </div>

                <!-- LOCAL STORAGE & SYSTEM INSPECTOR -->
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">🔍 System Inspector & Local Storage</h3>
                
                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">📊 Current System Status</h4>
                    <div id="systemStatusInspector" style="font-family: monospace; font-size: 12px; color: #00ff41;">
                        <div>Loading system status...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">💾 Local Storage Contents</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="refreshLocalStorage()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">🔄 Refresh</button>
                        <button onclick="clearAllLocalStorage()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">🗑️ Clear All</button>
                    </div>
                    <div id="localStorageInspector" style="font-family: monospace; font-size: 11px; color: #ff8800; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Refresh" to view local storage contents...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #8a2be2; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #8a2be2; margin: 0 0 10px 0;">📝 Live Activity Log</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="refreshActivityLog()" style="background: #8a2be2; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">🔄 Refresh</button>
                        <button onclick="downloadLogs()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">📥 Download Logs</button>
                    </div>
                    <div id="activityLogInspector" style="font-family: monospace; font-size: 11px; color: #8a2be2; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Activity log will appear here...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #D4AF37; margin: 0 0 10px 0;">🔧 Database Connection Test</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="testDatabaseConnection()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">🧪 Test Connection</button>
                        <button onclick="viewDatabaseStats()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">📊 View Stats</button>
                    </div>
                    <div id="databaseTestResult" style="font-family: monospace; font-size: 11px; color: #D4AF37; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Test Connection" to check database status...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // API Configuration - Using unified API server
        const API_CONFIG = {
            proxyUrl: 'http://localhost:9600/api', // Updated to match running server
            accountHash: '7B8CAeDtA5h1f1Dyh_X-hg' // Still needed for public image URLs
        };

        // Legacy config for compatibility (tokens removed for security)
        const CLOUDFLARE_CONFIG = {
            accountHash: '7B8CAeDtA5h1f1Dyh_X-hg'
        };

        // Global State
        let currentView = 'grid';
        let inventory = [];
        // DELETED DETECTION REMOVED - keeping it simple

        // Load Items from our local database
        async function loadItems() {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = '🔄 Loading items from local database...';
            logMessage('Fetching items from /api/items...');

            try {
                const response = await fetch(`${API_CONFIG.proxyUrl}/images`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch items: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && Array.isArray(result.images)) {
                    // Map Cloudflare images to our format
                    statusDiv.textContent = '🔍 Processing Cloudflare images...';
                    logMessage('Processing image data from Cloudflare...');
                    
                    inventory = result.images.map(item => ({
                        id: item.id,
                        name: item.filename || item.id,
                        filename: item.filename || 'Unknown',
                        cloudflareId: item.id,
                        uploaded: item.uploaded,
                        variants: item.variants || [],
                        meta: item.meta || {},
                        tags: item.meta?.tags ? item.meta.tags.split(',') : [],
                        image: `https://imagedelivery.net/${API_CONFIG.accountHash}/${item.id}/w=1080,h=1920`,
                        imageStatus: 'available'
                    }));

                    // Sort by upload date (newest first)
                    inventory.sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded));
                                };
                            }
                            
                            try {
                                // Enhanced image validation with composition detection
                                const imageCheck = await fetch(imageUrl, { method: 'HEAD' });
                                
                                if (imageCheck.ok) {
                                    const contentType = imageCheck.headers.get('content-type');
                                    
                                    // Check if content-type indicates it's actually an image
                                    if (contentType && contentType.startsWith('image/')) {
                                        // Additional check: validate if it's a real image by testing load
                                        return new Promise((resolve) => {
                                            const testImg = new Image();
                                            const timeout = setTimeout(() => {
                                                logMessage(`⚠️ Image ${item.filename} timeout during composition validation`);
                                                const updatedTags = [...(item.tags || [])];
                                                if (!updatedTags.includes('DELETED')) {
                                                    updatedTags.push('DELETED');
                                                }
                                                resolve({
                                                    ...item,
                                                    image: imageUrl,
                                                    imageStatus: 'composition-failed',
                                                    tags: updatedTags,
                                                    needsUpdate: true,
                                                    deleteReason: `Image composition validation timeout`
                                                });
                                            }, 3000); // 3 second timeout
                                            
                                            testImg.onload = function() {
                                                clearTimeout(timeout);
                                                // Check if image dimensions suggest it's a placeholder/error image
                                                if (this.naturalWidth < 50 || this.naturalHeight < 50) {
                                                    logMessage(`⚠️ Image ${item.filename} has suspicious dimensions (${this.naturalWidth}x${this.naturalHeight}) - likely placeholder`);
                                                    const updatedTags = [...(item.tags || [])];
                                                    if (!updatedTags.includes('DELETED')) {
                                                        updatedTags.push('DELETED');
                                                    }
                                                    resolve({
                                                        ...item,
                                                        image: imageUrl,
                                                        imageStatus: 'placeholder-detected',
                                                        tags: updatedTags,
                                                        needsUpdate: true,
                                                        deleteReason: `Suspicious placeholder dimensions: ${this.naturalWidth}x${this.naturalHeight}`
                                                    });
                                                } else {
                                                    resolve({
                                                        ...item,
                                                        image: imageUrl,
                                                        imageStatus: 'available',
                                                        needsUpdate: false
                                                    });
                                                }
                                            };
                                            
                                            testImg.onerror = function() {
                                                clearTimeout(timeout);
                                                logMessage(`⚠️ Image ${item.filename} failed to load during composition validation`);
                                                const updatedTags = [...(item.tags || [])];
                                                if (!updatedTags.includes('DELETED')) {
                                                    updatedTags.push('DELETED');
                                                }
                                                resolve({
                                                    ...item,
                                                    image: imageUrl,
                                                    imageStatus: 'composition-failed',
                                                    tags: updatedTags,
                                                    needsUpdate: true,
                                                    deleteReason: `Image failed to load during validation`
                                                });
                                            };
                                            
                                            // Set crossOrigin to handle potential CORS issues
                                            testImg.crossOrigin = 'anonymous';
                                            testImg.src = imageUrl;
                                        });
                                    } else if (!contentType) {
                                        // No content-type header - do a small GET request to check actual content
                                        try {
                                            const partialCheck = await fetch(imageUrl, { 
                                                method: 'GET',
                                                headers: { 'Range': 'bytes=0-1023' } // First 1KB only
                                            });
                                            
                                            if (partialCheck.ok) {
                                                const actualContentType = partialCheck.headers.get('content-type');
                                                const responseText = await partialCheck.text();
                                                
                                                // Check if response looks like HTML/text error page
                                                if (actualContentType && actualContentType.startsWith('text/') || 
                                                    responseText.includes('<html>') || 
                                                    responseText.includes('<!DOCTYPE') ||
                                                    responseText.includes('error') ||
                                                    responseText.includes('not found')) {
                                                    
                                                    logMessage(`⚠️ Image ${item.filename} returns text/HTML content instead of image data`);
                                                    
                                                    const updatedTags = [...(item.tags || [])];
                                                    if (!updatedTags.includes('DELETED')) {
                                                        updatedTags.push('DELETED');
                                                    }
                                                    
                                                    return {
                                                        ...item,
                                                        image: imageUrl,
                                                        imageStatus: 'text-content',
                                                        tags: updatedTags,
                                                        needsUpdate: true,
                                                        deleteReason: `Returns text/HTML instead of image data`
                                                    };
                                                } else {
                                                    // Looks like valid image data
                                                    return {
                                                        ...item,
                                                        image: imageUrl,
                                                        imageStatus: 'available',
                                                        needsUpdate: false
                                                    };
                                                }
                                            } else {
                                                throw new Error(`Partial content check failed: ${partialCheck.status}`);
                                            }
                                        } catch (partialError) {
                                            logMessage(`⚠️ Could not verify image content for ${item.filename}: ${partialError.message}`);
                                            // Fall through to treat as missing
                                        }
                                    } else {
                                        // Response is OK but not an image (likely text/html error page)
                                        logMessage(`⚠️ Image ${item.filename} returns non-image content: ${contentType}`);
                                        
                                        const updatedTags = [...(item.tags || [])];
                                        if (!updatedTags.includes('DELETED')) {
                                            updatedTags.push('DELETED');
                                        }
                                        
                                        return {
                                            ...item,
                                            image: imageUrl,
                                            imageStatus: 'text-response',
                                            tags: updatedTags,
                                            needsUpdate: true,
                                            deleteReason: `Returns ${contentType} instead of image`
                                        };
                                    }
                                } else {
                                    // HTTP error (404, 403, etc.)
                                    logMessage(`⚠️ Image ${item.filename} HTTP error: ${imageCheck.status}`);
                                    
                                    const updatedTags = [...(item.tags || [])];
                                    if (!updatedTags.includes('DELETED')) {
                                        updatedTags.push('DELETED');
                                    }
                                    
                                    return {
                                        ...item,
                                        image: imageUrl,
                                        imageStatus: 'missing',
                                        tags: updatedTags,
                                        needsUpdate: true,
                                        deleteReason: `HTTP ${imageCheck.status}`
                                    };
                                }
                            } catch (error) {
                                // Network error or complete failure
                                logMessage(`⚠️ Image ${item.filename} network error: ${error.message}`);
                                
                                const updatedTags = [...(item.tags || [])];
                                if (!updatedTags.includes('DELETED') && !updatedTags.includes('deleted')) {
                                    updatedTags.push('DELETED');
                                }
                                
                                return {
                                    ...item,
                                    image: imageUrl,
                                    imageStatus: 'missing',
                                    tags: updatedTags,
                                    needsUpdate: true,
                                    deleteReason: error.message
                                };
                            }
                        })
                    );
                    
                    inventory = validatedItems
                        .filter(result => result.status === 'fulfilled')
                        .map(result => result.value);
                    
                    // Update items that need DELETED tag in the database
                    const itemsNeedingUpdate = inventory.filter(item => item.needsUpdate);
                    if (itemsNeedingUpdate.length > 0) {
                        // Categorize the types of issues found
                        const httpErrors = itemsNeedingUpdate.filter(item => item.imageStatus === 'missing');
                        const textResponses = itemsNeedingUpdate.filter(item => 
                            item.imageStatus === 'text-response' || item.imageStatus === 'text-content'
                        );
                        
                        logMessage(`🔍 Found ${itemsNeedingUpdate.length} problematic images:`);
                        if (httpErrors.length > 0) {
                            logMessage(`  📴 ${httpErrors.length} HTTP errors (404, 403, etc.)`);
                        }
                        if (textResponses.length > 0) {
                            logMessage(`  📄 ${textResponses.length} images returning text/HTML instead of image data`);
                        }
                        logMessage(`Adding DELETED tags to database...`);
                        
                        for (const item of itemsNeedingUpdate) {
                            try {
                                await updateItemTags(item.id, item.tags);
                                const statusIcon = item.imageStatus === 'text-response' || item.imageStatus === 'text-content' ? '📄' : '📴';
                                logMessage(`✅ ${statusIcon} Tagged ${item.filename} as DELETED (${item.deleteReason})`);
                            } catch (error) {
                                logError(`Failed to tag item ${item.id} as DELETED`, error);
                            }
                        }
                    }
                    
                    // Count different types
                    const availableCount = inventory.filter(item => item.imageStatus === 'available').length;
                    const deletedCount = inventory.filter(item => 
                        item.imageStatus === 'missing' || item.imageStatus === 'deleted-tagged' || item.imageStatus === 'text-content' || item.imageStatus === 'text-response'
                    ).length;
                    const newDeletedCount = inventory.filter(item => item.needsUpdate && item.imageStatus !== 'deleted-tagged').length;
                    
                    // Sort by creation date, newest first
                    inventory.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    statusDiv.innerHTML = `
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <span>✅ Database: <strong>${inventory.length}</strong> items</span>
                            <span style="color: #4CAF50;">🟢 Live: <strong>${availableCount}</strong></span>
                            <span style="color: #f44336;">🔴 Deleted: <strong>${deletedCount}</strong></span>
                            ${newDeletedCount > 0 ? `<span style="color: #ff9800;">⚠️ <strong>${newDeletedCount}</strong> newly detected deletions</span>` : ''}
                            ${!showDeleted ? '<span style="color: #666; font-size: 11px;">(Hiding deleted items - click 👁️ to show)</span>' : '<span style="color: #4CAF50; font-size: 11px;">(Showing all items including deleted)</span>'}
                        </div>
                    `;
                    
                    // Update comparison summary
                    const summaryDiv = document.getElementById('comparisonSummary');
                    const detailsDiv = document.getElementById('comparisonDetails');
                    
                    if (deletedCount > 0 || newDeletedCount > 0) {
                        summaryDiv.style.display = 'block';
                        
                        const deletedItems = inventory.filter(item => 
                            item.imageStatus === 'missing' || item.imageStatus === 'deleted-tagged' || item.imageStatus === 'text-content' || item.imageStatus === 'text-response'
                        );
                        
                        let detailsHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                <div>
                                    <strong style="color: #4CAF50;">✅ Available on Cloudflare:</strong> ${availableCount} items<br>
                                    <small style="color: #999;">These images load correctly and are live</small>
                                </div>
                                <div>
                                    <strong style="color: #f44336;">❌ Missing/Deleted:</strong> ${deletedCount} items<br>
                                    <small style="color: #999;">These are in your database but not on Cloudflare</small>
                                </div>
                            </div>
                        `;
                        
                        if (newDeletedCount > 0) {
                            detailsHTML += `
                                <div style="background: rgba(255, 152, 0, 0.1); border-left: 3px solid #ff9800; padding: 8px; margin: 8px 0;">
                                    <strong style="color: #ff9800;">⚠️ ${newDeletedCount} Recently Deleted Items Detected</strong><br>
                                    <small style="color: #ccc;">These items were automatically marked as DELETED during this scan</small>
                                </div>
                            `;
                        }
                        
                        detailsHTML += `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <strong style="color: #D4AF37;">💡 Database Benefits:</strong><br>
                                <small style="color: #ccc;">
                                    • Keep complete inventory records even after Cloudflare deletion<br>
                                    • Track what was deleted and when<br>
                                    • Maintain pricing, descriptions, and metadata<br>
                                    • Easy re-upload with preserved information
                                </small>
                            </div>
                        `;
                        
                        detailsDiv.innerHTML = detailsHTML;
                    } else {
                        summaryDiv.style.display = 'none';
                    }
                    
                    logMessage(`Database vs Cloudflare comparison: ${inventory.length} total items, ${availableCount} live on Cloudflare, ${deletedCount} deleted/missing${newDeletedCount > 0 ? `, ${newDeletedCount} newly detected deletions` : ''}.`);
                    displayInventory();
                } else {
                    throw new Error('Invalid data format received from items API.');
                }

            } catch (error) {
                console.error('Error loading items:', error);
                statusDiv.textContent = `❌ Error: ${error.message}`;
                logError('Failed to load items from database', error);
                if (error.message.includes('Failed to fetch')) {
                    statusDiv.textContent += ' - Is the API server running?';
                }
            }
        }

        // Help system functions
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
            // Auto-refresh inspector data when help is opened
            setTimeout(() => {
                refreshSystemStatus();
                refreshLocalStorage();
                refreshActivityLog();
            }, 100);
        }

        function hideHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Set View Mode
        function setView(mode) {
            currentView = mode;
            
            console.log(`Switching to ${mode} view`);
            
            // Update button states
            document.querySelectorAll('.button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(mode + 'Btn').classList.add('active');
            
            // Update container class for styling
            const container = document.getElementById('inventoryContainer');
            container.className = mode + '-view';
            
            // Redisplay inventory in new view
            displayInventory();
        }

        // Display Inventory
        function displayInventory() {
            const container = document.getElementById('inventoryContainer');
            const filteredInventory = getFilteredInventory();
            
            if (inventory.length === 0) {
                container.innerHTML = '<div class="loading">📦 No images loaded yet. Start API proxy and click "🔄 Load All Items" to see your inventory.</div>';
                return;
            }

            if (filteredInventory.length === 0) {
                container.innerHTML = `<div class="loading">🔍 No items in ${currentSection.toUpperCase()} section yet.</div>`;
                return;
            }

            console.log(`Displaying ${filteredInventory.length}/${inventory.length} items in ${currentView} view (${currentSection.toUpperCase()} section)`);

            let html = '<div class="inventory-grid">';

            filteredInventory.forEach(item => {
                // Create tag HTML with better styling
                const tagHtml = item.tags.map(tag => {
                    let tagClass = 'tag';
                    let tagIcon = '';
                    
                    // Site section tags
                    if (tag === 'FEATURED') {
                        tagClass += ' tag-featured';
                        tagIcon = '🔥 ';
                    } else if (tag === 'SALE') {
                        tagClass += ' tag-sale';
                        tagIcon = '💰 ';
                    } else if (tag === 'NEW') {
                        tagClass += ' tag-new';
                        tagIcon = '✨ ';
                    } else if (tag === 'TRENDING') {
                        tagClass += ' tag-trending';
                        tagIcon = '📈 ';
                    } else if (tag === 'STAFF-PICKS') {
                        tagClass += ' tag-staff-picks';
                        tagIcon = '⭐ ';
                    }
                    // Additional tags
                    else if (tag === 'LIMITED') {
                        tagClass += ' tag-limited';
                        tagIcon = '⚡ ';
                    } else if (tag === 'BESTSELLER') {
                        tagClass += ' tag-bestseller';
                        tagIcon = '🏆 ';
                    } else if (tag === 'PREMIUM') {
                        tagClass += ' tag-premium';
                        tagIcon = '💎 ';
                    } else if (tag === 'CLEARANCE') {
                        tagClass += ' tag-clearance';
                        tagIcon = '🏷️ ';
                    }
                    // Status tags
                    else if (tag === 'NEW UPLOAD') {
                        tagClass += ' tag-new';
                        tagIcon = '✨ ';
                    } else if (tag === 'TEST UPLOAD') {
                        tagClass += ' tag-test';
                        tagIcon = '🧪 ';
                    } else if (tag === 'LIVE') {
                        tagClass += ' tag-live';
                        tagIcon = '🟢 ';
                    } else if (tag === 'DELETED') {
                        tagClass += ' tag-deleted';
                        tagIcon = '❌ ';
                    }
                    
                    return `<span class="${tagClass}">${tagIcon}${tag.replace('-', ' ')}</span>`;
                }).join('');

                // Check if this item is deleted
                const isDeleted = item.tags && item.tags.includes('DELETED');
                const itemCardClass = isDeleted ? 'item-card deleted-item' : 'item-card';
                const statusIcon = isDeleted ? '❌' : '✅';
                
                // Special handling for deleted items
                const imageDisplay = isDeleted ? 
                    `<div class="deleted-image-placeholder">
                        <div class="deleted-icon">🚫</div>
                        <div class="deleted-text">Image Deleted<br>from Cloudflare</div>
                     </div>` :
                    `<img src="${item.image}" 
                         alt="${item.name}" 
                         class="item-image" 
                         data-item-id="${item.id}"
                         onerror="handleImageError(this, '${item.id}', '${item.name}')"
                         onload="handleImageLoad(this, '${item.id}', '${item.name}')">`;

                html += `
                    <div class="${itemCardClass}">
                        <div class="status-icon">${statusIcon}</div>
                        ${imageDisplay}
                        <div class="item-tags">
                            ${tagHtml}
                            <span class="tag tag-category">${item.category.replace('-', ' ')}</span>
                            <span class="tag tag-size">${item.size}</span>
                        </div>
                        <div class="item-details" style="font-size: 10px; opacity: 0.6;">
                            ${item.name} | ${isDeleted ? 'DELETED FROM CLOUDFLARE' : 'Pricing on Photo'} | ID: ${item.id.substring(0, 8)}...
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Image composition detection functions
        function handleImageError(imgElement, itemId, itemName) {
            // Apply the gradient/emoji error state
            imgElement.style.background = 'linear-gradient(45deg, #D4AF37, #00ff41)';
            imgElement.style.color = '#000';
            imgElement.style.display = 'flex';
            imgElement.style.alignItems = 'center';
            imgElement.style.justifyContent = 'center';
            imgElement.innerHTML = '📸';
            
            logMessage(`⚠️ Image composition error detected for ${itemName} (ID: ${itemId}) - Auto-marking as DELETED`);
            
            // Auto-mark this item as deleted in the database
            markItemAsDeleted(itemId, 'Image load failed - composition shows gradient/emoji pattern');
        }

        function handleImageLoad(imgElement, itemId, itemName) {
            // Check if the image loaded but is actually showing an error state
            // (Sometimes Cloudflare returns a valid response but with placeholder content)
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(imgElement);
                const hasGradientBackground = computedStyle.background.includes('linear-gradient') || 
                                            computedStyle.background.includes('rgb(212, 175, 55)') ||
                                            imgElement.innerHTML.includes('📸');
                
                if (hasGradientBackground || imgElement.innerHTML.includes('📸')) {
                    logMessage(`⚠️ Image composition analysis: ${itemName} shows error pattern despite successful load - Auto-marking as DELETED`);
                    markItemAsDeleted(itemId, 'Image shows error composition pattern (gradient + emoji)');
                } else {
                    console.log(`✅ Image loaded successfully: ${itemName}`);
                }
            }, 100); // Small delay to allow any error handlers to run
        }

        // Auto-mark item as deleted when composition indicates failure
        async function markItemAsDeleted(itemId, reason) {
            try {
                // Find the item in our inventory
                const item = inventory.find(i => i.id === itemId);
                if (!item) {
                    logMessage(`⚠️ Cannot find item ${itemId} in inventory to mark as deleted`);
                    return;
                }

                // Add DELETED tag if not already present
                const updatedTags = [...(item.tags || [])];
                if (!updatedTags.includes('DELETED')) {
                    updatedTags.push('DELETED');
                    
                    // Update the item in our local inventory
                    item.tags = updatedTags;
                    item.imageStatus = 'auto-detected-deleted';
                    item.deleteReason = reason;
                    item.needsUpdate = true;
                    
                    logMessage(`🔄 Auto-marked ${item.name || item.filename} as DELETED: ${reason}`);
                    
                    // Update the database via API
                    const updateResponse = await fetch(`${API_CONFIG.proxyUrl}/items/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...item,
                            tags: updatedTags,
                            imageStatus: 'auto-detected-deleted',
                            deleteReason: reason,
                            updatedAt: new Date().toISOString()
                        })
                    });

                    if (updateResponse.ok) {
                        logMessage(`✅ Successfully updated database for ${item.name || item.filename}`);
                        // Refresh the status display
                        updateStatusDisplay();
                    } else {
                        logMessage(`❌ Failed to update database for ${item.name || item.filename}: ${updateResponse.status}`);
                    }
                }
            } catch (error) {
                logError(`Failed to auto-mark item ${itemId} as deleted`, error);
            }
        }

        function updateStatusDisplay() {
            const availableCount = inventory.filter(item => item.imageStatus === 'available').length;
            const deletedCount = inventory.filter(item => 
                item.imageStatus === 'missing' || item.imageStatus === 'deleted-tagged' || 
                item.imageStatus === 'text-content' || item.imageStatus === 'text-response' ||
                item.imageStatus === 'auto-detected-deleted' || item.imageStatus === 'composition-failed'
            ).length;
            const newDeletedCount = inventory.filter(item => item.needsUpdate && !item.imageStatus.includes('deleted-tagged')).length;
            
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <span>✅ Database: <strong>${inventory.length}</strong> items</span>
                    <span style="color: #4CAF50;">🟢 Live: <strong>${availableCount}</strong></span>
                    <span style="color: #f44336;">🔴 Deleted: <strong>${deletedCount}</strong></span>
                    ${newDeletedCount > 0 ? `<span style="color: #ff9800;">⚠️ <strong>${newDeletedCount}</strong> auto-detected deletions</span>` : ''}
                    ${!showDeleted ? '<span style="color: #666; font-size: 11px;">(Hiding deleted items - click 👁️ to show)</span>' : '<span style="color: #4CAF50; font-size: 11px;">(Showing all items including deleted)</span>'}
                </div>
            `;
        }

        // Initialize
        console.log('SBS Media Hub - Clean Version Ready');
        console.log('Configuration:', CLOUDFLARE_CONFIG);

        // Global variables for upload
        let selectedFiles = [];
        let storedImages = JSON.parse(localStorage.getItem('sbsStoredImages') || '[]');
        let uploadLogs = [];

        // Logging functions
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            uploadLogs.push(logEntry);
            console.log(logEntry);
            updateLogDisplay();
        }

        function logError(message, error) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ERROR: ${message}\n    Details: ${error.message || error}\n    Stack: ${error.stack || 'No stack trace'}`;
            uploadLogs.push(logEntry);
            console.error(logEntry);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                logContent.textContent = uploadLogs.slice(-50).join('\n'); // Show last 50 logs
                logContent.scrollTop = logContent.scrollHeight;
            }
        }

        function toggleLogs() {
            const logViewer = document.getElementById('logViewer');
            if (logViewer.style.display === 'none') {
                logViewer.style.display = 'block';
                updateLogDisplay();
            } else {
                logViewer.style.display = 'none';
            }
        }

        function clearLogs() {
            uploadLogs = [];
            updateLogDisplay();
            logMessage('Logs cleared by user');
        }

        // INSPECTOR FUNCTIONS FOR HELP MODAL
        function refreshSystemStatus() {
            const inspector = document.getElementById('systemStatusInspector');
            if (!inspector) return;

            const status = {
                timestamp: new Date().toLocaleString(),
                inventoryCount: inventory.length,
                availableImages: inventory.filter(item => item.imageStatus === 'available').length,
                deletedImages: inventory.filter(item => item.tags && item.tags.includes('DELETED')).length,
                selectedFiles: selectedFiles.length,
                currentView: currentView,
                currentSection: currentSection,
                showDeleted: showDeleted,
                batchNumber: window.currentBatchNumber || 'None',
                itemNumber: window.currentItemNumber || 0,
                apiConnected: API_CONFIG ? 'Yes' : 'No',
                localStorageSize: JSON.stringify(localStorage).length + ' characters'
            };

            inspector.innerHTML = `
                <div style="color: #00ff41;">📊 System Status at ${status.timestamp}</div>
                <div style="margin: 5px 0; padding: 5px; border-left: 3px solid #00ff41;">
                    Inventory: ${status.inventoryCount} total | ${status.availableImages} live | ${status.deletedImages} deleted<br>
                    View: ${status.currentView} | Section: ${status.currentSection} | Show Deleted: ${status.showDeleted}<br>
                    Upload Session: Batch ${status.batchNumber} | Item #${status.itemNumber}<br>
                    Selected Files: ${status.selectedFiles} | API Connected: ${status.apiConnected}<br>
                    Local Storage Size: ${status.localStorageSize}
                </div>
            `;
        }

        function refreshLocalStorage() {
            const inspector = document.getElementById('localStorageInspector');
            if (!inspector) return;

            let storageHTML = `<div style="color: #ff8800;">💾 Local Storage Contents (${new Date().toLocaleTimeString()})</div><br>`;
            
            if (localStorage.length === 0) {
                storageHTML += '<div style="color: #666;">No items in local storage</div>';
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    let displayValue = value;
                    
                    // Truncate long values and try to parse JSON
                    try {
                        const parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            displayValue = `[Array with ${parsed.length} items]`;
                        } else if (typeof parsed === 'object') {
                            displayValue = `{Object with ${Object.keys(parsed).length} keys}`;
                        }
                    } catch (e) {
                        if (value.length > 100) {
                            displayValue = value.substring(0, 100) + '...';
                        }
                    }
                    
                    storageHTML += `
                        <div style="margin: 8px 0; padding: 5px; border-left: 2px solid #ff8800; background: rgba(255, 136, 0, 0.1);">
                            <strong>${key}:</strong><br>
                            <span style="color: #ccc; word-break: break-all;">${displayValue}</span>
                        </div>
                    `;
                }
            }
            
            inspector.innerHTML = storageHTML;
        }

        function clearAllLocalStorage() {
            if (confirm('Are you sure you want to clear ALL local storage? This will remove all stored data.')) {
                localStorage.clear();
                refreshLocalStorage();
                logMessage('All local storage cleared by user');
                alert('Local storage cleared!');
            }
        }

        function refreshActivityLog() {
            const inspector = document.getElementById('activityLogInspector');
            if (!inspector) return;

            const recentLogs = uploadLogs.slice(-20); // Last 20 log entries
            
            if (recentLogs.length === 0) {
                inspector.innerHTML = '<div style="color: #666;">No activity logged yet</div>';
                return;
            }

            let logHTML = `<div style="color: #8a2be2;">📝 Recent Activity (Last ${recentLogs.length} entries)</div><br>`;
            
            recentLogs.forEach(log => {
                const isError = log.includes('ERROR');
                const isWarning = log.includes('⚠️');
                const color = isError ? '#ff4444' : isWarning ? '#ff8800' : '#8a2be2';
                
                logHTML += `
                    <div style="margin: 3px 0; padding: 3px; border-left: 2px solid ${color}; color: ${color};">
                        ${log}
                    </div>
                `;
            });
            
            inspector.innerHTML = logHTML;
            inspector.scrollTop = inspector.scrollHeight;
        }

        function downloadLogs() {
            const blob = new Blob([uploadLogs.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sbs-media-hub-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logMessage('Logs downloaded by user');
        }

        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('databaseTestResult');
            if (!resultDiv) return;

            resultDiv.innerHTML = '<div style="color: #D4AF37;">🧪 Testing database connection...</div>';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_CONFIG.proxyUrl}/test`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div style="color: #00ff41;">✅ Database Connection Successful</div>
                        <div style="margin: 5px 0; color: #D4AF37;">
                            Response Time: ${responseTime}ms<br>
                            Status: ${response.status} ${response.statusText}<br>
                            Server: ${data.server || 'Unknown'}<br>
                            Timestamp: ${new Date().toLocaleString()}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: #ff4444;">❌ Database Connection Failed</div>
                        <div style="margin: 5px 0; color: #ff8800;">
                            Status: ${response.status} ${response.statusText}<br>
                            Response Time: ${responseTime}ms<br>
                            Error: Connection failed
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4444;">❌ Database Connection Error</div>
                    <div style="margin: 5px 0; color: #ff8800;">
                        Error: ${error.message}<br>
                        Details: Cannot reach API server<br>
                        Check if START-API-PROXY.bat is running
                    </div>
                `;
            }
        }

        async function viewDatabaseStats() {
            const resultDiv = document.getElementById('databaseTestResult');
            if (!resultDiv) return;

            resultDiv.innerHTML = '<div style="color: #D4AF37;">📊 Loading database statistics...</div>';
            
            try {
                const response = await fetch(`${API_CONFIG.proxyUrl}/items/stats`);
                
                if (response.ok) {
                    const stats = await response.json();
                    resultDiv.innerHTML = `
                        <div style="color: #00ff41;">📊 Database Statistics</div>
                        <div style="margin: 5px 0; color: #D4AF37;">
                            Total Items: ${stats.total || inventory.length}<br>
                            Available: ${stats.available || inventory.filter(i => i.imageStatus === 'available').length}<br>
                            Deleted: ${stats.deleted || inventory.filter(i => i.tags?.includes('DELETED')).length}<br>
                            Categories: ${stats.categories || 'Unknown'}<br>
                            Last Updated: ${stats.lastUpdated || 'Unknown'}
                        </div>
                    `;
                } else {
                    // Fallback to local stats
                    const localStats = {
                        total: inventory.length,
                        available: inventory.filter(item => item.imageStatus === 'available').length,
                        deleted: inventory.filter(item => item.tags && item.tags.includes('DELETED')).length,
                        categories: [...new Set(inventory.map(item => item.category))].length
                    };
                    
                    resultDiv.innerHTML = `
                        <div style="color: #ff8800;">📊 Local Statistics (Database Unavailable)</div>
                        <div style="margin: 5px 0; color: #D4AF37;">
                            Local Inventory: ${localStats.total} items<br>
                            Available: ${localStats.available}<br>
                            Deleted: ${localStats.deleted}<br>
                            Categories: ${localStats.categories}<br>
                            Note: Using local data only
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4444;">❌ Cannot Load Statistics</div>
                    <div style="margin: 5px 0; color: #ff8800;">
                        Error: ${error.message}<br>
                        Check API server connection
                    </div>
                `;
            }
        }

        // End of inspector functions

        // Global state for sections
        let currentSection = 'all';

        // Section filtering functions
        // Combined function to load images and show section
        async function loadImagesAndShowSection(section) {
            // Load items from our local DB now
            await loadItems();
            
            // Then show the specified section
            showSection(section);
        }

        // Filter by tag using dropdown
        function filterByTag() {
            const tagFilter = document.getElementById('tagFilter');
            const selectedTag = tagFilter.value;
            
            if (selectedTag === 'all') {
                showSection('all');
            } else if (selectedTag === 'deleted') {
                showSection('deleted');
                // Automatically show deleted items when filtering for them
                if (!showDeleted) {
                    toggleShowDeleted();
                }
            } else {
                showSection(selectedTag);
            }
        }

        // Toggle showing deleted items
        function toggleShowDeleted() {
            showDeleted = !showDeleted;
            const toggleBtn = document.getElementById('toggleDeletedBtn');
            
            // Count deleted items
            const deletedCount = inventory.filter(item => 
                item.tags && item.tags.includes('DELETED')
            ).length;
            
            if (showDeleted) {
                toggleBtn.textContent = `👁️ Hide Deleted (Showing ${deletedCount})`;
                toggleBtn.style.background = '#ff4444';
                toggleBtn.style.color = '#fff';
            } else {
                toggleBtn.textContent = `👁️ Show Deleted (Hidden ${deletedCount})`;
                toggleBtn.style.background = '#666';
                toggleBtn.style.color = '#fff';
            }
            
            // Refresh display
            displayInventory();
            logMessage(`Deleted items are now ${showDeleted ? 'shown' : 'hidden'} - ${deletedCount} deleted items in database`);
        }

        function showSection(section) {
            currentSection = section;
            
            // Update button states
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                if (btn.id.includes('all') || btn.id.includes('featured') || btn.id.includes('sale')) {
                    btn.classList.remove('active');
                }
            });
            document.getElementById(section + 'Btn').classList.add('active');
            
            // Filter and display inventory
            displayInventory();
            
            logMessage(`Switched to section: ${section.toUpperCase()}`);
        }

        // Filter inventory based on current section
        function getFilteredInventory() {
            let filtered = inventory;
            
            // First filter by showDeleted preference
            if (!showDeleted) {
                filtered = filtered.filter(item => !(item.tags && item.tags.includes('DELETED')));
            }
            
            // Then filter by section
            if (currentSection === 'all') {
                return filtered;
            }
            
            return filtered.filter(item => {
                if (currentSection === 'featured') {
                    return item.tags && item.tags.some(tag => tag === 'FEATURED');
                } else if (currentSection === 'sale') {
                    return item.tags && item.tags.some(tag => tag === 'SALE');
                } else if (currentSection === 'deleted') {
                    return item.tags && item.tags.includes('DELETED');
                }
                return true;
            });
        }

        // Show/Hide Upload Functions
        function showUpload() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
        }

        function hideUpload() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            selectedFiles = [];
            // Reset drop zone text
            const dropZoneText = document.querySelector('.drop-zone-text');
            if (dropZoneText) {
                dropZoneText.textContent = '📸 Tap to Select Photos';
            }
        }

        // File Selection Handler
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const allFiles = Array.from(e.target.files);
                    
                    // Filter to only JPEG files
                    const jpegFiles = allFiles.filter(file => {
                        const isJpeg = file.type === 'image/jpeg' || 
                                      file.name.toLowerCase().endsWith('.jpg') || 
                                      file.name.toLowerCase().endsWith('.jpeg');
                        return isJpeg;
                    });
                    
                    const rejectedCount = allFiles.length - jpegFiles.length;
                    selectedFiles = jpegFiles;
                    
                    if (selectedFiles.length > 0) {
                        let message = `📸 ${selectedFiles.length} JPEG file(s) selected`;
                        if (rejectedCount > 0) {
                            message += ` (${rejectedCount} non-JPEG files rejected)`;
                        }
                        document.querySelector('.drop-zone-text').textContent = message;
                        logMessage(`Selected ${selectedFiles.length} JPEG files for upload${rejectedCount > 0 ? `, rejected ${rejectedCount} non-JPEG files` : ''}`);
                    } else if (allFiles.length > 0) {
                        document.querySelector('.drop-zone-text').textContent = '❌ Only JPEG files allowed';
                        logError('No JPEG files selected', new Error(`${allFiles.length} non-JPEG files were selected`));
                    }
                });
            }

            // Category change handler to update size options
            const categorySelect = document.getElementById('category');
            const sizeSelect = document.getElementById('size');
            
            if (categorySelect && sizeSelect) {
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    updateSizeOptions(category);
                });
            }
        });

        // Update size options based on category
        function updateSizeOptions(category) {
            const sizeSelect = document.getElementById('size');
            sizeSelect.innerHTML = '';

            if (!category) {
                sizeSelect.innerHTML = '<option value="">Select Category First</option>';
                return;
            }

            sizeSelect.innerHTML = '<option value="">Select Size</option>';

            if (category === 'BN-CLOTHES') {
                // Brand New Clothing sizes
                const clothingSizes = [
                    { value: 'XS', text: 'XS' },
                    { value: 'S', text: 'S' },
                    { value: 'M', text: 'M' },
                    { value: 'L', text: 'L' },
                    { value: 'XL', text: 'XL' }
                ];

                clothingSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });

            } else if (category === 'PO-CLOTHES') {
                // Pre-Owned Clothing sizes (includes adjacent mixed top/bottom combinations)
                const poClothingSizes = [
                    { value: 'XS', text: 'XS' },
                    { value: 'S', text: 'S' },
                    { value: 'M', text: 'M' },
                    { value: 'L', text: 'L' },
                    { value: 'XL', text: 'XL' },
                    // Mixed size combinations - Only one size up/down
                    { value: 'XS-TOP-S-BOTTOM', text: 'XS Top S Bottom' },
                    { value: 'S-TOP-XS-BOTTOM', text: 'S Top XS Bottom' },
                    { value: 'S-TOP-M-BOTTOM', text: 'S Top M Bottom' },
                    { value: 'M-TOP-S-BOTTOM', text: 'M Top S Bottom' },
                    { value: 'M-TOP-L-BOTTOM', text: 'M Top L Bottom' },
                    { value: 'L-TOP-M-BOTTOM', text: 'L Top M Bottom' },
                    { value: 'L-TOP-XL-BOTTOM', text: 'L Top XL Bottom' },
                    { value: 'XL-TOP-L-BOTTOM', text: 'XL Top L Bottom' }
                ];

                poClothingSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });

            } else if (category === 'BN-SHOES' || category === 'PO-SHOES') {
                // Shoe sizes (including half sizes for both Brand New and Pre-Owned)
                const shoeSizes = [
                    { value: 'UK-6', text: 'UK 6' },
                    { value: 'UK-6-5', text: 'UK 6.5' },
                    { value: 'UK-7', text: 'UK 7' },
                    { value: 'UK-7-5', text: 'UK 7.5' },
                    { value: 'UK-8', text: 'UK 8' },
                    { value: 'UK-8-5', text: 'UK 8.5' },
                    { value: 'UK-9', text: 'UK 9' },
                    { value: 'UK-9-5', text: 'UK 9.5' },
                    { value: 'UK-10', text: 'UK 10' },
                    { value: 'UK-10-5', text: 'UK 10.5' },
                    { value: 'UK-11', text: 'UK 11' },
                    { value: 'UK-11-5', text: 'UK 11.5' },
                    { value: 'UK-12', text: 'UK 12' }
                ];

                shoeSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });
            }
        }

        // Smart Filename Generation System
        let selectedFilenameFormat = 'auto-timestamp';

        function setFilenameFormat(format) {
            selectedFilenameFormat = format;
            
            // Update button styles
            const buttons = ['btnAutoTimestamp', 'btnCategoryFirst', 'btnClean', 'btnSimple'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.style.background = 'rgba(138, 43, 226, 0.5)';
            });
            
            // Highlight selected button
            const buttonMap = {
                'auto-timestamp': 'btnAutoTimestamp',
                'category-first': 'btnCategoryFirst', 
                'clean': 'btnClean',
                'simple': 'btnSimple'
            };
            
            const selectedBtn = document.getElementById(buttonMap[format]);
            if (selectedBtn) selectedBtn.style.background = '#8a2be2';
            
            // Update preview
            updateFilenamePreview();
        }

        function updateFilenamePreview() {
            const category = document.getElementById('category').value;
            const size = document.getElementById('size').value;
            const description = document.getElementById('itemDescription').value.trim();
            const preview = document.getElementById('filenamePreview');
            const breakdown = document.getElementById('filenameBreakdown');
            const breakdownContent = document.getElementById('breakdownContent');
            
            if (!category || !size) {
                preview.textContent = 'Select category and size to see preview';
                breakdown.style.display = 'none';
                return;
            }
            
            const generatedName = generateSmartFilename(category, size, description, selectedFilenameFormat);
            const sampleFilename = generatedName.replace('##ITEM##', '001'); // Show with sample item number
            preview.textContent = sampleFilename;
            
            // Generate breakdown
            const now = new Date();
            const dateStr = now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                           String(now.getMinutes()).padStart(2, '0');
            const batchSample = `${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${timeStr}`;
            
            let breakdownHTML = '';
            
            if (description) {
                const cleanDesc = description.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toUpperCase();
                breakdownHTML += `<span style="color: #ff6b6b;">📝 DESC-${cleanDesc}</span> = Custom Description<br>`;
            }
            breakdownHTML += `<span style="color: #4ecdc4;">🏷️ CAT-${category}</span> = Category & Condition<br>`;
            breakdownHTML += `<span style="color: #45b7d1;">📏 SIZE-${size}</span> = Size Information<br>`;
            breakdownHTML += `<span style="color: #96ceb4;">📅 DATE-${dateStr}</span> = Date (Today)<br>`;
            if (selectedFilenameFormat === 'auto-timestamp' && !description) {
                breakdownHTML += `<span style="color: #a8e6cf;">⏰ TIME-${timeStr}</span> = Time (Current)<br>`;
            }
            breakdownHTML += `<span style="color: #feca57;">📦 BATCH-B${batchSample}</span> = Batch ID (Auto-Generated)<br>`;
            breakdownHTML += `<span style="color: #ff9ff3;">🔢 ITEM-001</span> = Sequential Item Number<br>`;
            breakdownHTML += `<span style="color: #a8a8a8;">📄 .jpeg</span> = File Extension`;
            
            breakdownContent.innerHTML = breakdownHTML;
            breakdown.style.display = 'block';
        }

        function generateSmartFilename(category, size, description, format) {
            const now = new Date();
            const dateStr = now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                           String(now.getMinutes()).padStart(2, '0');
            
            // Clean description if provided
            const cleanDescription = description ? description.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toUpperCase() : '';
            const cleanSize = size.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-');
            
            // Get batch number from global state or generate new one
            const batchNum = window.currentBatchNumber || generateBatchNumber();
            
            let filename = '';
            
            switch (format) {
                case 'auto-timestamp':
                    // Default with key markers: DESC-CAT-SIZE-DATE-TIME-BATCH-ITEM
                    if (cleanDescription) {
                        filename = `DESC-${cleanDescription}-CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'category-first':
                    // Category first with markers: CAT-SIZE-DESC-DATE-BATCH-ITEM
                    if (cleanDescription) {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DESC-${cleanDescription}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'clean':
                    // Clean underscores format with markers
                    if (cleanDescription) {
                        filename = `SBS_DESC_${cleanDescription.replace('-', '_')}_CAT_${category.replace('-', '_')}_SIZE_${cleanSize.replace('-', '_')}_DATE_${dateStr}_BATCH_B${batchNum}_ITEM_##ITEM##.jpeg`;
                    } else {
                        filename = `SBS_CAT_${category.replace('-', '_')}_SIZE_${cleanSize.replace('-', '_')}_DATE_${dateStr}_TIME_${timeStr}_BATCH_B${batchNum}_ITEM_##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'simple':
                    // Simple format with basic markers
                    filename = `SBS-BATCH-B${batchNum}-ITEM-##ITEM##-DATE-${dateStr}-TIME-${timeStr}.jpeg`;
                    break;
                    
                default:
                    filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
            }
            
            return filename;
        }

        // Generate unique batch number based on timestamp
        function generateBatchNumber() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            
            // Format: MMDDHHMM (e.g., 09251430 for Sept 25, 2:30 PM)
            const batchNumber = `${month}${day}${hour}${minute}`;
            
            // Store globally for this upload session
            window.currentBatchNumber = batchNumber;
            
            return batchNumber;
        }

        // Reset batch number for new upload session
        function startNewUploadBatch() {
            window.currentBatchNumber = generateBatchNumber();
            window.currentItemNumber = 0; // Reset item counter
            logMessage(`🎯 Started new upload batch: B${window.currentBatchNumber}`);
        }

        // Add event listeners to update preview when inputs change
        function setupFilenamePreviewListeners() {
            const inputs = ['category', 'size', 'itemDescription'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('change', updateFilenamePreview);
                    element.addEventListener('input', updateFilenamePreview);
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupFilenamePreviewListeners();
            setFilenameFormat('auto-timestamp'); // Set default format
        });

        // Complete Upload Process
        async function processUpload() {
            const category = document.getElementById('category').value;
            const size = document.getElementById('size').value;
            const siteSection = document.getElementById('siteSection').value;
            const additionalTag = document.getElementById('additionalTag').value;

            if (selectedFiles.length === 0) {
                logError('No files selected', new Error('Please select files first'));
                alert('❌ Please select files first');
                return;
            }

            if (!category || !size) {
                logError('Missing category or size', new Error(`Category: ${category}, Size: ${size}`));
                alert('❌ Please select Category & Size');
                return;
            }

            logMessage(`=== STARTING UPLOAD BATCH ===`);
            
            // Start new batch with unique batch number
            startNewUploadBatch();
            
            logMessage(`📦 Batch Number: B${window.currentBatchNumber}`);
            logMessage(`📁 Files to upload: ${selectedFiles.length}`);
            logMessage(`🏷️ Category: ${category}, Size: ${size}`);
            logMessage(`🎯 Site Section: ${siteSection}${additionalTag ? `, Additional Tag: ${additionalTag}` : ''}`);

            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            progressText.textContent = `Starting batch B${window.currentBatchNumber} - ${selectedFiles.length} files...`;

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const progress = ((i + 1) / selectedFiles.length) * 100;
                const itemNum = String(i + 1).padStart(3, '0');
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `Batch B${window.currentBatchNumber} - Item ${itemNum}: ${file.name}`;

                logMessage(`--- Batch B${window.currentBatchNumber} - Processing Item ${itemNum}/${selectedFiles.length}: ${file.name} ---`);

                try {
                    // Step 1: Upload image to Cloudflare via our proxy
                    const uploadResult = await uploadToCloudflare(file, category, size);
                    
                    if (uploadResult.success) {
                        logMessage(`✅ Cloudflare upload successful. Image ID: ${uploadResult.id}`, 'success');

                        // Step 2: Create the item record in our local database
                        const newItem = await createItemInDB(uploadResult, category, size, siteSection, additionalTag);
                        
                        logMessage(`✅ Item record created in local DB. Item ID: ${newItem.id}`, 'success');
                        inventory.unshift(newItem); // Add to the top of the local array
                        successCount++;
                        
                    } else {
                        throw new Error(uploadResult.error || 'Cloudflare upload failed but did not throw an error.');
                    }

                } catch (error) {
                    failCount++;
                    logError(`❌ Upload process failed for ${file.name}`, error);
                    progressText.textContent = `❌ Error: ${error.message}`;
                    // Wait a moment before continuing
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            logMessage(`=== BATCH B${window.currentBatchNumber} COMPLETED ===`);
            logMessage(`📦 Batch: B${window.currentBatchNumber}`);
            logMessage(`📊 Total files: ${selectedFiles.length}, Successful: ${successCount}, Failed: ${failCount}`);
            logMessage(`🎯 All items in this batch have sequential numbering 001-${String(selectedFiles.length).padStart(3, '0')}`);

            progressText.textContent = `✅ Batch B${window.currentBatchNumber} Complete! ${successCount} successful, ${failCount} failed`;
            displayInventory(); // Refresh the display with the new item

            // Keep upload section open - just hide progress after delay
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
            }, 5000);
        }

        // Function to update item tags in the database
        async function updateItemTags(itemId, newTags) {
            const response = await fetch(`${API_CONFIG.proxyUrl}/items/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: newTags })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to update item tags: ${errorText}`);
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(`API Error on tag update: ${result.error}`);
            }
            
            return result.item;
        }

        // New function to create item record in our database
        async function createItemInDB(uploadResult, category, size, siteSection, additionalTag) {
            logMessage(`Creating database entry for ${uploadResult.filename}...`);

            const tags = ['LIVE', siteSection.toUpperCase()];
            if (additionalTag) {
                tags.push(additionalTag.toUpperCase());
            }

            const itemPayload = {
                cloudflareId: uploadResult.id,
                filename: uploadResult.filename,
                name: uploadResult.filename, // Use filename as name for now
                category: category,
                size: size,
                tags: tags,
                status: 'available', // Default status
                notes: ''
            };

            const response = await fetch(`${API_CONFIG.proxyUrl}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemPayload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to create item in DB: ${errorText}`);
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(`API Error on item creation: ${result.error}`);
            }
            
            // Return the complete item object from the server (includes id, createdAt, etc.)
            return {
                ...result.item,
                image: `https://imagedelivery.net/${API_CONFIG.accountHash}/${result.item.cloudflareId}/w=1080,h=1920`
            };
        }


        // Upload to Cloudflare Function (now only handles the upload itself)
        async function uploadToCloudflare(file, category, size) {
            logMessage(`Starting Cloudflare upload for: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            // Get optional description
            const description = document.getElementById('itemDescription').value.trim();
            
            // Increment item number for this upload session
            window.currentItemNumber = (window.currentItemNumber || 0) + 1;
            const itemNum = String(window.currentItemNumber).padStart(3, '0');
            
            // Generate smart filename template
            let filenameTemplate = generateSmartFilename(category, size, description, selectedFilenameFormat);
            
            // Replace placeholder with actual item number
            const filename = filenameTemplate.replace('##ITEM##', itemNum);
            
            const batchNum = window.currentBatchNumber || 'NOBATCH';
            
            logMessage(`📦 Batch: B${batchNum}, Item: ${itemNum}/${selectedFiles.length}`);
            logMessage(`🏷️ Generated smart filename: ${filename}`);
            if (description) {
                logMessage(`📝 Custom description: "${description}"`);
            }
            
            // Create new file object with custom filename
            const customFile = new File([file], filename, {
                type: file.type,
                lastModified: file.lastModified
            });
            
            const formData = new FormData();
            formData.append('file', customFile, filename); // Explicitly set filename
            
            const metadata = {
                filename: filename,
                alt: `SBS ${category.replace('-', ' ')} Size ${size}${description ? ` - ${description}` : ''} (Batch ${batchNum} Item ${itemNum})`,
                caption: `${category.replace('-', ' ')} Size ${size}${description ? ` - ${description}` : ''} - Batch ${batchNum} Item ${itemNum} - Auto-uploaded via SBS Media Hub`
            };
            formData.append('metadata', JSON.stringify(metadata));
            logMessage(`📊 Enhanced metadata with smart naming: ${JSON.stringify(metadata)}`);

            const apiUrl = `${API_CONFIG.proxyUrl}/images`;
            logMessage(`🔄 Proxying upload with custom filename to: ${apiUrl}`);

            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData
            });

            logMessage(`📡 Proxy response status: ${response.status} ${response.statusText}`);

            if (!response.ok) {
                const errorText = await response.text();
                logError(`API Error Response (${response.status})`, new Error(errorText));
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            logMessage(`Cloudflare API Success Response: ${JSON.stringify(result, null, 2)}`);
            
            if (!result.success) {
                const errorMsg = result.errors?.[0]?.message || JSON.stringify(result.errors) || 'Unknown error';
                logError('Cloudflare API returned success=false', new Error(errorMsg));
                throw new Error(`Cloudflare API error: ${errorMsg}`);
            }

            return {
                id: result.result.id,
                filename: filename,
                success: true
            };
        }

        // Remove loadStoredImages and related logic, as we now fetch from the DB
        document.addEventListener('DOMContentLoaded', function() {
            // The old loadStoredImages() call is no longer needed.
            // We will call loadImagesAndShowSection() via the button click.
            logMessage("Frontend initialized. Ready to connect to API server.");
        });
    </script>
</body>
</html>