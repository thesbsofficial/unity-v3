<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ SBS Unity System Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #1a1a1a;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 10px 20px;
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: #444;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .header-content {
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .header p {
            color: #999;
            font-size: 1.1rem;
        }

        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #3b82f6;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid #666;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .test-item.running {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .test-item.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .test-item.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .test-item.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .test-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status {
            font-size: 1.5rem;
        }

        .test-details {
            color: #999;
            font-size: 0.9rem;
            margin-top: 8px;
            padding-left: 35px;
        }

        .test-details code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            color: #3b82f6;
            font-family: 'Courier New', monospace;
        }

        .button {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .button:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: transparent;
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .button-secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .summary-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-card.success .number { color: #10b981; }
        .summary-card.error .number { color: #ef4444; }
        .summary-card.warning .number { color: #f59e0b; }
        .summary-card.info .number { color: #3b82f6; }

        .summary-card .label {
            color: #999;
            font-size: 0.9rem;
        }

        .json-viewer {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            color: #0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/admin/" class="back-button">
                ‚Üê Back to Dashboard
            </a>
            <div class="header-content">
                <h1>üî¨ SBS Unity System Test</h1>
                <p>Comprehensive diagnostics for all services, APIs, and integrations</p>
            </div>
        </div>

        <div class="summary" id="summary">
            <div class="summary-card info">
                <div class="number" id="totalTests">0</div>
                <div class="label">Total Tests</div>
            </div>
            <div class="summary-card success">
                <div class="number" id="passedTests">0</div>
                <div class="label">‚úÖ Passed</div>
            </div>
            <div class="summary-card error">
                <div class="number" id="failedTests">0</div>
                <div class="label">‚ùå Failed</div>
            </div>
            <div class="summary-card warning">
                <div class="number" id="warningTests">0</div>
                <div class="label">‚ö†Ô∏è Warnings</div>
            </div>
        </div>

        <div class="controls">
            <button class="button" onclick="runAllTests()" id="runAllBtn">
                üöÄ Run All Tests
            </button>
            <button class="button button-secondary" onclick="runSection('auth')">
                üîê Test Auth
            </button>
            <button class="button button-secondary" onclick="runSection('api')">
                üîå Test APIs
            </button>
            <button class="button button-secondary" onclick="runSection('images')">
                üñºÔ∏è Test Images
            </button>
            <button class="button button-secondary" onclick="runSection('pages')">
                üìÑ Test Pages
            </button>
            <button class="button button-secondary" onclick="runSection('redirects')">
                üîÄ Test Redirects
            </button>
            <button class="button button-secondary" onclick="runSection('errors')">
                üö® Test Errors
            </button>
            <button class="button button-secondary" onclick="runSection('critical')">
                ‚ö° Test Critical
            </button>
            <button class="button button-secondary" onclick="clearResults()">
                üóëÔ∏è Clear
            </button>
        </div>

        <!-- Authentication Tests -->
        <div class="test-section">
            <h2>üîê Authentication & Session</h2>
            <div id="auth-tests"></div>
        </div>

        <!-- API Tests -->
        <div class="test-section">
            <h2>üîå API Endpoints</h2>
            <div id="api-tests"></div>
        </div>

        <!-- Cloudflare Images Tests -->
        <div class="test-section">
            <h2>üñºÔ∏è Cloudflare Images</h2>
            <div id="images-tests"></div>
        </div>

        <!-- Page Navigation Tests -->
        <div class="test-section">
            <h2>üìÑ Page Navigation</h2>
            <div id="pages-tests"></div>
        </div>

        <!-- Admin Features Tests -->
        <div class="test-section">
            <h2>‚öôÔ∏è Admin Features</h2>
            <div id="admin-tests"></div>
        </div>

        <!-- Redirects & Routing Tests -->
        <div class="test-section">
            <h2>üîÄ Redirects & Routing</h2>
            <div id="redirects-tests"></div>
        </div>

        <!-- Error Handling Tests -->
        <div class="test-section">
            <h2>üö® Error Handling</h2>
            <div id="errors-tests"></div>
        </div>

        <!-- Critical Functionality Tests -->
        <div class="test-section">
            <h2>‚ö° Critical Functions</h2>
            <div id="critical-tests"></div>
        </div>

        <!-- Email Verification Tests -->
        <div class="test-section">
            <h2>üìß Email Verification System</h2>
            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #FFD700; margin-bottom: 10px;">üß™ Test Email Sending</h3>
                <p style="color: #ccc; margin-bottom: 15px;">Send a test verification email to any address</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input 
                        type="email" 
                        id="testEmailInput" 
                        placeholder="Enter email address to test"
                        style="flex: 1; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px;"
                    />
                    <button 
                        id="sendTestEmailBtn" 
                        onclick="sendTestEmail()"
                        style="background: #FFD700; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                        onmouseover="this.style.background='#FFC700'"
                        onmouseout="this.style.background='#FFD700'"
                    >
                        üìß Send Test Email
                    </button>
                </div>
                <div id="emailTestResult" style="margin-top: 10px;"></div>
            </div>
            <div id="email-tests"></div>
        </div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        // Test definitions
        const tests = {
            auth: [
                {
                    name: 'Check User Session',
                    description: 'Verify user is authenticated',
                    test: async () => {
                        const res = await fetch('/api/users/me', { credentials: 'include' });
                        const data = await res.json();
                        if (!res.ok) throw new Error('Not authenticated');
                        return { success: true, data: { email: data.user?.email, role: data.user?.role, is_admin: data.is_admin } };
                    }
                },
                {
                    name: 'Check Admin Access',
                    description: 'Verify admin privileges',
                    test: async () => {
                        const res = await fetch('/api/users/me', { credentials: 'include' });
                        const data = await res.json();
                        if (!data.is_admin) throw new Error('Admin access required');
                        return { success: true, data: { is_admin: data.is_admin, is_allowlisted: data.user?.is_allowlisted } };
                    }
                }
            ],
            api: [
                {
                    name: 'Health Check',
                    description: 'Test /api/health endpoint',
                    test: async () => {
                        const res = await fetch('/api/health');
                        const data = await res.json();
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        return { success: true, data };
                    }
                },
                {
                    name: 'Products API',
                    description: 'Test /api/products endpoint (CF Images)',
                    test: async () => {
                        const res = await fetch('/api/products');
                        const data = await res.json();
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        if (!data.success) throw new Error(data.error || 'API returned success: false');
                        return { success: true, data: { total: data.total, products: data.products?.length || 0 } };
                    }
                }
            ],
            images: [
                {
                    name: 'CF Images API Connection',
                    description: 'Verify Cloudflare Images is accessible',
                    test: async () => {
                        const res = await fetch('/api/products');
                        const data = await res.json();
                        if (!res.ok || !data.success) throw new Error('CF Images API failed');
                        if (!data.products || data.products.length === 0) {
                            return { success: true, warning: 'No images found in CF Images', data: { total: 0 } };
                        }
                        return { success: true, data: { total: data.products.length, source: data.source } };
                    }
                },
                {
                    name: 'Image Delivery Test',
                    description: 'Test if images can be loaded',
                    test: async () => {
                        const res = await fetch('/api/products');
                        const data = await res.json();
                        if (!data.products || data.products.length === 0) {
                            throw new Error('No images to test');
                        }
                        const testImage = data.products[0];
                        const imgRes = await fetch(testImage.image);
                        if (!imgRes.ok) throw new Error('Image delivery failed');
                        return { success: true, data: { testImage: testImage.image, status: imgRes.status } };
                    }
                }
            ],
            pages: [
                {
                    name: 'Shop Page',
                    description: 'Check /shop.html loads',
                    test: async () => {
                        const res = await fetch('/shop.html');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        return { success: true, data: { url: '/shop.html', status: res.status } };
                    }
                },
                {
                    name: 'Admin Panel',
                    description: 'Check /admin/ loads',
                    test: async () => {
                        const res = await fetch('/admin/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        return { success: true, data: { url: '/admin/', status: res.status } };
                    }
                },
                {
                    name: 'Admin Inventory',
                    description: 'Check /admin/inventory/ loads',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        return { success: true, data: { url: '/admin/inventory/', status: res.status } };
                    }
                },
                {
                    name: 'Admin Overview',
                    description: 'Check /admin/overview.html loads',
                    test: async () => {
                        const res = await fetch('/admin/overview.html');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        return { success: true, data: { url: '/admin/overview.html', status: res.status } };
                    }
                }
            ],
            admin: [
                {
                    name: 'Upload Endpoint',
                    description: 'Check /api/admin/upload-image endpoint exists',
                    test: async () => {
                        // Just check if endpoint responds (OPTIONS request)
                        const res = await fetch('/api/admin/upload-image', { 
                            method: 'OPTIONS',
                            credentials: 'include'
                        });
                        if (res.status === 405) {
                            return { success: true, data: { note: 'Endpoint exists (POST required)' } };
                        }
                        return { success: true, data: { status: res.status } };
                    }
                },
                {
                    name: 'Upload Validation',
                    description: 'Test upload endpoint requires file',
                    test: async () => {
                        const formData = new FormData();
                        formData.append('filename', 'test.jpg');
                        // Intentionally missing file
                        
                        const res = await fetch('/api/admin/upload-image', {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });
                        
                        const data = await res.json();
                        if (res.status === 400 && data.error && data.error.includes('file')) {
                            return { success: true, data: { message: 'Correctly rejects missing file', status: res.status } };
                        }
                        throw new Error('Upload should require file parameter');
                    }
                },
                {
                    name: 'Delete Endpoint',
                    description: 'Check /api/admin/delete-image endpoint exists',
                    test: async () => {
                        const res = await fetch('/api/admin/delete-image', {
                            method: 'DELETE',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ imageId: 'test-nonexistent' })
                        });
                        
                        // Should respond (even if image doesn't exist, endpoint works)
                        if (res.status === 404 || res.status === 400 || res.status === 200) {
                            return { success: true, data: { status: res.status, note: 'Endpoint responding' } };
                        }
                        return { success: true, data: { status: res.status } };
                    }
                },
                {
                    name: 'Delete Validation',
                    description: 'Test delete endpoint requires image ID',
                    test: async () => {
                        const res = await fetch('/api/admin/delete-image', {
                            method: 'DELETE',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({}) // Missing imageId
                        });
                        
                        const data = await res.json();
                        if (res.status === 400 && data.error) {
                            return { success: true, data: { message: 'Correctly rejects missing ID', status: res.status } };
                        }
                        throw new Error('Delete should require imageId parameter');
                    }
                },
                {
                    name: 'Inventory Manager Loads',
                    description: 'Test inventory manager page with delete buttons',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        
                        // Check for delete functionality
                        const hasDeleteBtn = html.includes('deleteImage') || html.includes('Delete');
                        const hasBulkDelete = html.includes('bulkDelete') || html.includes('Delete Selected');
                        
                        return { success: true, data: { 
                            status: res.status, 
                            hasDeleteButton: hasDeleteBtn,
                            hasBulkDelete: hasBulkDelete
                        }};
                    }
                },
                {
                    name: 'Upload Form Has Required Fields',
                    description: 'Test that category and size are required for upload',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        
                        // Check for required field indicators
                        const hasCategoryField = html.includes('uploadCategory');
                        const hasSizeField = html.includes('uploadSize');
                        const hasRequiredMarker = html.includes('REQUIRED') || html.includes('required');
                        const hasValidation = html.includes('if (!category') || html.includes('if (!size');
                        
                        if (!hasCategoryField || !hasSizeField) {
                            throw new Error('Missing category or size fields');
                        }
                        
                        return { success: true, data: { 
                            hasCategoryField,
                            hasSizeField,
                            hasRequiredMarker,
                            hasValidation
                        }};
                    }
                },
                {
                    name: 'Smart Filename Generator',
                    description: 'Test that smart filename generator exists and requires fields',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        
                        // Check for smart filename functionality
                        const hasSmartNaming = html.includes('Smart Naming') || html.includes('generateSmartFilename');
                        const hasPreview = html.includes('uploadFilenamePreview');
                        const hasCategoryOptions = html.includes('BN-CLOTHES') && html.includes('PO-SHOES');
                        const hasSizeOptions = html.includes('UK-') || html.includes('XS') || html.includes('XL');
                        
                        if (!hasSmartNaming) {
                            throw new Error('Smart filename generator not found');
                        }
                        
                        return { success: true, data: { 
                            hasSmartNaming,
                            hasPreview,
                            hasCategoryOptions,
                            hasSizeOptions
                        }};
                    }
                },
                {
                    name: 'Upload Requires Category/Size Before Processing',
                    description: 'Test that drag-and-drop waits for category/size selection',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        
                        // Check that handleFiles receives category/size parameters
                        const handleFilesHasParams = html.includes('handleFiles(files, category, size');
                        const processUploadValidates = html.includes('if (!category') && html.includes('if (!size');
                        const hasProcessUploadButton = html.includes('processUpload');
                        
                        if (!handleFilesHasParams) {
                            throw new Error('handleFiles should require category/size parameters');
                        }
                        
                        return { success: true, data: { 
                            handleFilesHasParams,
                            processUploadValidates,
                            hasProcessUploadButton,
                            message: 'Files wait for category/size before upload'
                        }};
                    }
                }
            ],
            redirects: [
                {
                    name: 'Admin Panel Redirect',
                    description: 'Test /admin without trailing slash redirects to /admin/',
                    test: async () => {
                        const res = await fetch('/admin', { redirect: 'manual' });
                        if (res.type === 'opaqueredirect' || res.status === 301 || res.status === 302 || res.status === 307 || res.status === 308) {
                            return { success: true, data: { status: res.status, redirect: true } };
                        }
                        // If it loads directly without redirect, that's also OK
                        if (res.status === 200) {
                            return { success: true, data: { status: 200, note: 'Loads directly (no redirect needed)' } };
                        }
                        throw new Error(`Unexpected status: ${res.status}`);
                    }
                },
                {
                    name: 'Login Redirect for Unauth',
                    description: 'Test that unauthorized API access returns proper error',
                    test: async () => {
                        // Test admin endpoint without auth
                        const res = await fetch('/api/admin/upload-image', { 
                            method: 'POST',
                            credentials: 'omit'
                        });
                        if (res.status === 401 || res.status === 403) {
                            return { success: true, data: { status: res.status, message: 'Correctly denied' } };
                        }
                        throw new Error(`Expected 401/403, got ${res.status}`);
                    }
                },
                {
                    name: 'Root to Shop',
                    description: 'Test index.html loads correctly',
                    test: async () => {
                        const res = await fetch('/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        if (!html.includes('<!DOCTYPE html>')) throw new Error('Not valid HTML');
                        return { success: true, data: { status: res.status, hasHtml: true } };
                    }
                },
                {
                    name: '404 Handler',
                    description: 'Test 404 page for non-existent routes',
                    test: async () => {
                        const res = await fetch('/this-page-does-not-exist-test-12345');
                        if (res.status !== 404) {
                            return { warning: `Expected 404, got ${res.status}`, data: { status: res.status } };
                        }
                        const html = await res.text();
                        return { success: true, data: { status: 404, has404Page: html.length > 0 } };
                    }
                }
            ],
            errors: [
                {
                    name: 'Invalid API Endpoint',
                    description: 'Test non-existent API route handling',
                    test: async () => {
                        const res = await fetch('/api/invalid-endpoint-test-xyz');
                        if (res.status >= 400 && res.status < 500) {
                            return { success: true, data: { status: res.status, message: 'Correctly returned 4xx' } };
                        }
                        throw new Error(`Expected 4xx error, got ${res.status}`);
                    }
                },
                {
                    name: 'Malformed JSON Upload',
                    description: 'Test upload endpoint with invalid data',
                    test: async () => {
                        const res = await fetch('/api/admin/upload-image', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: 'invalid-json-data'
                        });
                        if (res.status >= 400 && res.status < 500) {
                            return { success: true, data: { status: res.status, message: 'Correctly rejected bad data' } };
                        }
                        throw new Error(`Expected 4xx error, got ${res.status}`);
                    }
                },
                {
                    name: 'Empty Products Response',
                    description: 'Test products API handles empty results',
                    test: async () => {
                        const res = await fetch('/api/products');
                        const data = await res.json();
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        // Even if empty, should return valid JSON structure
                        if (!data.hasOwnProperty('success')) {
                            throw new Error('Missing success field in response');
                        }
                        return { success: true, data: { hasProducts: (data.products?.length || 0) > 0, structure: 'valid' } };
                    }
                },
                {
                    name: 'Session Validation',
                    description: 'Test /api/users/me with current session',
                    test: async () => {
                        const res = await fetch('/api/users/me', { credentials: 'include' });
                        if (!res.ok) {
                            // If not logged in, that's an expected error state
                            return { warning: 'Not authenticated (expected if not logged in)', data: { status: res.status } };
                        }
                        const data = await res.json();
                        if (!data.user || !data.user.email) {
                            throw new Error('Invalid session data structure');
                        }
                        return { success: true, data: { email: data.user.email, valid: true } };
                    }
                },
                {
                    name: 'CORS Headers',
                    description: 'Test API endpoints have proper CORS headers',
                    test: async () => {
                        const res = await fetch('/api/health');
                        const corsHeader = res.headers.get('Access-Control-Allow-Origin');
                        // CORS might not be set for same-origin requests, which is fine
                        return { success: true, data: { hasCors: !!corsHeader, origin: corsHeader || 'same-origin' } };
                    }
                }
            ],
            critical: [
                {
                    name: 'Database Connectivity',
                    description: 'Test D1 database is accessible',
                    test: async () => {
                        const res = await fetch('/api/users/me', { credentials: 'include' });
                        const data = await res.json();
                        // If we get a response (even error), DB is responding
                        return { success: true, data: { status: res.status, dbResponding: true } };
                    }
                },
                {
                    name: 'CF Images Integration',
                    description: 'Test Cloudflare Images API integration',
                    test: async () => {
                        const res = await fetch('/api/products');
                        const data = await res.json();
                        if (!res.ok) throw new Error(`CF Images API error: ${res.status}`);
                        if (!data.success) throw new Error(data.error || 'API returned success: false');
                        if (!data.products) throw new Error('No products array in response');
                        return { success: true, data: { 
                            imageCount: data.products.length, 
                            accountHash: data.products[0]?.image?.includes('imagedelivery.net') || false 
                        }};
                    }
                },
                {
                    name: 'Static Assets',
                    description: 'Test critical static files load',
                    test: async () => {
                        const tests = [
                            { url: '/styles/styles.css', type: 'CSS' },
                            { url: '/js/auth.js', type: 'JS' }
                        ];
                        const results = await Promise.all(
                            tests.map(async t => {
                                const res = await fetch(t.url);
                                return { ...t, status: res.status, ok: res.ok };
                            })
                        );
                        const failed = results.filter(r => !r.ok);
                        if (failed.length > 0) {
                            throw new Error(`Failed to load: ${failed.map(f => f.type).join(', ')}`);
                        }
                        return { success: true, data: results };
                    }
                },
                {
                    name: 'Admin Panel Access',
                    description: 'Test admin panel HTML loads',
                    test: async () => {
                        const res = await fetch('/admin/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        if (!html.includes('Admin')) {
                            return { warning: 'Admin panel loaded but missing expected content' };
                        }
                        return { success: true, data: { status: res.status, hasContent: true } };
                    }
                },
                {
                    name: 'Inventory Manager',
                    description: 'Test inventory manager page loads',
                    test: async () => {
                        const res = await fetch('/admin/inventory/');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        if (!html.includes('Inventory') && !html.includes('inventory')) {
                            return { warning: 'Page loaded but missing expected inventory content' };
                        }
                        return { success: true, data: { status: res.status, hasContent: true } };
                    }
                }
            ],
            email: [
                {
                    name: 'Email Verification Page',
                    description: 'Test /verify-email.html loads',
                    test: async () => {
                        const res = await fetch('/verify-email.html');
                        if (!res.ok) throw new Error(`Status: ${res.status}`);
                        const html = await res.text();
                        if (!html.includes('verify') && !html.includes('Verify')) {
                            return { warning: 'Page loaded but missing verification content' };
                        }
                        return { success: true, data: { status: res.status, pageExists: true } };
                    }
                },
                {
                    name: 'Verify Email Endpoint',
                    description: 'Test POST /api/verify-email endpoint exists',
                    test: async () => {
                        const res = await fetch('/api/verify-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: 'test-token-12345' })
                        });
                        const data = await res.json();
                        // Should return error (invalid token) but endpoint should exist
                        if (res.status === 404) throw new Error('Endpoint not found');
                        return { success: true, data: { status: res.status, endpointExists: true } };
                    }
                },
                {
                    name: 'Resend Verification Endpoint',
                    description: 'Test POST /api/resend-verification endpoint exists',
                    test: async () => {
                        const res = await fetch('/api/resend-verification', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: 'test@example.com' })
                        });
                        const data = await res.json();
                        // Should return success (doesn't reveal if email exists)
                        if (res.status === 404) throw new Error('Endpoint not found');
                        return { success: true, data: { status: res.status, endpointExists: true, response: data.message } };
                    }
                },
                {
                    name: 'Email Library',
                    description: 'Test email.js library is accessible',
                    test: async () => {
                        // We can't directly test the lib, but we can check if endpoints work
                        const res = await fetch('/api/health');
                        if (!res.ok) throw new Error('API not responding');
                        return { success: true, data: { libraryLoaded: true, note: 'Email functions loaded via API' } };
                    }
                }
            ]
        };

        async function runTest(test, category) {
            const testId = `test-${category}-${Date.now()}-${Math.random()}`;
            const container = document.getElementById(`${category}-tests`);
            
            // Create test item
            const testItem = document.createElement('div');
            testItem.className = 'test-item running';
            testItem.id = testId;
            testItem.innerHTML = `
                <div class="test-title">
                    <span class="test-status"><div class="spinner"></div></span>
                    <span>${test.name}</span>
                </div>
                <div class="test-details">${test.description}</div>
            `;
            container.appendChild(testItem);

            testResults.total++;
            updateSummary();

            try {
                const result = await test.test();
                
                if (result.warning) {
                    testItem.className = 'test-item warning';
                    testItem.querySelector('.test-status').textContent = '‚ö†Ô∏è';
                    testItem.querySelector('.test-details').innerHTML = `
                        ${test.description}<br>
                        <strong style="color: #f59e0b;">‚ö†Ô∏è ${result.warning}</strong>
                    `;
                    testResults.warnings++;
                } else {
                    testItem.className = 'test-item success';
                    testItem.querySelector('.test-status').textContent = '‚úÖ';
                    testResults.passed++;
                }

                if (result.data) {
                    const jsonViewer = document.createElement('div');
                    jsonViewer.className = 'json-viewer';
                    jsonViewer.textContent = JSON.stringify(result.data, null, 2);
                    testItem.appendChild(jsonViewer);
                }

            } catch (error) {
                testItem.className = 'test-item error';
                testItem.querySelector('.test-status').textContent = '‚ùå';
                testItem.querySelector('.test-details').innerHTML = `
                    ${test.description}<br>
                    <strong style="color: #ef4444;">‚ùå Error: ${error.message}</strong>
                `;
                testResults.failed++;
            }

            updateSummary();
        }

        async function runSection(section) {
            const container = document.getElementById(`${section}-tests`);
            container.innerHTML = '';
            
            const sectionTests = tests[section];
            for (const test of sectionTests) {
                await runTest(test, section);
            }
        }

        // Send test verification email
        async function sendTestEmail() {
            const emailInput = document.getElementById('testEmailInput');
            const resultDiv = document.getElementById('emailTestResult');
            const btn = document.getElementById('sendTestEmailBtn');
            
            const email = emailInput.value.trim();
            
            if (!email) {
                resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; color: #fca5a5;">‚ùå Please enter an email address</div>';
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; color: #fca5a5;">‚ùå Please enter a valid email address</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üì§ Sending...';
            resultDiv.innerHTML = '<div style="background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; color: #93c5fd;">‚è≥ Sending test email...</div>';
            
            try {
                const response = await fetch('/api/test-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; border-radius: 6px; padding: 12px; color: #86efac;">
                            <strong>‚úÖ Test email sent successfully!</strong><br>
                            <small style="color: #bbf7d0;">Sent to: ${email}</small><br>
                            <small style="color: #bbf7d0;">Check inbox (and spam folder) for verification email</small><br>
                            <small style="color: #bbf7d0;">Note: Uses test token - won't actually verify an account</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; color: #fde68a;">
                            <strong>‚ö†Ô∏è ${data.message || data.error || 'Request completed'}</strong><br>
                            <small style="color: #fef3c7;">Status: ${response.status}</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Test email error:', error);
                resultDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; color: #fca5a5;">
                        <strong>‚ùå Failed to send test email</strong><br>
                        <small style="color: #fecaca;">${error.message}</small>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìß Send Test Email';
            }
        }

        async function runAllTests() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running tests...';

            clearResults();

            for (const section of Object.keys(tests)) {
                await runSection(section);
            }

            btn.disabled = false;
            btn.textContent = 'üöÄ Run All Tests';
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };
            updateSummary();
            
            for (const section of Object.keys(tests)) {
                document.getElementById(`${section}-tests`).innerHTML = '';
            }
        }

        function updateSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            document.getElementById('warningTests').textContent = testResults.warnings;
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            console.log('üî¨ System Test Page Loaded');
        });
    </script>
</body>
</html>
