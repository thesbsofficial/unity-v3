<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📦 SBS Media Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #000000, #1a1a2e, #16213e);
            color: #00ff41;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(15, 15, 35, 0.9);
            border: 2px solid #D4AF37;
            border-radius: 20px;
        }

        .header h1 {
            font-size: 3rem;
            color: #D4AF37;
            margin-bottom: 10px;
        }

        .controls {
            background: rgba(15, 15, 35, 0.9);
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .button {
            padding: 12px 24px;
            background: #D4AF37;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
        }

        .button:hover {
            background: #00ff41;
        }

        .button.active {
            background: #00ff41;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
            padding: 20px;
        }

        .item-card {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .item-image-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #181824 60%, #232347 100%);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .item-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
            background: transparent;
            display: block;
        }

        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .tag {
            background: #232347;
            color: #e2e8f0;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #3b3b5c;
        }

        .tag-featured {
            background: #3b3b5c;
            color: #fbbf24;
            border-color: #fbbf24;
        }

        .tag-sale {
            background: #3b3b5c;
            color: #f87171;
            border-color: #f87171;
        }

        .tag-new {
            background: #232347;
            color: #34d399;
            border-color: #34d399;
        }

        .tag-trending {
            background: #232347;
            color: #a78bfa;
            border-color: #a78bfa;
        }

        .tag-staff-picks {
            background: #3b3b5c;
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .tag-limited {
            background: #3b3b5c;
            color: #fb7185;
            border-color: #fb7185;
        }

        .tag-bestseller {
            background: #232347;
            color: #4ade80;
            border-color: #4ade80;
        }

        .tag-premium {
            background: #232347;
            color: #c084fc;
            border-color: #c084fc;
        }

        .tag-clearance {
            background: #3b3b5c;
            color: #fb923c;
            border-color: #fb923c;
        }

        .tag-test {
            background: #232347;
            color: #94a3b8;
            border-color: #94a3b8;
        }

        .tag-live {
            background: #232347;
            color: #4ade80;
            border-color: #4ade80;
        }

        .tag-deleted {
            background: #3b3b5c;
            color: #ef4444;
            border-color: #ef4444;
        }

        .tag-category {
            background: #232347;
            color: #a78bfa;
            border-color: #3b3b5c;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
            font-size: 16px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #475569;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            .header {
                padding: 20px 16px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                padding: 16px;
            }
            
            .inventory-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Upload Section */
        #uploadSection {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #475569;
            display: none;
        }

        #dropZone {
            border: 2px dashed #8b5cf6;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(45, 27, 105, 0.3) 0%, rgba(139, 92, 246, 0.1) 100%);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 20px;
        }

        #dropZone:hover {
            border-color: #06d6a0;
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.1) 0%, rgba(17, 138, 178, 0.1) 100%);
        }
    </style>

    <!-- All JavaScript is now in a single <script> block after the HTML/CSS -->
    <script>
        // =============================================================
        // 1. CONFIGURATION & CONSTANTS
        // =============================================================
        // All the settings and constants for the app. Change these if you want to adjust how things work.
        const API_CONFIG = {
            proxyUrl: 'http://localhost:9600/api', // Where the backend server is
            accountHash: '7B8CAeDtA5h1f1Dyh_X-hg' // Needed for Cloudflare Images
        };
        const CONFIG = {
            DEBUG_MODE: false,         // Set to true to see extra logs in the browser console
            MAX_LOG_ENTRIES: 20,       // How many log messages to keep in the viewer
            LOG_DOWNLOAD_DELAY: 5000,  // How long to show progress after download (ms)
            DOM_REFRESH_DELAY: 100     // Delay for refreshing DOM (ms)
        };

        // =============================================================
        // 2. DOM CACHE (for performance)
        // =============================================================
        // This object stores references to important elements on the page.
        // It makes the app faster by not searching for them every time.
        const DOM_CACHE = {
            container: null,      // Where the photos are shown
            statusDiv: null,      // The status message area
            tagFilter: null,      // The tag/category filter dropdown
            uploadSection: null,  // The upload area
            fileInput: null,      // The file input for uploads
            helpModal: null,      // The help popup
            init() {
                this.container = document.getElementById('inventoryContainer');
                this.statusDiv = document.getElementById('status');
                this.tagFilter = document.getElementById('tagFilter');
                this.uploadSection = document.getElementById('uploadSection');
                this.fileInput = document.getElementById('fileInput');
                this.helpModal = document.getElementById('helpModal');
            },
            get(elementId) {
                return document.getElementById(elementId);
            }
        };

        // =============================================================
        // 3. GLOBAL STATE
        // =============================================================
        // These are the main variables that keep track of what the app is doing.
        // You can change these if you want to adjust how the site works.
        let currentView = 'grid';        // 'grid' or 'list' - how photos are shown
        let inventory = [];              // All the photo items loaded from the server
        let itemsPerPage = 9;            // How many items to show at once (change for more/less)
        let currentPage = 1;             // Which page of items are we on?
        let displayedItems = 0;          // How many items are currently shown
        let currentSection = 'all';      // Which filter/category is active
        let selectedFiles = [];          // Files picked for upload
        let uploadLogs = [];             // All log messages (for the log viewer)

        // =============================================================
        // 4. UI HELPERS
        // =============================================================
        // All the little tools for showing/hiding things and updating the page.
        // If you want to change how popups, logs, or status messages work, edit here.
        const UI = {
            showModal: (id) => document.getElementById(id).style.display = 'block',
            hideModal: (id) => document.getElementById(id).style.display = 'none',
            updateStatus: (message) => {
                const statusDiv = document.getElementById('status');
                if (statusDiv) statusDiv.textContent = message;
            },
            logMessage: (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? 'ERROR: ' : '';
                const logEntry = `[${timestamp}] ${prefix}${message}`;
                uploadLogs.push(logEntry);
                UI.updateLogDisplay();
                if (CONFIG.DEBUG_MODE) console.log(logEntry); // Only shows in browser console if debug is on
            },
            updateLogDisplay: () => {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.textContent = uploadLogs.slice(-CONFIG.MAX_LOG_ENTRIES).join('\n');
                    logContent.scrollTop = logContent.scrollHeight;
                }
            },
            element: (id) => document.getElementById(id)
        };

        // Simple helpers to keep legacy logMessage/logError calls working
        const logMessage = (message) => UI.logMessage(message, 'info');
        const logError = (message, error) => {
            const details = error?.message ? ` (${error.message})` : '';
            UI.logMessage(`${message}${details}`, 'error');
            if (CONFIG.DEBUG_MODE && error) console.error(message, error);
        };

        const parseJsonSafely = async (response) => {
            try {
                return await response.json();
            } catch (_) {
                return {};
            }
        };

        const Inventory = {
            getById(itemId) {
                return inventory.find(item => item.id === itemId || item.cloudflareId === itemId) || null;
            },
            remove(itemId) {
                const before = inventory.length;
                inventory = inventory.filter(item => item.id !== itemId);
                return before !== inventory.length;
            },
            itemsWithTag(rawTag) {
                const tag = (rawTag || '').toString().toUpperCase();
                if (!tag) return [];
                return inventory.filter(item => (item.tags || []).some(existing => existing && existing.toUpperCase() === tag));
            },
            uniqueTags() {
                const tags = new Set();
                inventory.forEach(item => {
                    (item.tags || []).forEach(tag => {
                        if (tag) tags.add(tag);
                    });
                });
                return Array.from(tags).sort((a, b) => a.localeCompare(b));
            },
            buildMetadataSnapshot(item, overrides = {}) {
                const baseMeta = {
                    ...(item.meta || {}),
                    category: item.category ?? item.meta?.category ?? '',
                    size: item.size ?? item.meta?.size ?? '',
                    batchNumber: item.batchNumber ?? item.meta?.batchNumber ?? '',
                    itemNumber: item.itemNumber ?? item.meta?.itemNumber ?? '',
                    siteSection: item.siteSection ?? item.meta?.siteSection ?? '',
                    description: item.description ?? item.meta?.description ?? '',
                    tags: (item.tags || []).join(',')
                };
                return Object.entries({ ...baseMeta, ...overrides }).reduce((acc, [key, value]) => {
                    if (value !== undefined && value !== null) acc[key] = value;
                    return acc;
                }, {});
            },
            async syncMetadata(item, overrides = {}) {
                const metadataPayload = this.buildMetadataSnapshot(item, overrides);
                const response = await fetch(`${API_CONFIG.proxyUrl}/images/${item.cloudflareId || item.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metadata: metadataPayload })
                });

                const data = await parseJsonSafely(response);
                if (!response.ok || data.success === false) {
                    throw new Error(data.error || `Metadata sync failed (HTTP ${response.status})`);
                }

                item.meta = metadataPayload;
                item.tags = (metadataPayload.tags || '')
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
                return data;
            }
        };

        const Delete = {
            async image(itemId, options = {}) {
                const { skipConfirm = false, silent = false } = options;
                const item = Inventory.getById(itemId);

                if (!item) {
                    logError(`Delete requested for missing item ${itemId}`, new Error('Item not found in inventory'));
                    return;
                }

                const label = item.filename || item.name || itemId;
                if (!skipConfirm) {
                    const confirmed = confirm(`Delete "${label}" from Cloudflare? This cannot be undone.`);
                    if (!confirmed) return;
                }

                UI.updateStatus(`🗑️ Deleting ${label}...`);

                try {
                    const response = await fetch(`${API_CONFIG.proxyUrl}/images/${item.cloudflareId || item.id}`, {
                        method: 'DELETE'
                    });

                    const data = await parseJsonSafely(response);
                    if (!response.ok || data.success === false) {
                        throw new Error(data.error || `Delete failed (HTTP ${response.status})`);
                    }

                    Inventory.remove(itemId);
                    logMessage(`🗑️ Deleted ${label} (${itemId})`);
                    displayInventory();

                    if (typeof BulkDeleteUI !== 'undefined' && typeof BulkDeleteUI.populateTagDropdown === 'function') {
                        BulkDeleteUI.populateTagDropdown();
                    }

                    if (!silent) {
                        UI.updateStatus(`✅ Deleted ${label}`);
                    }

                    return data;
                } catch (error) {
                    logError(`Failed to delete ${label}`, error);
                    UI.updateStatus(`❌ Failed to delete ${label}`);
                    if (!silent) alert(`Delete failed: ${error.message}`);
                    throw error;
                }
            },

            async tag(itemId, tag) {
                const item = Inventory.getById(itemId);
                if (!item) {
                    logError(`Tag removal requested for missing item ${itemId}`, new Error('Item not found'));
                    return;
                }

                const label = item.filename || item.name || itemId;
                const confirmation = confirm(`Remove tag "${tag}" from ${label}?`);
                if (!confirmation) return;

                const updatedTags = (item.tags || []).filter(existing => existing !== tag);

                try {
                    await Inventory.syncMetadata(item, { tags: updatedTags.join(',') });
                    logMessage(`🏷️ Removed tag "${tag}" from ${label}`);
                    displayInventory();

                    if (typeof BulkDeleteUI !== 'undefined' && typeof BulkDeleteUI.populateTagDropdown === 'function') {
                        BulkDeleteUI.populateTagDropdown();
                    }
                } catch (error) {
                    logError(`Failed to remove tag ${tag} from ${label}`, error);
                    alert(`Couldn't remove tag: ${error.message}`);
                }
            },

            async bulkByTag(tag, options = {}) {
                const { confirmPrompt = true, onProgress } = options;
                const cleanTag = (tag || '').trim();
                if (!cleanTag) {
                    throw new Error('Tag is required for bulk delete.');
                }

                const matches = Inventory.itemsWithTag(cleanTag);
                if (matches.length === 0) {
                    throw new Error(`No items found with tag "${cleanTag}".`);
                }

                if (confirmPrompt) {
                    const confirmed = confirm(`Delete ${matches.length} item${matches.length === 1 ? '' : 's'} tagged "${cleanTag}"?`);
                    if (!confirmed) return { cancelled: true };
                }

                let successCount = 0;
                const failures = [];
                const total = matches.length;

                for (let index = 0; index < matches.length; index++) {
                    const item = matches[index];
                    if (typeof onProgress === 'function') {
                        try {
                            onProgress({ phase: 'start', item, index, total });
                        } catch (progressError) {
                            if (CONFIG.DEBUG_MODE) console.warn('Bulk delete progress handler threw during start phase', progressError);
                        }
                    }

                    try {
                        await this.image(item.id, { skipConfirm: true, silent: true });
                        successCount++;
                        if (typeof onProgress === 'function') {
                            try {
                                onProgress({ phase: 'success', item, index, total, successCount });
                            } catch (progressError) {
                                if (CONFIG.DEBUG_MODE) console.warn('Bulk delete progress handler threw during success phase', progressError);
                            }
                        }
                    } catch (error) {
                        failures.push({ id: item.id, error });
                        if (typeof onProgress === 'function') {
                            try {
                                onProgress({ phase: 'error', item, index, total, error });
                            } catch (progressError) {
                                if (CONFIG.DEBUG_MODE) console.warn('Bulk delete progress handler threw during error phase', progressError);
                            }
                        }
                    }
                }

                logMessage(`Bulk delete for "${cleanTag}" complete: ${successCount} success, ${failures.length} failed.`);
                displayInventory();

                if (typeof BulkDeleteUI !== 'undefined' && typeof BulkDeleteUI.populateTagDropdown === 'function') {
                    BulkDeleteUI.populateTagDropdown();
                }

                if (typeof onProgress === 'function') {
                    try {
                        onProgress({ phase: 'complete', total, successCount, failures: [...failures] });
                    } catch (progressError) {
                        if (CONFIG.DEBUG_MODE) console.warn('Bulk delete progress handler threw during complete phase', progressError);
                    }
                }

                if (failures.length) {
                    const summary = failures.map(entry => `${entry.id}: ${entry.error.message}`).join('; ');
                    throw new Error(`${failures.length} item${failures.length === 1 ? '' : 's'} failed to delete. ${summary}`);
                }

                return { successCount, failedCount: 0 };
            }
        };

        // =============================================================
        // 5. CORE FUNCTIONS
        // =============================================================
        /**
         * loadItems()
         * Loads all photo items from the server (Cloudflare Images API)
         * - Shows a status message while loading
         * - Updates the log with what is happening
         * - If successful, saves all items to the inventory array and shows them on the page
         * - If there is an error, shows a clear error message
         *
         * You can change how items are loaded or sorted here.
         */
        async function loadItems() {
            UI.updateStatus('🔍 Loading items from Cloudflare Images...');
            UI.logMessage('Fetching items from /api/images...');

            try {
                const response = await fetch(`${API_CONFIG.proxyUrl}/images`);
                if (!response.ok) {
                    const errorData = await parseJsonSafely(response);
                    let detailMessage = `${response.status} ${response.statusText}`;

                    if (errorData && typeof errorData === 'object') {
                        if (errorData.error) detailMessage += ` — ${errorData.error}`;
                        if (errorData.details) {
                            try {
                                detailMessage += ` | details: ${JSON.stringify(errorData.details)}`;
                            } catch (_) {
                                detailMessage += ' | details available';
                            }
                        }
                    }

                    throw new Error(`Failed to fetch items: ${detailMessage}`);
                }

                const result = await parseJsonSafely(response);
                if (result.success && Array.isArray(result.images)) {
                    // This turns each image from the server into a simple object we can use
                    inventory = result.images.map(item => ({
                        id: item.id, // Unique ID for this image
                        name: item.filename || item.id, // Name or fallback to ID
                        filename: item.filename || 'Unknown',
                        cloudflareId: item.id,
                        uploaded: item.uploaded, // When it was uploaded
                        variants: item.variants || [], // Different sizes
                        meta: item.meta || {}, // Extra info
                        tags: (item.meta?.tags || '').split(',').map(t => t.trim()).filter(t => t), // List of tags
                        category: item.meta?.category || null, // Category (if any)
                        size: item.meta?.size || null, // Size (if any)
                        batchNumber: item.meta?.batchNumber || null, // Batch number (if any)
                        itemNumber: item.meta?.itemNumber || null, // Item number (if any)
                        siteSection: item.meta?.siteSection || null, // Section (if any)
                        description: item.meta?.description || '', // Description (if any)
                        status: 'available', // Default status
                        image: `https://imagedelivery.net/${API_CONFIG.accountHash}/${item.id}/w=1920,h=1080` // Image URL
                    })).sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded)); // Newest first

                    // Show how many items were loaded
                    const statusDiv = UI.element('status');
                    statusDiv.innerHTML = `
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; color: #00ff41;">
                            <span>? Loaded: <strong>${inventory.length}</strong> items from Cloudflare</span>
                            <span>✅ Ready to display</span>
                        </div>
                    `;
                    
                    UI.logMessage(`Successfully loaded ${inventory.length} items from Cloudflare Images`);
                    displayInventory();
                } else {
                    UI.updateStatus('? Failed to load items: Invalid response format');
                }
            } catch (error) {
                UI.updateStatus(`? Failed to load items: ${error.message}`);
                UI.logMessage(`Error loading items: ${error.message}`);
            }
        }

        /**
         * setView(mode)
         * Switches between grid and list view for the photo gallery
         * - mode: 'grid' or 'list'
         * - Highlights the active button
         * - Changes the layout of the photo container
         *
         * You can add more view modes or change the style here.
         */
        function setView(mode) {
            currentView = mode;
            document.querySelectorAll('.button').forEach(btn => btn.classList.remove('active'));
            UI.element(mode + 'Btn').classList.add('active');
            
            const container = DOM_CACHE.container || UI.element('inventoryContainer');
            container.className = mode + '-view';
            displayInventory();
        }

        /**
         * displayInventory(append = false)
         * Shows the photo items on the page, with pagination (shows more when you click "View More")
         * - If append is true, adds more items to the list
         * - If no items, shows a friendly message
         *
         * You can change how items are displayed, or how many show at once, here.
         */
        function displayInventory(append = false) {
            const container = DOM_CACHE.container || document.getElementById('inventoryContainer');
            const filteredInventory = getFilteredInventory();
            
            if (inventory.length === 0) {
                container.innerHTML = '<div class="loading">📷 No images loaded yet. Start API proxy and click "Quick Browse" to browse your inventory.</div>';
                return;
            }

            if (filteredInventory.length === 0) {
                container.innerHTML = `<div class="loading">📂 No items in ${currentSection.toUpperCase()} section yet.</div>`;
                return;
            }

            // Reset pagination if not appending
            if (!append) {
                currentPage = 1;
                displayedItems = 0;
            }

            // Calculate items to show
            const startIndex = append ? displayedItems : 0;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredInventory.length);
            const itemsToShow = filteredInventory.slice(startIndex, endIndex);
            
            // Update displayed count
            displayedItems = endIndex;

            let html = '';
            
            // If not appending, create new grid structure
            if (!append) {
                html = '<div class="inventory-grid">';
            }

            itemsToShow.forEach(item => {
                // Create tag HTML with better styling - ensure tags is an array
                const tags = item.tags || [];
                const tagHtml = tags.map(tag => {
                    let tagClass = 'tag';
                    let tagIcon = '';
                    if (tag === 'FEATURED') { tagClass += ' tag-featured'; tagIcon = '⭐ '; }
                    else if (tag === 'SALE') { tagClass += ' tag-sale'; tagIcon = '🏷️ '; }
                    else if (tag === 'NEW') { tagClass += ' tag-new'; tagIcon = '🆕 '; }
                    else if (tag === 'TRENDING') { tagClass += ' tag-trending'; tagIcon = '📈 '; }
                    else if (tag === 'STAFF-PICKS') { tagClass += ' tag-staff-picks'; tagIcon = '👑 '; }
                    else if (tag === 'LIMITED') { tagClass += ' tag-limited'; tagIcon = '⚡ '; }
                    else if (tag === 'BESTSELLER') { tagClass += ' tag-bestseller'; tagIcon = '🔥 '; }
                    else if (tag === 'PREMIUM') { tagClass += ' tag-premium'; tagIcon = '💎 '; }
                    else if (tag === 'CLEARANCE') { tagClass += ' tag-clearance'; tagIcon = '🔻 '; }
                    else if (tag === 'NEW UPLOAD') { tagClass += ' tag-new'; tagIcon = '📤 '; }
                    else if (tag === 'TEST UPLOAD') { tagClass += ' tag-test'; tagIcon = '🧪 '; }
                    else if (tag === 'LIVE') { tagClass += ' tag-live'; tagIcon = '🟢 '; }
                    else if (tag === 'DELETED') { tagClass += ' tag-deleted'; tagIcon = '❌ '; }
                    return `<span class="${tagClass}">${tagIcon}${(tag || '').replace('-', ' ')}<button onclick="Delete.tag('${item.id}','${tag}')" style="margin-left:4px;background:none;border:none;color:#ff4444;cursor:pointer;font-size:13px;">✖️</button></span>`;
                }).join('');

                // Clean item display - no deletion checking
                const itemCardClass = 'item-card';
                const statusIcon = '🖼️';
                
                // Optimized image display (removed console.log for performance)
                const imageDisplay = `<div class="item-image-container"><img src="${item.image}" 
                         alt="${item.name}" 
                         class="item-image" 
                         data-item-id="${item.id}"
                         onerror="this.style.background='linear-gradient(45deg, #D4AF37, #00ff41)'; this.style.color='#000'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.innerHTML='📸';"></div>`;

                html += `
                    <div class="${itemCardClass}" style="position:relative;">
                        <div class="status-icon">${statusIcon}</div>
                        ${imageDisplay}
                        <button onclick="Delete.image('${item.id}')" style="position:absolute;top:10px;right:10px;background:#232347;border:none;color:#ff4444;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:18px;z-index:2;">🗑️</button>
                        <div class="item-tags">
                            ${tagHtml}
                            <span class="tag tag-category">${item.category ? item.category.replace('-', ' ') : 'CATEGORY'}</span>
                            <span class="tag tag-size">${item.size || 'SIZE'}</span>
                            ${item.batchNumber ? `<span class="tag tag-batch" style="background: rgba(138, 43, 226, 0.3); color: #8a2be2;">[B${item.batchNumber}]</span>` : ''}
                            ${item.itemNumber ? `<span class="tag tag-item" style="background: rgba(255, 136, 0, 0.3); color: #ff8800;">#${item.itemNumber}</span>` : ''}
                        </div>
                        <div class="item-details" style="font-size: 10px; opacity: 0.6;">
                            ${item.description ? `${item.description} | ` : ''}${item.name || 'Unnamed Item'}${item.siteSection ? ` | ${item.siteSection}` : ''} | ID: ${item.id ? item.id.substring(0, 8) + '...' : 'No ID'}
                        </div>
                    </div>
                `;
            });

            // Close grid div if not appending
            if (!append) {
                html += '</div>';
                
                // Add pagination controls
                const remainingItems = filteredInventory.length - displayedItems;
                if (remainingItems > 0) {
                    html += `
                        <div id="paginationControls" style="margin: 20px 0; text-align: center;">
                            <button onclick="showMore()" style="
                                background: linear-gradient(135deg, #4CAF50, #45a049);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                font-size: 16px;
                                border-radius: 25px;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                                transition: all 0.3s ease;
                                font-weight: 600;
                                min-height: 44px;
                                width: 100%;
                                max-width: 300px;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.3)';">
                                 View More (${Math.min(itemsPerPage, remainingItems)})
                                <div style="font-size: 12px; opacity: 0.9; margin-top: 3px;">
                                    Showing ${displayedItems} of ${filteredInventory.length} items
                                </div>
                            </button>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } else {
                // Appending items - add to existing grid
                const grid = container.querySelector('.inventory-grid');
                if (grid) {
                    grid.innerHTML += html;
                    
                    // Update or remove pagination controls
                    const paginationControls = document.getElementById('paginationControls');
                    const remainingItems = filteredInventory.length - displayedItems;
                    
                    if (remainingItems > 0) {
                        paginationControls.innerHTML = `
                            <button onclick="showMore()" style="
                                background: linear-gradient(135deg, #4CAF50, #45a049);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                font-size: 16px;
                                border-radius: 25px;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                                transition: all 0.3s ease;
                                font-weight: 600;
                                min-height: 44px;
                                width: 100%;
                                max-width: 300px;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.3)';">
                                 View More (${Math.min(itemsPerPage, remainingItems)})
                                <div style="font-size: 12px; opacity: 0.9; margin-top: 3px;">
                                    Showing ${displayedItems} of ${filteredInventory.length} items
                                </div>
                            </button>
                        `;
                    } else {
                        paginationControls.style.display = 'none';
                    }
                }
            }
        }

        // Show More function for pagination
        function showMore() {
            currentPage++;
            displayInventory(true); // append = true
        }

        // =============================================================
        // 6. SECTION & FILTER FUNCTIONS
        // =============================================================
        async function loadImagesAndShowSection(section) {
            await loadItems();
            showSection(section);
        }

        function showSection(section) {
            currentSection = section;
            currentPage = 1;
            displayedItems = 0;
            
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                if (btn.id.includes('all') || btn.id.includes('featured') || btn.id.includes('sale')) {
                    btn.classList.remove('active');
                }
            });
            UI.element(section + 'Btn').classList.add('active');
            
            displayInventory();
            UI.logMessage(`Switched to section: ${section.toUpperCase()}`);
        }

        function getFilteredInventory() {
            if (currentSection === 'all') return inventory;
            
            return inventory.filter(item => {
                if (!item.tags) return false;
                
                const sectionMap = {
                    featured: 'FEATURED', sale: 'SALE', new: 'NEW',
                    trending: 'TRENDING', premium: 'PREMIUM', 
                    clearance: 'CLEARANCE', deleted: 'DELETED'
                };
                
                return item.tags.includes(sectionMap[currentSection]);
            });
        }

        function quickFilter(filterType) {
            currentPage = 1;
            displayedItems = 0;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.opacity = '0.6';
                btn.style.transform = 'scale(1)';
            });
            
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) {
                activeBtn.style.opacity = '1';
                activeBtn.style.transform = 'scale(1.05)';
            }
            
            currentSection = filterType;
            displayInventory();
        }

        // =============================================================
        // 7. UTILITY FUNCTIONS
        // =============================================================
        const Utils = {
            toggleLogs: () => {
                const logViewer = UI.element('logViewer');
                logViewer.style.display = logViewer.style.display === 'none' ? 'block' : 'none';
                if (logViewer.style.display === 'block') UI.updateLogDisplay();
            },
            
            clearLogs: () => {
                if (confirm('Clear all logs?')) {
                    uploadLogs = [];
                    UI.updateLogDisplay();
                    UI.logMessage('Logs cleared by user');
                }
            },
            
            updateStatusDisplay: () => {
                const counts = {
                    available: inventory.filter(i => i.status !== 'sold' && i.status !== 'reserved').length,
                    reserved: inventory.filter(i => i.status === 'reserved').length,
                    sold: inventory.filter(i => i.status === 'sold').length,
                    archived: inventory.filter(i => i.status === 'archived').length
                };
                
                UI.element('status').innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <span style="color: #a78bfa;">? Database: <strong>${inventory.length}</strong> items</span>
                        <span style="color: #06d6a0;">? Available: <strong>${counts.available}</strong></span>
                        <span style="color: #f59e0b;">? Reserved: <strong>${counts.reserved}</strong></span>
                        <span style="color: #8b5cf6;">💰 Sold: <strong>${counts.sold}</strong></span>
                        <span style="color: #94a3b8;">📦 Archived: <strong>${counts.archived}</strong></span>
                    </div>
                `;
            }
        };

        // =============================================================
        // 8. DIAGNOSTIC FUNCTIONS
        // =============================================================
        const Diagnostics = {
            refreshSystemStatus: () => {
                const inspector = UI.element('systemStatusInspector');
                if (!inspector) return;

                const status = {
                    timestamp: new Date().toLocaleString(),
                    inventoryCount: inventory.length,
                    availableImages: inventory.filter(item => item.status === 'available').length,
                    currentView: currentView,
                    currentSection: currentSection,
                    apiConnected: API_CONFIG ? 'Yes' : 'No'
                };

                inspector.innerHTML = `
                    <div style="color: #00ff41;">🔧 System Status at ${status.timestamp}</div>
                    <div style="margin: 5px 0; padding: 5px; border-left: 3px solid #00ff41;">
                        Inventory: ${status.inventoryCount} total | Available: ${status.availableImages}<br>
                        View: ${status.currentView} | Section: ${status.currentSection}<br>
                        API Connected: ${status.apiConnected}
                    </div>
                `;
            },
            
            refreshLocalStorage: () => {
                const inspector = UI.element('localStorageInspector');
                if (!inspector) return;

                let storageHTML = `<div style="color: #ff8800;">💾 Local Storage (${new Date().toLocaleTimeString()})</div><br>`;
                
                if (localStorage.length === 0) {
                    storageHTML += '<div style="color: #666;">No items in local storage</div>';
                } else {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        let displayValue = value.length > 100 ? value.substring(0, 100) + '...' : value;
                        
                        storageHTML += `
                            <div style="margin: 8px 0; padding: 5px; border-left: 2px solid #ff8800;">
                                <strong>${key}:</strong><br>
                                <span style="color: #ccc;">${displayValue}</span>
                            </div>
                        `;
                    }
                }
                
                inspector.innerHTML = storageHTML;
            },
            
            clearAllLocalStorage: () => {
                if (confirm('Clear ALL local storage? This removes all stored data.')) {
                    localStorage.clear();
                    Diagnostics.refreshLocalStorage();
                    UI.logMessage('All local storage cleared by user');
                    alert('Local storage cleared!');
                }
            },
            
            refreshActivityLog: () => {
                const inspector = UI.element('activityLogInspector');
                if (!inspector) return;

                const recentLogs = uploadLogs.slice(-CONFIG.MAX_LOG_ENTRIES);
                
                if (recentLogs.length === 0) {
                    inspector.innerHTML = '<div style="color: #666;">No activity logged yet</div>';
                    return;
                }

                let logHTML = `<div style="color: #8a2be2;">📊 Recent Activity (Last ${recentLogs.length} entries)</div><br>`;
                
                recentLogs.forEach(log => {
                    const isError = log.includes('ERROR');
                    const color = isError ? '#ff4444' : '#8a2be2';
                    
                    logHTML += `
                        <div style="margin: 3px 0; padding: 3px; border-left: 2px solid ${color}; color: ${color};">
                            ${log}
                        </div>
                    `;
                });
                
                inspector.innerHTML = logHTML;
                inspector.scrollTop = inspector.scrollHeight;
            },
            
            downloadLogs: () => {
                const blob = new Blob([uploadLogs.join('\n')], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sbs-media-hub-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.logMessage('Logs downloaded by user');
            }
        };

        // =============================================================
        // 9. DATABASE TEST FUNCTIONS
        // =============================================================
        const Database = {
            async testConnection() {
                const resultDiv = UI.element('databaseTestResult');
                if (!resultDiv) return;

                resultDiv.innerHTML = '<div style="color: #D4AF37;">?? Testing database connection...</div>';
                
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${API_CONFIG.proxyUrl}/test`);
                    const responseTime = Date.now() - startTime;

                    if (response.ok) {
                        const data = await response.json();
                        resultDiv.innerHTML = `
                            <div style="color: #00ff41;">? Database Connection Successful</div>
                            <div style="margin: 5px 0; color: #D4AF37;">
                                Response Time: ${responseTime}ms<br>
                                Status: ${response.status} ${response.statusText}<br>
                                Timestamp: ${new Date().toLocaleString()}
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div style="color: #ff4444;">? Database Connection Failed</div>
                            <div style="margin: 5px 0; color: #ff8800;">
                                Status: ${response.status} ${response.statusText}<br>
                                Response Time: ${responseTime}ms
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="color: #ff4444;">? Database Connection Error</div>
                        <div style="margin: 5px 0; color: #ff8800;">
                            Error: ${error.message}<br>
                            Check if START-API-PROXY.bat is running
                        </div>
                    `;
                }
            },

            async viewStats() {
                const resultDiv = UI.element('databaseTestResult');
                if (!resultDiv) return;

                resultDiv.innerHTML = '<div style="color: #D4AF37;">?? Loading database statistics...</div>';
                
                try {
                    const response = await fetch(`${API_CONFIG.proxyUrl}/items/stats`);
                    
                    if (response.ok) {
                        const stats = await response.json();
                        resultDiv.innerHTML = `
                            <div style="color: #00ff41;">?? Database Statistics</div>
                            <div style="margin: 5px 0; color: #D4AF37;">
                                Total Items: ${stats.total || inventory.length}<br>
                                Available: ${stats.available || inventory.filter(i => i.imageStatus === 'available').length}<br>
                                Categories: ${stats.categories || 'Unknown'}<br>
                                Last Updated: ${stats.lastUpdated || 'Unknown'}
                            </div>
                        `;
                    } else {
                        const localStats = {
                            total: inventory.length,
                            available: inventory.filter(item => item.imageStatus === 'available').length,
                            categories: [...new Set(inventory.map(item => item.category))].length
                        };
                        
                        resultDiv.innerHTML = `
                            <div style="color: #ff8800;">?? Local Statistics (Database Unavailable)</div>
                            <div style="margin: 5px 0; color: #D4AF37;">
                                Local Inventory: ${localStats.total} items<br>
                                Available: ${localStats.available}<br>
                                Categories: ${localStats.categories}
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="color: #ff4444;">? Cannot Load Statistics</div>
                        <div style="margin: 5px 0; color: #ff8800;">Error: ${error.message}</div>
                    `;
                }
            }
        };

        function clearAllFilters() {
            // Reset all states
            currentSection = 'all';
            currentPage = 1;
            displayedItems = 0;
            
            // Reset filter button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.opacity = '0.6';
                btn.style.transform = 'scale(1)';
            });
            
            // Show All items
            displayInventory();
            
            logMessage('All filters cleared - showing all items');
        }


        // Show/Hide Upload Functions (with DOM cache)
        function showUpload() {
            const uploadSection = DOM_CACHE.uploadSection || document.getElementById('uploadSection');
            uploadSection.style.display = 'block';
            uploadSection.scrollIntoView({ behavior: 'smooth' });
        }

        const BulkDeleteUI = {
            modalId: 'bulkDeleteModal',
            selectors: {
                tagSelect: '#bulkDeleteTagSelect',
                preview: '#bulkDeletePreview',
                confirmBtn: '#bulkDeleteConfirmBtn',
                cancelBtn: '#bulkDeleteCancelBtn',
                confirmInput: '#bulkDeleteTagConfirmInput',
                countInput: '#bulkDeleteCountConfirmInput',
                ackCheckbox: '#bulkDeleteAckCheckbox',
                downloadBtn: '#bulkDeleteDownloadBtn',
                copyBtn: '#bulkDeleteCopyBtn',
                refreshBtn: '#bulkDeleteRefreshBtn',
                resetBtn: '#bulkDeleteResetBtn',
                progressWrap: '#bulkDeleteProgressWrap',
                progressMeter: '#bulkDeleteProgressMeter',
                progressLabel: '#bulkDeleteProgressLabel'
            },
            state: {
                busy: false,
                selectedTag: '',
                matches: [],
                typedTag: '',
                typedCount: '',
                acknowledged: false,
                progress: {
                    total: 0,
                    current: 0,
                    failures: 0
                },
                lockPreview: false
            },

            show() {
                let modal = document.getElementById(this.modalId);
                if (!modal) {
                    modal = this.createModal();
                    document.body.appendChild(modal);
                }

                modal.style.display = 'flex';
                this.resetState();
                this.populateTagDropdown();
                this.updatePreview();
                logMessage('Bulk delete modal opened');
            },

            close() {
                const modal = document.getElementById(this.modalId);
                if (modal) {
                    modal.remove();
                    logMessage('Bulk delete modal closed');
                }
            },

            resetState() {
                this.state.busy = false;
                this.state.selectedTag = '';
                this.state.matches = [];
                this.state.typedTag = '';
                this.state.typedCount = '';
                this.state.acknowledged = false;
                this.state.progress = { total: 0, current: 0, failures: 0 };
                this.state.lockPreview = false;

                const modal = document.getElementById(this.modalId);
                if (!modal) return;

                const confirmInput = modal.querySelector(this.selectors.confirmInput);
                const countInput = modal.querySelector(this.selectors.countInput);
                const ackCheckbox = modal.querySelector(this.selectors.ackCheckbox);
                const confirmBtn = modal.querySelector(this.selectors.confirmBtn);
                const progressWrap = modal.querySelector(this.selectors.progressWrap);
                const progressMeter = modal.querySelector(this.selectors.progressMeter);
                const progressLabel = modal.querySelector(this.selectors.progressLabel);

                if (confirmInput) confirmInput.value = '';
                if (countInput) countInput.value = '';
                if (ackCheckbox) ackCheckbox.checked = false;
                if (confirmBtn) confirmBtn.disabled = true;
                if (progressWrap) progressWrap.style.display = 'none';
                if (progressMeter) progressMeter.style.width = '0%';
                if (progressLabel) progressLabel.textContent = 'No items selected yet.';
                this.state.lockPreview = false;
            },

            createModal() {
                const modal = document.createElement('div');
                modal.id = this.modalId;
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = this.getModalHTML();
                this.setupEventListeners(modal);
                return modal;
            },

            getModalHTML() {
                return `
                    <div class="modal-content" style="background: linear-gradient(135deg,#181824 60%,#232347 100%); border: 1px solid #3b3b5c; text-align: left; max-width: 520px; line-height: 1.5;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;">
                            <h2 style="color:#ff4444;font-size:1.4rem;margin:0;">🛡️ Bulk Delete by Tag</h2>
                            <button id="bulkDeleteCancelBtn" class="button" style="background:#232347;color:#e2e8f0;font-size:0.9rem;padding:8px 14px;">Close</button>
                        </div>
                        <p style="color:#94a3b8;font-size:0.92rem;margin:0 0 20px 0;">This tool removes <strong>every</strong> image carrying the selected tag. We require a triple check before you can delete.</p>

                        <section style="margin-bottom:18px;">
                            <h3 style="color:#8b5cf6;font-size:1rem;margin:0 0 8px 0;">Step 1 · Pick the tag you want to purge</h3>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <select id="bulkDeleteTagSelect" style="flex:1;padding:10px 12px;border-radius:8px;font-size:1rem;background:#232347;color:#e2e8f0;border:1px solid #3b3b5c;min-width:200px;">
                                    <option value="">-- Select a tag --</option>
                                </select>
                                <button id="bulkDeleteRefreshBtn" class="button" style="padding:10px 16px;font-size:0.85rem;">Refresh</button>
                            </div>
                        </section>

                        <section style="margin-bottom:20px;">
                            <div id="bulkDeletePreview" style="background:rgba(35,51,83,0.7);border:1px solid #3b3b5c;border-radius:10px;padding:14px;color:#a78bfa;font-size:0.95rem;min-height:64px;">
                                Choose a tag to preview matching items.
                            </div>
                            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                                <button id="bulkDeleteDownloadBtn" class="button" style="flex:1;min-width:180px;background:#1f2937;color:#e2e8f0;font-size:0.85rem;border:1px solid #3b3b5c;">Download preview list</button>
                                <button id="bulkDeleteCopyBtn" class="button" style="flex:1;min-width:180px;background:#1f2937;color:#e2e8f0;font-size:0.85rem;border:1px solid #3b3b5c;">Copy preview to clipboard</button>
                            </div>
                        </section>

                        <section style="margin-bottom:20px;">
                            <h3 style="color:#facc15;font-size:1rem;margin:0 0 10px 0;">Step 2 · Manual confirmation</h3>
                            <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 10px 0;">Type the tag name and the exact number of affected items. Tick the acknowledgement checkbox to unlock the delete button.</p>
                            <div style="display:grid;gap:10px;">
                                <input id="bulkDeleteTagConfirmInput" placeholder="Type the tag exactly (example: SALE)" style="padding:10px;border-radius:8px;border:1px solid #3b3b5c;background:#0f172a;color:#e2e8f0;font-size:0.95rem;" autocomplete="off">
                                <input id="bulkDeleteCountConfirmInput" type="number" min="0" placeholder="Enter the number of items with this tag" style="padding:10px;border-radius:8px;border:1px solid #3b3b5c;background:#0f172a;color:#e2e8f0;font-size:0.95rem;" autocomplete="off">
                                <label style="display:flex;align-items:flex-start;gap:10px;color:#f87171;font-size:0.85rem;background:rgba(127,29,29,0.25);border:1px solid rgba(239,68,68,0.4);border-radius:8px;padding:10px;">
                                    <input type="checkbox" id="bulkDeleteAckCheckbox" style="margin-top:3px;">
                                    <span>I understand this will <strong>permanently remove all</strong> images carrying the selected tag from Cloudflare. There is no undo.</span>
                                </label>
                            </div>
                        </section>

                        <section style="margin-bottom:16px;">
                            <h3 style="color:#4ade80;font-size:1rem;margin:0 0 10px 0;">Step 3 · Execution progress</h3>
                            <div id="bulkDeleteProgressWrap" style="display:none;background:rgba(15,23,42,0.8);border:1px solid #1e3a8a;border-radius:10px;padding:12px;">
                                <div style="height:10px;border-radius:999px;background:#1e293b;overflow:hidden;margin-bottom:8px;">
                                    <div id="bulkDeleteProgressMeter" style="height:100%;width:0%;background:linear-gradient(135deg,#ef4444,#f97316,#22c55e);transition:width 0.2s ease;"></div>
                                </div>
                                <div id="bulkDeleteProgressLabel" style="color:#a5b4fc;font-size:0.85rem;">No delete in progress.</div>
                            </div>
                        </section>

                        <section style="display:flex;flex-wrap:wrap;gap:12px;">
                            <button id="bulkDeleteConfirmBtn" class="button" style="flex:1;background:linear-gradient(135deg,#7f1d1d,#b91c1c);font-weight:700;min-width:220px;" disabled>Unlock by completing steps</button>
                            <button id="bulkDeleteResetBtn" class="button" style="background:#1f2937;color:#e2e8f0;font-size:0.85rem;border:1px solid #3b3b5c;min-width:120px;">Reset form</button>
                        </section>
                    </div>
                `;
            },

            setupEventListeners(modal) {
                const select = modal.querySelector(this.selectors.tagSelect);
                const confirmBtn = modal.querySelector(this.selectors.confirmBtn);
                const confirmInput = modal.querySelector(this.selectors.confirmInput);
                const countInput = modal.querySelector(this.selectors.countInput);
                const ackCheckbox = modal.querySelector(this.selectors.ackCheckbox);
                const downloadBtn = modal.querySelector(this.selectors.downloadBtn);
                const copyBtn = modal.querySelector(this.selectors.copyBtn);
                const refreshBtn = modal.querySelector(this.selectors.refreshBtn);
                const resetBtn = modal.querySelector(this.selectors.resetBtn);

                if (select) {
                    select.addEventListener('change', () => {
                        this.state.selectedTag = select.value;
                        this.state.typedTag = '';
                        this.state.typedCount = '';
                        this.state.acknowledged = false;
                        if (confirmInput) confirmInput.value = '';
                        if (countInput) countInput.value = '';
                        if (ackCheckbox) ackCheckbox.checked = false;
                        this.updatePreview();
                        this.validateSafetyGate();
                    });
                }

                if (confirmBtn) confirmBtn.addEventListener('click', () => this.confirmDelete());

                const modalCancel = modal.querySelector(this.selectors.cancelBtn);
                if (modalCancel) {
                    modalCancel.addEventListener('click', () => {
                        if (this.state.busy) {
                            alert('Deletion is currently running. Please wait until it completes.');
                            return;
                        }
                        this.close();
                    });
                }

                modal.addEventListener('click', (event) => {
                    if (event.target === modal && !this.state.busy) {
                        this.close();
                    }
                });

                if (confirmInput) {
                    confirmInput.addEventListener('input', (event) => {
                        this.state.typedTag = event.target.value;
                        this.validateSafetyGate();
                    });
                }

                if (countInput) {
                    countInput.addEventListener('input', (event) => {
                        this.state.typedCount = event.target.value;
                        this.validateSafetyGate();
                    });
                }

                if (ackCheckbox) {
                    ackCheckbox.addEventListener('change', (event) => {
                        this.state.acknowledged = !!event.target.checked;
                        this.validateSafetyGate();
                    });
                }

                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => this.downloadMatches());
                }

                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyMatchesToClipboard());
                }

                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.populateTagDropdown());
                }

                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (this.state.busy) {
                            alert('Cannot reset while deletion is running.');
                            return;
                        }
                        this.resetState();
                        this.populateTagDropdown();
                        this.updatePreview();
                    });
                }
            },

            populateTagDropdown() {
                const select = document.querySelector(this.selectors.tagSelect);
                if (!select) return;

                const tags = Inventory.uniqueTags();
                const previousSelection = this.state.selectedTag || select.value;

                select.innerHTML = "<option value=''>-- Select a tag --</option>";
                tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    select.appendChild(option);
                });

                if (previousSelection && tags.includes(previousSelection)) {
                    select.value = previousSelection;
                    this.state.selectedTag = previousSelection;
                } else {
                    select.value = '';
                    this.state.selectedTag = '';
                }

                if (!this.state.lockPreview) {
                    this.updatePreview();
                }
                this.validateSafetyGate();
            },

            updatePreview(messageOverride) {
                const preview = document.querySelector(this.selectors.preview);
                const tag = (this.state.selectedTag || '').trim();

                if (!preview) return;

                if (messageOverride) {
                    preview.innerHTML = messageOverride;
                    return;
                }

                if (!tag) {
                    this.state.matches = [];
                    preview.innerHTML = '<span style="color:#94a3b8;">Choose a tag to preview matching items.</span>';
                    return;
                }

                const matches = Inventory.itemsWithTag(tag);
                this.state.matches = matches;

                if (matches.length === 0) {
                    preview.innerHTML = `<span style="color:#f87171;">No items currently carry the tag <strong>${tag}</strong>. Try another tag.</span>`;
                    return;
                }

                const newestItems = matches
                    .slice()
                    .sort((a, b) => new Date(b.uploaded || 0) - new Date(a.uploaded || 0))
                    .slice(0, 5)
                    .map(item => {
                        const displayName = item.filename || item.name || item.id;
                        return `<li>${displayName} <span style="color:#64748b;">(${item.id || 'no-id'})</span></li>`;
                    })
                    .join('');

                const warningTone = matches.length >= 25
                    ? '<span style="color:#f97316;">Large deletion detected (25+ items). Double-check the tag and confirm list export before proceeding.</span>'
                    : '<span style="color:#94a3b8;">Review the sample items below before confirming.</span>';

                preview.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <strong style="color:#facc15;">${matches.length}</strong>
                            <span> item${matches.length === 1 ? '' : 's'} tagged <strong>${tag}</strong> found.</span>
                        </div>
                        <div>${warningTone}</div>
                        <div style="background:rgba(15,23,42,0.6);border:1px solid #1e3a8a;border-radius:8px;padding:10px;">
                            <div style="color:#8b5cf6;font-size:0.85rem;margin-bottom:6px;">Newest matches (up to 5)</div>
                            <ol style="margin:0;padding-left:18px;color:#e2e8f0;font-size:0.85rem;">
                                ${newestItems || '<li>No preview items available.</li>'}
                                ${matches.length > 5 ? `<li>…and ${matches.length - 5} more.</li>` : ''}
                            </ol>
                        </div>
                    </div>
                `;

                const countInput = document.querySelector(this.selectors.countInput);
                if (countInput && !this.state.busy) {
                    countInput.placeholder = `Enter total count (expected ${matches.length})`;
                }
            },

            validateSafetyGate() {
                const confirmBtn = document.querySelector(this.selectors.confirmBtn);
                if (!confirmBtn) return;

                const tag = (this.state.selectedTag || '').trim();
                const typedTag = (this.state.typedTag || '').trim();
                const typedCount = parseInt((this.state.typedCount || '').trim(), 10);
                const matchesCount = this.state.matches.length;

                const tagMatches = tag && typedTag && typedTag.toUpperCase() === tag.toUpperCase();
                const countMatches = Number.isInteger(typedCount) && typedCount === matchesCount && matchesCount > 0;
                const guardSatisfied = tagMatches && countMatches && this.state.acknowledged && !this.state.busy;

                confirmBtn.disabled = !guardSatisfied;
                confirmBtn.textContent = guardSatisfied ? `Delete ${matchesCount} item${matchesCount === 1 ? '' : 's'}` : 'Unlock by completing steps';
            },

            setBusy(isBusy, statusText) {
                this.state.busy = !!isBusy;
                if (isBusy) {
                    this.state.lockPreview = false;
                }

                const toggleElements = [
                    document.querySelector(this.selectors.tagSelect),
                    document.querySelector(this.selectors.confirmBtn),
                    document.querySelector(this.selectors.confirmInput),
                    document.querySelector(this.selectors.countInput),
                    document.querySelector(this.selectors.downloadBtn),
                    document.querySelector(this.selectors.copyBtn),
                    document.querySelector(this.selectors.refreshBtn),
                    document.querySelector(this.selectors.resetBtn),
                    document.querySelector(this.selectors.ackCheckbox)
                ];

                toggleElements.forEach(element => {
                    if (element) element.disabled = !!isBusy && element !== document.querySelector(this.selectors.cancelBtn);
                });

                if (statusText) {
                    this.updatePreview(`<span style="color:#facc15;">${statusText}</span>`);
                } else {
                    this.updatePreview();
                }

                this.validateSafetyGate();
            },

            updateProgress({ current = 0, total = 0, message = '', failures = 0 }) {
                const progressWrap = document.querySelector(this.selectors.progressWrap);
                const progressMeter = document.querySelector(this.selectors.progressMeter);
                const progressLabel = document.querySelector(this.selectors.progressLabel);

                if (!progressWrap || !progressMeter || !progressLabel) return;

                progressWrap.style.display = 'block';
                const safeTotal = total || this.state.matches.length || 1;
                const percent = Math.min(100, Math.max(0, Math.round((current / safeTotal) * 100)));
                progressMeter.style.width = `${percent}%`;

                const failureSuffix = failures ? ` | ❌ ${failures} failed` : '';
                progressLabel.textContent = message ? `${message}${failureSuffix}` : `Progress: ${current}/${safeTotal}${failureSuffix}`;
            },

            getMatchesAsText() {
                const tag = this.state.selectedTag || 'UNKNOWN_TAG';
                const lines = [
                    `Tag: ${tag}`,
                    `Total: ${this.state.matches.length}`,
                    '---'
                ];

                this.state.matches.forEach((item, index) => {
                    const name = item.filename || item.name || 'Unnamed';
                    lines.push(`${index + 1}. ${name} | ID: ${item.id || 'n/a'}`);
                });

                return lines.join('\n');
            },

            downloadMatches() {
                if (!this.state.matches.length) {
                    alert('Select a tag with items before downloading a list.');
                    return;
                }

                const blob = new Blob([this.getMatchesAsText()], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bulk-delete-preview-${(this.state.selectedTag || 'tag').toLowerCase()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                logMessage(`Downloaded bulk delete preview for tag ${this.state.selectedTag}`);
            },

            async copyMatchesToClipboard() {
                if (!navigator.clipboard) {
                    alert('Clipboard API not available in this browser. Use the download option instead.');
                    return;
                }

                if (!this.state.matches.length) {
                    alert('Select a tag with items before copying a list.');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(this.getMatchesAsText());
                    logMessage(`Copied preview for tag ${this.state.selectedTag} to clipboard.`);
                } catch (error) {
                    logError('Failed to copy preview to clipboard', error);
                    alert('Could not copy to clipboard. Try the download option.');
                }
            },

            handleProgressEvent(event) {
                const { phase, item, index = 0, total = this.state.progress.total, successCount = this.state.progress.current, error } = event || {};

                switch (phase) {
                    case 'start': {
                        this.state.progress.total = total;
                        this.state.progress.current = Math.max(0, index);
                        this.updateProgress({
                            current: this.state.progress.current,
                            total,
                            message: `Pending ${index + 1}/${total}: ${item?.filename || item?.name || item?.id}`,
                            failures: this.state.progress.failures
                        });
                        break;
                    }
                    case 'success': {
                        this.state.progress.current = successCount;
                        this.updateProgress({
                            current: successCount,
                            total,
                            message: `✅ Deleted ${successCount}/${total}: ${item?.filename || item?.name || item?.id}`,
                            failures: this.state.progress.failures
                        });
                        break;
                    }
                    case 'error': {
                        this.state.progress.failures += 1;
                        this.updateProgress({
                            current: this.state.progress.current,
                            total,
                            message: `⚠️ Failed to delete ${item?.filename || item?.name || item?.id}: ${error?.message || 'Unknown error'}`,
                            failures: this.state.progress.failures
                        });
                        break;
                    }
                    case 'complete': {
                        this.updateProgress({
                            current: successCount,
                            total,
                            message: `Finished. ${successCount} deleted, ${event.failures?.length || 0} failed.`,
                            failures: event.failures?.length || 0
                        });
                        break;
                    }
                    default:
                        break;
                }
            },

            async confirmDelete() {
                if (this.state.busy) return;

                const tag = (this.state.selectedTag || '').trim();
                if (!tag) {
                    this.updatePreview('<span style="color:#f87171;">Please choose a tag first.</span>');
                    return;
                }

                if (!this.state.matches.length) {
                    this.updatePreview('<span style="color:#f87171;">No items found for the selected tag.</span>');
                    return;
                }

                if (!this.state.acknowledged) {
                    alert('Please read and acknowledge the warning before deleting.');
                    return;
                }

                try {
                    this.setBusy(true, `Preparing to remove ${this.state.matches.length} item${this.state.matches.length === 1 ? '' : 's'} tagged "${tag}"…`);
                    this.state.progress = { total: this.state.matches.length, current: 0, failures: 0 };
                    this.updateProgress({ current: 0, total: this.state.matches.length, message: 'Starting delete sequence…' });

                    const result = await Delete.bulkByTag(tag, {
                        confirmPrompt: false,
                        onProgress: (event) => this.handleProgressEvent(event)
                    });

                    const { successCount = 0, failedCount = 0 } = result || {};
                    this.state.lockPreview = true;
                    this.setBusy(false, `<span style="color:#4ade80;">Removed ${successCount} item${successCount === 1 ? '' : 's'} tagged <strong>${tag}</strong>${failedCount ? ` (${failedCount} failed).` : '.'}</span>`);

                    if (!failedCount) {
                        setTimeout(() => {
                            this.state.lockPreview = false;
                            this.close();
                        }, 1800);
                    }
                } catch (error) {
                    logError(`Bulk delete failed for tag ${tag}`, error);
                    this.state.lockPreview = false;
                    this.setBusy(false, `<span style="color:#f87171;">${error.message}</span>`);
                }
            }
        };

        function showBulkDeletePrompt() {
            BulkDeleteUI.show();
        }

        function hideUpload() {
            const uploadSection = DOM_CACHE.uploadSection || document.getElementById('uploadSection');
            const fileInput = DOM_CACHE.fileInput || document.getElementById('fileInput');
            uploadSection.style.display = 'none';
            fileInput.value = '';
            selectedFiles = [];
            // Reset drop zone text
            const dropZoneText = document.querySelector('.drop-zone-text');
            if (dropZoneText) {
                dropZoneText.textContent = '📱 Tap to Select Photos';
            }
        }

        // File Selection Handler (with DOM cache initialization)
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM cache for better performance
            DOM_CACHE.init();
            
            const fileInput = DOM_CACHE.fileInput;
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const allFiles = Array.from(e.target.files);
                    
                    // Filter to only JPEG files
                    const jpegFiles = allFiles.filter(file => {
                        const isJpeg = file.type === 'image/jpeg' || 
                                      file.name.toLowerCase().endsWith('.jpg') || 
                                      file.name.toLowerCase().endsWith('.jpeg');
                        return isJpeg;
                    });
                    
                    const rejectedCount = allFiles.length - jpegFiles.length;
                    selectedFiles = jpegFiles;
                    
                    if (selectedFiles.length > 0) {
                        let message = `📁 ${selectedFiles.length} JPEG file(s) selected`;
                        if (rejectedCount > 0) {
                            message += ` (${rejectedCount} non-JPEG files rejected)`;
                        }
                        document.querySelector('.drop-zone-text').textContent = message;
                        logMessage(`Selected ${selectedFiles.length} JPEG files for upload${rejectedCount > 0 ? `, rejected ${rejectedCount} non-JPEG files` : ''}`);
                    } else if (allFiles.length > 0) {
                        document.querySelector('.drop-zone-text').textContent = '? Only JPEG files allowed';
                        logError('No JPEG files selected', new Error(`${allFiles.length} non-JPEG files were selected`));
                    }
                });
            }

            // Category change handler to update size options
            const categorySelect = document.getElementById('category');
            const sizeSelect = document.getElementById('size');
            
            if (categorySelect && sizeSelect) {
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    updateSizeOptions(category);
                });
            }
        });

        // Update size options based on category
        function updateSizeOptions(category) {
            const sizeSelect = document.getElementById('size');
            sizeSelect.innerHTML = '';

            if (!category) {
                sizeSelect.innerHTML = '<option value="">Select Category First</option>';
                return;
            }

            sizeSelect.innerHTML = '<option value="">Select Size</option>';

            if (category === 'BN-CLOTHES') {
                // Brand New Clothing sizes
                const clothingSizes = [
                    { value: 'XS', text: 'XS' },
                    { value: 'S', text: 'S' },
                    { value: 'M', text: 'M' },
                    { value: 'L', text: 'L' },
                    { value: 'XL', text: 'XL' }
                ];

                clothingSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });

            } else if (category === 'PO-CLOTHES') {
                // Pre-Owned Clothing sizes (includes adjacent mixed top/bottom combinations)
                const poClothingSizes = [
                    { value: 'XS', text: 'XS' },
                    { value: 'S', text: 'S' },
                    { value: 'M', text: 'M' },
                    { value: 'L', text: 'L' },
                    { value: 'XL', text: 'XL' },
                    // Mixed size combinations - Only one size up/down
                    { value: 'XS-TOP-S-BOTTOM', text: 'XS Top S Bottom' },
                    { value: 'S-TOP-XS-BOTTOM', text: 'S Top XS Bottom' },
                    { value: 'S-TOP-M-BOTTOM', text: 'S Top M Bottom' },
                    { value: 'M-TOP-S-BOTTOM', text: 'M Top S Bottom' },
                    { value: 'M-TOP-L-BOTTOM', text: 'M Top L Bottom' },
                    { value: 'L-TOP-M-BOTTOM', text: 'L Top M Bottom' },
                    { value: 'L-TOP-XL-BOTTOM', text: 'L Top XL Bottom' },
                    { value: 'XL-TOP-L-BOTTOM', text: 'XL Top L Bottom' }
                ];

                poClothingSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });

            } else if (category === 'BN-SHOES' || category === 'PO-SHOES') {
                // Shoe sizes (including half sizes for both Brand New and Pre-Owned)
                const shoeSizes = [
                    { value: 'UK-6', text: 'UK 6' },
                    { value: 'UK-6-5', text: 'UK 6.5' },
                    { value: 'UK-7', text: 'UK 7' },
                    { value: 'UK-7-5', text: 'UK 7.5' },
                    { value: 'UK-8', text: 'UK 8' },
                    { value: 'UK-8-5', text: 'UK 8.5' },
                    { value: 'UK-9', text: 'UK 9' },
                    { value: 'UK-9-5', text: 'UK 9.5' },
                    { value: 'UK-10', text: 'UK 10' },
                    { value: 'UK-10-5', text: 'UK 10.5' },
                    { value: 'UK-11', text: 'UK 11' },
                    { value: 'UK-11-5', text: 'UK 11.5' },
                    { value: 'UK-12', text: 'UK 12' }
                ];

                shoeSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.text;
                    sizeSelect.appendChild(option);
                });
            }
        }

        // =============================================================
        // 10. SMART FILENAME GENERATION
        // =============================================================
        // Functions and logic for creating smart, self-explaining filenames for uploads.
        let selectedFilenameFormat = 'auto-timestamp';

        function setFilenameFormat(format) {
            selectedFilenameFormat = format;
            
            // Update button styles
            const buttons = ['btnAutoTimestamp', 'btnCategoryFirst', 'btnClean', 'btnSimple'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.style.background = 'rgba(138, 43, 226, 0.5)';
            });
            
            // Highlight selected button
            const buttonMap = {
                'auto-timestamp': 'btnAutoTimestamp',
                'category-first': 'btnCategoryFirst', 
                'clean': 'btnClean',
                'simple': 'btnSimple'
            };
            
            const selectedBtn = document.getElementById(buttonMap[format]);
            if (selectedBtn) selectedBtn.style.background = '#8a2be2';
            
            // Update preview
            updateFilenamePreview();
        }

        function updateFilenamePreview() {
            const category = document.getElementById('category').value;
            const size = document.getElementById('size').value;
            const description = document.getElementById('itemDescription').value.trim();
            const preview = document.getElementById('filenamePreview');
            const breakdown = document.getElementById('filenameBreakdown');
            const breakdownContent = document.getElementById('breakdownContent');
            
            if (!category || !size) {
                preview.textContent = 'Select category and size to see preview';
                breakdown.style.display = 'none';
                return;
            }
            
            const generatedName = generateSmartFilename(category, size, description, selectedFilenameFormat);
            const sampleFilename = generatedName.replace('##ITEM##', '001'); // Show with sample item number
            preview.textContent = sampleFilename;
            
            // Generate breakdown
            const now = new Date();
            const dateStr = now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                           String(now.getMinutes()).padStart(2, '0');
            const batchSample = `${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${timeStr}`;
            
            let breakdownHTML = '';
            
            if (description) {
                const cleanDesc = description.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toUpperCase();
                breakdownHTML += `<span style="color: #ff6b6b;">?? DESC-${cleanDesc}</span> = Custom Description<br>`;
            }
            breakdownHTML += `<span style="color: #4ecdc4;">??? CAT-${category}</span> = Category & Condition<br>`;
            breakdownHTML += `<span style="color: #45b7d1;">?? SIZE-${size}</span> = Size Information<br>`;
            breakdownHTML += `<span style="color: #96ceb4;">?? DATE-${dateStr}</span> = Date (Today)<br>`;
            if (selectedFilenameFormat === 'auto-timestamp' && !description) {
                breakdownHTML += `<span style="color: #a8e6cf;">? TIME-${timeStr}</span> = Time (Current)<br>`;
            }
            breakdownHTML += `<span style="color: #feca57;">?? BATCH-B${batchSample}</span> = Batch ID (Auto-Generated)<br>`;
            breakdownHTML += `<span style="color: #ff9ff3;">?? ITEM-001</span> = Sequential Item Number<br>`;
            breakdownHTML += `<span style="color: #a8a8a8;">?? .jpeg</span> = File Extension`;
            
            breakdownContent.innerHTML = breakdownHTML;
            breakdown.style.display = 'block';
        }

        function generateSmartFilename(category, size, description, format) {
            const now = new Date();
            const dateStr = now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                           String(now.getMinutes()).padStart(2, '0');
            
            // Safety checks and cleaning
            category = category || 'unknown';
            size = size || 'N/A';
            const cleanDescription = description ? description.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toUpperCase() : '';
            const cleanSize = size.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-');
            
            // Get batch number from global state or generate new one
            const batchNum = window.currentBatchNumber || generateBatchNumber();
            
            let filename = '';
            
            switch (format) {
                case 'auto-timestamp':
                    // Default with key markers: DESC-CAT-SIZE-DATE-TIME-BATCH-ITEM
                    if (cleanDescription) {
                        filename = `DESC-${cleanDescription}-CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'category-first':
                    // Category first with markers: CAT-SIZE-DESC-DATE-BATCH-ITEM
                    if (cleanDescription) {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DESC-${cleanDescription}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'clean':
                    // Clean underscores format with markers
                    if (cleanDescription) {
                        filename = `SBS_DESC_${cleanDescription.replace('-', '_')}_CAT_${category.replace('-', '_')}_SIZE_${cleanSize.replace('-', '_')}_DATE_${dateStr}_BATCH_B${batchNum}_ITEM_##ITEM##.jpeg`;
                    } else {
                        filename = `SBS_CAT_${category.replace('-', '_')}_SIZE_${cleanSize.replace('-', '_')}_DATE_${dateStr}_TIME_${timeStr}_BATCH_B${batchNum}_ITEM_##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'simple':
                    // Simple format with basic markers
                    filename = `SBS-BATCH-B${batchNum}-ITEM-##ITEM##-DATE-${dateStr}-TIME-${timeStr}.jpeg`;
                    break;
                    
                default:
                    filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
            }
            
            return filename;
        }

        // Generate unique batch number based on timestamp
        function generateBatchNumber() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            
            // Format: MMDDHHMM (e.g., 09251430 for Sept 25, 2:30 PM)
            const batchNumber = `${month}${day}${hour}${minute}`;
            
            // Store globally for this upload session
            window.currentBatchNumber = batchNumber;
            
            return batchNumber;
        }

        // Reset batch number for new upload session
        function startNewUploadBatch() {
            window.currentBatchNumber = generateBatchNumber();
            window.currentItemNumber = 0; // Reset item counter
            logMessage(`?? Started new upload batch: B${window.currentBatchNumber}`);
        }

        // Add event listeners to update preview when inputs change
        function setupFilenamePreviewListeners() {
            const inputs = ['category', 'size', 'itemDescription'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('change', updateFilenamePreview);
                    element.addEventListener('input', updateFilenamePreview);
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupFilenamePreviewListeners();
            setFilenameFormat('auto-timestamp'); // Set default format
        });

        // =============================================================
        // 11. UPLOAD PROCESS
        // =============================================================
        // Functions and logic for handling the upload of photos, including progress tracking and error handling.
        // Complete Upload Process
        async function processUpload() {
            const category = document.getElementById('category').value;
            const size = document.getElementById('size').value;
            const siteSection = document.getElementById('siteSection').value;
            const additionalTag = document.getElementById('additionalTag').value;
            const description = document.getElementById('itemDescription').value.trim();

            if (selectedFiles.length === 0) {
                logError('No files selected', new Error('Please select files first'));
                alert('? Please select files first');
                return;
            }

            if (!category || !size) {
                logError('Missing category or size', new Error(`Category: ${category}, Size: ${size}`));
                alert('? Please select Category & Size');
                return;
            }

            logMessage(`=== STARTING UPLOAD BATCH ===`);
            
            // Start new batch with unique batch number
            startNewUploadBatch();
            
            logMessage(`?? Batch Number: B${window.currentBatchNumber}`);
            logMessage(`?? Files to upload: ${selectedFiles.length}`);
            logMessage(`??? Category: ${category}, Size: ${size}`);
            logMessage(`?? Site Section: ${siteSection}${additionalTag ? `, Additional Tag: ${additionalTag}` : ''}`);

            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            progressText.textContent = `Starting batch B${window.currentBatchNumber} - ${selectedFiles.length} files...`;

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const progress = ((i + 1) / selectedFiles.length) * 100;
                const itemNum = String(i + 1).padStart(3, '0');
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `Batch B${window.currentBatchNumber} - Item ${itemNum}: ${file.name}`;

                logMessage(`--- Batch B${window.currentBatchNumber} - Processing Item ${itemNum}/${selectedFiles.length}: ${file.name} ---`);

                try {
                    // Step 1: Upload image to Cloudflare via our proxy
                    const uploadResult = await uploadToCloudflare(file, category, size, siteSection, additionalTag);
                    
                    if (uploadResult.success) {
                        const batchNum = window.currentBatchNumber || 'NOBATCH';
                        const sequenceNum = String(window.currentItemNumber).padStart(3, '0');
                        const cloudflareId = uploadResult.id || uploadResult.rawResult?.result?.id || null;
                        const resolvedVariants = Array.isArray(uploadResult.variants) && uploadResult.variants.length > 0
                            ? uploadResult.variants
                            : (uploadResult.rawResult?.result?.variants || []);
                        const fallbackImage = cloudflareId
                            ? `https://imagedelivery.net/${API_CONFIG.accountHash}/${cloudflareId}/w=1920,h=1080`
                            : '';
                        const imageUrl = resolvedVariants.length > 0 ? resolvedVariants[0] : fallbackImage;
                        const mergedMeta = {
                            ...((uploadResult.meta && typeof uploadResult.meta === 'object') ? uploadResult.meta : {}),
                            description: uploadResult.description ?? description ?? ''
                        };

                        if (!cloudflareId) {
                            logError('Cloudflare upload result missing ID', new Error(JSON.stringify(uploadResult.rawResult || {})));
                            throw new Error('Cloudflare upload result did not include an image ID.');
                        }

                        logMessage(`✅ Cloudflare upload successful. Image ID: ${cloudflareId}`, 'success');

                        const newItem = {
                            id: cloudflareId,
                            name: uploadResult.filename || file.name,
                            filename: uploadResult.filename || file.name,
                            cloudflareId: cloudflareId,
                            uploaded: uploadResult.uploaded || new Date().toISOString(),
                            variants: resolvedVariants,
                            meta: mergedMeta,
                            tags: [category, size, siteSection, additionalTag, 'BATCH-' + batchNum, 'ITEM-' + sequenceNum].filter(Boolean),
                            category: category,
                            size: size,
                            batchNumber: batchNum,
                            itemNumber: sequenceNum,
                            siteSection: siteSection,
                            description: mergedMeta.description,
                            status: 'available',
                            image: imageUrl || fallbackImage || ''
                        };

                        logMessage(`✅ Item created from Cloudflare data. Image ready for display.`, 'success');
                        inventory.unshift(newItem); // Add to the top of the local array
                        successCount++;
                        
                    } else {
                        throw new Error(uploadResult.error || 'Cloudflare upload failed but did not throw an error.');
                    }

                } catch (error) {
                    failCount++;
                    logError(`? Upload process failed for ${file.name}`, error);
                    progressText.textContent = `? Error: ${error.message}`;
                    // Wait a moment before continuing
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            logMessage(`=== BATCH B${window.currentBatchNumber} COMPLETED ===`);
            logMessage(`?? Batch: B${window.currentBatchNumber}`);
            logMessage(`?? Total files: ${selectedFiles.length}, Successful: ${successCount}, Failed: ${failCount}`);
            logMessage(`?? All items in this batch have sequential numbering 001-${String(selectedFiles.length).padStart(3, '0')}`);

            progressText.textContent = `? Batch B${window.currentBatchNumber} Complete! ${successCount} successful, ${failCount} failed`;
            displayInventory(); // Refresh the display with the new item

            // Keep upload section open - just hide progress after delay
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
            }, CONFIG.LOG_DOWNLOAD_DELAY);
        }

        // Function to update item tags in the database
        async function updateItemTags(itemId, newTags) {
            const response = await fetch(`${API_CONFIG.proxyUrl}/items/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: newTags })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to update item tags: ${errorText}`);
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(`API Error on tag update: ${result.error}`);
            }
            
            return result.item;
        }

        // New function to create item record in our database
        async function createItemInDB(uploadResult, category, size, siteSection, additionalTag) {
            logMessage(`Creating database entry for ${uploadResult.filename}...`);

            const tags = ['LIVE', siteSection.toUpperCase()];
            if (additionalTag) {
                tags.push(additionalTag.toUpperCase());
            }

            const itemPayload = {
                cloudflareId: uploadResult.id,
                filename: uploadResult.filename,
                name: uploadResult.filename, // Use filename as name for now
                category: category,
                size: size,
                tags: tags,
                status: 'available', // Default status
                notes: ''
            };

            const response = await fetch(`${API_CONFIG.proxyUrl}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemPayload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to create item in DB: ${errorText}`);
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(`API Error on item creation: ${result.error}`);
            }
            
            // Return the complete item object from the server (includes id, createdAt, etc.)
            return {
                ...result.item,
                image: `https://imagedelivery.net/${API_CONFIG.accountHash}/${result.item.cloudflareId}/w=1080,h=1920`
            };
        }


        // Upload to Cloudflare Function with smart filename + metadata handling
        async function uploadToCloudflare(file, category, size, siteSection, additionalTag) {
            logMessage(`Starting Cloudflare upload for: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            // Safety checks for undefined parameters
            category = category || 'unknown';
            size = size || 'N/A';

            const description = document.getElementById('itemDescription').value.trim();

            // Increment item number for this upload session
            window.currentItemNumber = (window.currentItemNumber || 0) + 1;
            const itemNum = String(window.currentItemNumber).padStart(3, '0');

            // Generate smart filename template
            const filenameTemplate = generateSmartFilename(category, size, description, selectedFilenameFormat);
            const filename = filenameTemplate.replace('##ITEM##', itemNum);

            const batchNum = window.currentBatchNumber || 'NOBATCH';

            logMessage(`📦 Batch: B${batchNum}, Item: ${itemNum}/${selectedFiles.length}`);
            logMessage(`🏷️ Generated smart filename: ${filename}`);
            if (description) {
                logMessage(`📝 Custom description: "${description}"`);
            }

            // Create new file object with custom filename
            const customFile = new File([file], filename, {
                type: file.type || 'image/jpeg',
                lastModified: file.lastModified
            });

            const formData = new FormData();
            formData.append('file', customFile, filename);

            const metadata = {
                filename: filename,
                alt: `SBS ${category.replace('-', ' ')} Size ${size}${description ? ` - ${description}` : ''} (Batch ${batchNum} Item ${itemNum})`,
                caption: `${category.replace('-', ' ')} Size ${size}${description ? ` - ${description}` : ''} - Batch ${batchNum} Item ${itemNum} - Auto-uploaded via SBS Media Hub`,
                tags: [category, size, siteSection, additionalTag, 'BATCH-' + batchNum, 'ITEM-' + itemNum].filter(Boolean).join(','),
                category: category,
                size: size,
                batchNumber: batchNum,
                itemNumber: itemNum,
                siteSection: siteSection,
                description: description || '',
                uploadDate: new Date().toISOString().split('T')[0],
                uploadTime: new Date().toTimeString().split(' ')[0]
            };

            formData.append('metadata', JSON.stringify(metadata));
            logMessage(`📊 Enhanced metadata with smart naming: ${JSON.stringify(metadata)}`);

            const apiUrl = `${API_CONFIG.proxyUrl}/images`;
            logMessage(`🔄 Proxying upload with custom filename to: ${apiUrl}`);

            let response;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });
            } catch (networkError) {
                logError('Network error during Cloudflare upload proxy call', networkError);
                throw new Error(`Network error during upload: ${networkError.message}`);
            }

            logMessage(`📡 Proxy response status: ${response.status} ${response.statusText}`);

            const responseText = await response.text();
            let parsedResponse = null;
            if (responseText) {
                try {
                    parsedResponse = JSON.parse(responseText);
                } catch (parseError) {
                    logError('Failed to parse Cloudflare upload response JSON', parseError);
                }
            }

            if (!response.ok) {
                const errorMsg = parsedResponse?.error || parsedResponse?.errors?.[0]?.message || responseText || response.statusText || 'Unknown upload error';
                logError(`API Error Response (${response.status})`, new Error(errorMsg));
                throw new Error(`Upload failed: ${errorMsg}`);
            }

            if (!parsedResponse) {
                throw new Error('Upload proxy did not return a JSON response.');
            }

            if (!parsedResponse.success) {
                const errorMsg = parsedResponse.errors?.[0]?.message || parsedResponse.error || 'Cloudflare returned success=false';
                logError('Cloudflare API returned success=false', new Error(errorMsg));
                throw new Error(`Cloudflare API error: ${errorMsg}`);
            }

            const result = parsedResponse.result || {};
            logMessage(`✅ Cloudflare API Success Response: ${JSON.stringify(result)}`);

            return {
                success: true,
                id: result.id || result.uid || null,
                filename: filename,
                variants: result.variants || [],
                meta: result.meta || {},
                uploaded: result.uploaded || null,
                description: description || '',
                rawResult: parsedResponse
            };
        }

    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📸 SBS Media Hub</h1>
            <p class="subtitle">Simple Photo Browser</p>
            <button class="button" onclick="showHelp()" style="position: absolute; top: 20px; right: 20px; padding: 8px 12px; font-size: 14px;">❓ Help</button>
        </div>

        <!-- Controls -->
        <div class="controls">
            <!-- Upload Button -->
            <button class="button" onclick="showUpload()" style="margin-bottom: 20px;">📤 Upload Photos</button>
            <button class="button" onclick="BulkDeleteUI.show()" style="margin-bottom: 20px; background: linear-gradient(135deg, #ff4444, #a259ff);">🗑️ Bulk Delete by Tag</button>
            
                <!-- 📋 ACTIVITY LOG: Shows what's happening in simple words -->
                <div id="activityLogPanel" style="
                    background: #1e293b;
                    border: 1.5px solid #8b5cf6;
                    border-radius: 12px;
                    padding: 14px 16px;
                    margin-bottom: 22px;
                    color: #e2e8f0;
                    font-size: 15px;
                    max-height: 140px;
                    overflow-y: auto;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    box-shadow: 0 2px 8px rgba(139,92,246,0.07);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #8b5cf6; letter-spacing: 0.5px;">📋 Activity Log</span>
                        <button onclick="Utils.toggleLogs()" style="
                            background: #8b5cf6;
                            color: #fff;
                            border: none;
                            border-radius: 7px;
                            padding: 4px 12px;
                            font-size: 13px;
                            cursor: pointer;
                            font-weight: 500;">Show/Hide</button>
                    </div>
                    <div id="logContent" style="
                        background: #0f172a;
                        border-radius: 7px;
                        padding: 8px 10px;
                        min-height: 48px;
                        border: 1px solid #334155;
                        font-size: 14px;
                        color: #e2e8f0;
                        font-family: 'Consolas', 'Menlo', monospace;
                        white-space: pre-line;
                        overflow-y: auto;
                    "></div>
                </div>

            <!-- Main Browse Button -->
            <div style="margin-bottom: 15px;">
                <button class="button active" id="allBtn" onclick="loadImagesAndShowSection('all')" style="font-size: 18px; width: 100%; background: linear-gradient(135deg, #06d6a0, #118ab2); box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);">
                    🔍 Browse Photos
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 2px;">Click to start</div>
                </button>
            </div>

            <!-- Filter Categories -->
            <div style="background: linear-gradient(135deg, #181824 60%, #232347 100%); border: 2px solid #8b5cf6; border-radius: 12px; padding: 15px;">
                <h5 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 14px;">📂 Sort Photos</h5>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <button onclick="quickFilter('new')" class="filter-btn" data-filter="new" style="
                            padding: 14px 18px; 
                            background: linear-gradient(135deg, #22c55e, #16a34a); 
                            border: none; 
                            color: white; 
                            border-radius: 15px; 
                            font-size: 15px; 
                            cursor: pointer; 
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
                            font-weight: 600;
                        ">
                            🆕 New Photos
                            <div style="font-size: 11px; opacity: 0.95; margin-top: 3px;">Recent</div>
                        </button>
                        
                        <button onclick="quickFilter('sale')" class="filter-btn" data-filter="sale" style="
                            padding: 14px 18px; 
                            background: linear-gradient(135deg, #232347 60%, #a259ff 100%); 
                            border: 1px solid #a259ff; 
                            color: #fff; 
                            border-radius: 15px; 
                            font-size: 15px; 
                            cursor: pointer; 
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(162, 89, 255, 0.2);
                            font-weight: 600;
                        ">
                            🏷️ Sale Items
                            <div style="font-size: 11px; opacity: 0.95; margin-top: 3px;">On Sale</div>
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button onclick="quickFilter('general')" class="filter-btn" data-filter="general" style="
                            padding: 14px 18px; 
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
                            border: none; 
                            color: white; 
                            border-radius: 15px; 
                            font-size: 15px; 
                            cursor: pointer; 
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
                            font-weight: 600;
                        ">
                            📷 All Photos
                            <div style="font-size: 11px; opacity: 0.95; margin-top: 3px;">Everything</div>
                        </button>
                        
                        <button onclick="clearAllFilters()" style="
                            padding: 14px 18px; 
                            background: linear-gradient(135deg, #232347 60%, #3b3b5c 100%); 
                            border: 1px solid #3b3b5c; 
                            color: #fff; 
                            border-radius: 15px; 
                            font-size: 15px; 
                            cursor: pointer; 
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(59, 59, 92, 0.2);
                            font-weight: 600;
                        ">
                            🔄 Reset
                            <div style="font-size: 11px; opacity: 0.95; margin-top: 3px;">Start Over</div>
                        </button>
                    </div>




                <p style="color: #94a3b8; font-size: 12px; margin-top: 10px; text-align: center;">👆 Click any button to sort your photos</p>
            </div>

            <div id="status" style="margin-top: 15px; color: #00ff41; font-weight: bold;"></div>
            
            <!-- COMPARISON SUMMARY REMOVED - keeping it simple -->
        </div>

        <!-- Inventory Display -->
        <div id="inventoryContainer">
            <div class="loading">
                👆 Click "🔍 Browse Photos" button above to see your photos
            </div>
        </div>

        <!-- Simplified Upload Section for iPhone -->
        <div id="uploadSection" style="display: none; background: rgba(15, 15, 35, 0.9); border: 2px solid #D4AF37; border-radius: 15px; padding: 20px; margin-top: 20px;">
            <h2 style="color: #D4AF37; text-align: center; margin-bottom: 20px; font-size: 20px;">📤 Upload Photos</h2>
            
            <!-- Simplified Drop Zone -->
            <div id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 48px; margin-bottom: 10px;">📱</div>
                <div class="drop-zone-text" style="color: #D4AF37; font-size: 18px; margin-bottom: 10px; font-weight: 600;">Tap to Select Photos</div>
                <div style="color: #00ff41; font-size: 14px;">JPEG files only</div>
            </div>
            
            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,image/jpeg" style="display: none;">
            
            <!-- Mobile-optimized form -->
            <div style="margin-bottom: 20px;">
                <label style="color: #D4AF37; display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">Category & Condition:</label>
                <select id="category" style="width: 100%; padding: 15px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 12px; color: #00ff41; font-size: 16px; min-height: 44px;">
                    <option value="">Choose category...</option>
                    <option value="BN-CLOTHES">?? New Clothes</option>
                    <option value="BN-SHOES">?? New Shoes</option>
                    <option value="PO-CLOTHES">?? Pre-owned Clothes</option>
                    <option value="PO-SHOES">?? Pre-owned Shoes</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="color: #D4AF37; display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">Size:</label>
                <select id="size" style="width: 100%; padding: 15px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 12px; color: #00ff41; font-size: 16px; min-height: 44px;">
                    <option value="">Select category first</option>
                </select>
            </div>

            <!-- Smart Filename Generator -->
            <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid #8a2be2; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #8a2be2; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                    ? Auto Smart Naming
                    <span style="font-size: 12px; color: #00ff41; background: rgba(0, 255, 65, 0.1); padding: 3px 8px; border-radius: 12px;">Automatic Timestamp + Tags</span>
                </h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Optional Description (leave blank for auto-naming):</label>
                    <input type="text" id="itemDescription" placeholder="Optional: Nike Air Max, Adidas Hoodie... (leave blank for timestamp only)" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #8a2be2; border-radius: 8px; color: #00ff41;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Filename Format:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="button" onclick="setFilenameFormat('auto-timestamp')" id="btnAutoTimestamp" style="font-size: 11px; background: #8a2be2;">? Auto (Timestamp)</button>
                        <button class="button" onclick="setFilenameFormat('category-first')" id="btnCategoryFirst" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">??? Category First</button>
                        <button class="button" onclick="setFilenameFormat('clean')" id="btnClean" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">? Clean Format</button>
                        <button class="button" onclick="setFilenameFormat('simple')" id="btnSimple" style="font-size: 11px; background: rgba(138, 43, 226, 0.5);">?? Simple</button>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: #8a2be2; display: block; margin-bottom: 5px;">Preview Generated Name:</label>
                    <div id="filenamePreview" style="background: rgba(0, 0, 0, 0.3); border: 1px solid #8a2be2; padding: 12px; border-radius: 8px; color: #8a2be2; font-family: monospace; font-weight: bold; min-height: 20px;">Select category and size to see preview</div>
                    
                    <div id="filenameBreakdown" style="background: rgba(0, 0, 0, 0.2); border: 1px solid #666; border-radius: 8px; padding: 10px; margin-top: 8px; font-size: 11px; display: none;">
                        <div style="color: #aaa; margin-bottom: 5px;">?? Component Breakdown:</div>
                        <div id="breakdownContent" style="line-height: 1.6;"></div>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; border-radius: 8px; padding: 12px;">
                    <h4 style="color: #ffff00; margin: 0 0 10px 0;">?? Self-Explaining Filename Examples:</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                        <li><strong>Auto (Default):</strong> CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-TIME-1430-BATCH-B09251430-ITEM-001.jpeg</li>
                        <li><strong>With Description:</strong> DESC-Nike-Air-Max-CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-BATCH-B09251430-ITEM-001.jpeg</li>
                        <li><strong>Category First:</strong> CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-TIME-1430-BATCH-B09251430-ITEM-002.jpeg</li>
                        <li><strong>Simple:</strong> SBS-BATCH-B09251430-ITEM-003-DATE-20250925-TIME-1430.jpeg</li>
                    </ul>
                    
                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h5 style="color: #ffff00; margin: 0 0 10px 0;">?? Self-Explaining Component Guide:</h5>
                        <div style="font-family: monospace; font-size: 13px; line-height: 1.8;">
                            <div style="color: #8a2be2;">DESC-Nike-Air-Max-CAT-BN-SHOES-SIZE-UK-9-DATE-20250925-BATCH-B09251430-ITEM-001.jpeg</div>
                            <div style="margin-top: 8px; font-size: 11px;">
                                <span style="color: #ff6b6b;">?? DESC-Nike-Air-Max</span> = Custom Description (Optional)<br>
                                <span style="color: #4ecdc4;">??? CAT-BN-SHOES</span> = Category & Condition<br>
                                <span style="color: #45b7d1;">?? SIZE-UK-9</span> = Size Information<br>
                                <span style="color: #96ceb4;">?? DATE-20250925</span> = Date (YYYYMMDD)<br>
                                <span style="color: #feca57;">?? BATCH-B09251430</span> = Batch ID (MMDDHHMM)<br>
                                <span style="color: #ff9ff3;">?? ITEM-001</span> = Sequential Item Number<br>
                                <span style="color: #a8a8a8;">?? .jpeg</span> = File Extension
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 0, 0.1); border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <p style="color: #ffff00; margin: 0; font-size: 11px;"><strong>?? Key Benefits:</strong> Each filename is completely self-explaining! You can instantly identify DESC (description), CAT (category), SIZE, DATE, BATCH, and ITEM just by looking at the filename.</p>
                        </div>
                    </div>
                    
                    <p style="color: #ffff00; margin: 8px 0 0 0; font-size: 11px;"><strong>?? Marker System:</strong> Every component has a clear prefix so you know exactly what each part means!</p>
                </div>
            </div>

            <!-- Admin Test Controls -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: #D4AF37; display: block; margin-bottom: 5px;">Site Section Tag:</label>
                    <select id="siteSection" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                        <option value="featured">?? Featured Section</option>
                        <option value="sale">?? Sale Section</option>
                        <option value="new">? New Arrivals</option>
                        <option value="trending">?? Trending</option>
                        <option value="staff-picks">? Staff Picks</option>
                    </select>
                </div>
                
            <!-- Additional Settings (simplified) -->
            <div style="margin-bottom: 20px;">
                <label style="color: #D4AF37; display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">Section:</label>
                <select id="siteSection" style="width: 100%; padding: 15px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 12px; color: #00ff41; font-size: 16px; min-height: 44px;">
                    <option value="LIVE">?? Live</option>
                    <option value="FEATURED">? Featured</option>
                    <option value="SALE">?? Sale</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="color: #D4AF37; display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">Description (Optional):</label>
                <input type="text" id="itemDescription" placeholder="e.g., Nike Air Max, Red Dress..." style="width: 100%; padding: 15px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 12px; color: #00ff41; font-size: 16px; min-height: 44px;">
            </div>

            <div style="display: none;">
                <select id="additionalTag" style="width: 100%; padding: 10px; background: rgba(26, 26, 46, 0.9); border: 2px solid #D4AF37; border-radius: 8px; color: #00ff41;">
                    <option value="">None</option>
                    <option value="limited">? Limited Stock</option>
                    <option value="bestseller">?? Bestseller</option>
                    <option value="premium">?? Premium</option>
                    <option value="clearance">??? Clearance</option>
                </select>
            </div>
            
            <!-- Simplified upload buttons for iPhone -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="button" onclick="processUpload()" style="background: #00ff41; color: #000; font-size: 18px; padding: 18px 30px; margin-bottom: 15px; width: 100%; border-radius: 12px;">
                    ?? Upload Photos
                </button>
                <button class="button" onclick="hideUpload()" style="background: #666; font-size: 16px; padding: 12px 20px; border-radius: 12px;">
                    ? Cancel
                </button>
            </div>
            <div id="uploadProgress" style="margin-top: 20px; display: none;">
                <div style="background: rgba(26, 26, 46, 0.9); border-radius: 8px; padding: 15px;">
                    <div id="progressBar" style="width: 0%; height: 20px; background: linear-gradient(90deg, #D4AF37, #00ff41); border-radius: 10px; transition: width 0.3s ease;"></div>
                    <div id="progressText" style="color: #00ff41; text-align: center; margin-top: 10px;">Preparing upload...</div>
                </div>
            </div>
            
            <!-- Log Viewer -->
            <div id="logViewer" style="display: none; margin-top: 20px; background: rgba(0, 0, 0, 0.8); border-radius: 8px; padding: 15px;">
                <div style="color: #D4AF37; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <span>?? Upload Logs</span>
                    <button onclick="Utils.clearLogs()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">Clear Logs</button>
                </div>
                <div id="logContent" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4; color: #00ff41; white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15, 15, 35, 0.95); border: 2px solid #D4AF37; border-radius: 20px; padding: 30px; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #D4AF37; margin: 0;">? How to Use SBS Media Hub</h2>
                <button onclick="hideHelp()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;">?</button>
            </div>
            
            <div style="color: #00ff41; line-height: 1.6; font-size: 14px;">
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Security & Setup</h3>
                <p><strong>Important:</strong> This system now uses a secure API proxy for enhanced security.</p>
                <p><strong>Before using:</strong> Run <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"START-API-PROXY.bat"</span> to start the proxy server on port 3001.</p>
                <p>All API tokens are now stored server-side for security - no sensitive data in the browser!</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Loading Your Images</h3>
                <p><strong>Step 1:</strong> Click the <span style="background: rgba(139, 92, 246, 0.2); padding: 2px 6px; border-radius: 4px;">"? Quick Browse"</span> button to browse all your images from Cloudflare.</p>
                <p>This will load your inventory and display it in the grid view automatically.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? View Controls</h3>
                <p><strong>Grid View:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"?? Grid View"</span> to switch to the grid layout (default view).</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">??? Filtering by Tags</h3>
                <p><strong>Tag Dropdown:</strong> Use the dropdown menu to filter items by specific tags:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>?? Featured - Highlighted items</li>
                    <li>?? Sale - Items on sale</li>
                    <li>? New Arrivals - Recently added items</li>
                    <li>?? Trending - Popular items</li>
                    <li>? Staff Picks - Recommended by staff</li>
                    <li>? Limited Stock - Low inventory items</li>
                    <li>?? Bestseller - Top selling items</li>
                    <li>?? Premium - High-end items</li>
                    <li>??? Clearance - Discounted items</li>
                </ul>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Uploading New Images</h3>
                <p><strong>Upload Images:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"?? Upload Images"</span> to add new images to your Cloudflare account.</p>
                <p>Select category, size, and tags before uploading JPEG files.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Quick Start Guide</h3>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Click "? Quick Browse" to browse your inventory</li>
                    <li>Use the tag dropdown to filter specific items</li>
                    <li>Switch views using the "?? Grid View" button</li>
                    <li>Upload new items with "?? Upload Images"</li>
                </ol>

                <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <p style="color: #ffff00; margin: 0;"><strong>?? Tip:</strong> Always load your items first before using filters or view controls!</p>
                </div>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Recent Changes & Progress Tracker</h3>
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 1 - Clean Page (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Modernized upload controls (removed "test" terminology)</li>
                        <li><span style="color: #00ff41;">?</span> Added system font theme and iPhone-first design</li>
                        <li><span style="color: #00ff41;">?</span> Implemented in-app help system with progress tracking</li>
                        <li><span style="color: #00ff41;">?</span> Cleaned up legacy test controls while keeping functionality</li>
                    </ul>
                </div>
                
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 2 - API Proxy Security (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Created PowerShell API proxy server (api-proxy-server.ps1)</li>
                        <li><span style="color: #00ff41;">?</span> Added START-API-PROXY.bat for easy server startup</li>
                        <li><span style="color: #00ff41;">?</span> Removed all API tokens from client-side code</li>
                        <li><span style="color: #00ff41;">?</span> Updated all API calls to use secure proxy</li>
                        <li><span style="color: #00ff41;">?</span> Enhanced security with server-side token storage</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 3 - Tag Filtering System (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Replaced individual filter buttons with dropdown</li>
                        <li><span style="color: #00ff41;">?</span> Added comprehensive tag options (Featured, Sale, New, etc.)</li>
                        <li><span style="color: #00ff41;">?</span> Implemented filterByTag() function for dropdown filtering</li>
                        <li><span style="color: #00ff41;">?</span> Created loadImagesAndShowSection() for combined operations</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 4 - Help System Implementation (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Added "? Help" button in header</li>
                        <li><span style="color: #00ff41;">?</span> Created comprehensive help modal with step-by-step guides</li>
                        <li><span style="color: #00ff41;">?</span> Documented all features and new functionality</li>
                        <li><span style="color: #00ff41;">?</span> Added progress tracker for transparency</li>
                    </ul>
                </div>

                <div style="background: rgba(46, 26, 26, 0.9); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">? Next Planned Steps (From Build Plan)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #ff8800;">?</span> Step 5 - Items API (JSON store + CRUD + audit)</li>
                        <li><span style="color: #ff8800;">?</span> Step 6 - Grid with View More 9 (virtualization)</li>
                        <li><span style="color: #ff8800;">?</span> Step 7 - Constants Wired (preset validation)</li>
                        <li><span style="color: #ff8800;">?</span> Step 8 - Bulk Selection Model (select all filtered)</li>
                        <li><span style="color: #ff8800;">?</span> Step 9 - Bulk Actions System (add/remove tags, set status)</li>
                    </ul>
                </div>

                <div style="background: rgba(35, 35, 15, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 10px; margin: 15px 0 5px 0; text-align: center;">
                    <p style="color: #D4AF37; margin: 0; font-size: 12px;"><strong>?? Feedback Welcome:</strong> Each step will be documented here for review and iteration</p>
                </div>

                <!-- LOCAL STORAGE & SYSTEM INSPECTOR -->
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? System Inspector & Local Storage</h3>
                
                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">?? Current System Status</h4>
                    <div id="systemStatusInspector" style="font-family: monospace; font-size: 12px; color: #00ff41;">
                        <div>Loading system status...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">?? Local Storage Contents</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Diagnostics.refreshLocalStorage()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Refresh</button>
                        <button onclick="Diagnostics.clearAllLocalStorage()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">??? Clear All</button>
                    </div>
                    <div id="localStorageInspector" style="font-family: monospace; font-size: 11px; color: #ff8800; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Refresh" to view local storage contents...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #8a2be2; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #8a2be2; margin: 0 0 10px 0;">?? Live Activity Log</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Diagnostics.refreshActivityLog()" style="background: #8a2be2; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Refresh</button>
                        <button onclick="Diagnostics.downloadLogs()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">?? Download Logs</button>
                    </div>
                    <div id="activityLogInspector" style="font-family: monospace; font-size: 11px; color: #8a2be2; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Activity log will appear here...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #D4AF37; margin: 0 0 10px 0;">?? Database Connection Test</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Database.testConnection()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Test Connection</button>
                        <button onclick="Database.viewStats()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">?? View Stats</button>
                    </div>
                    <div id="databaseTestResult" style="font-family: monospace; font-size: 11px; color: #D4AF37; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Test Connection" to check database status...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15, 15, 35, 0.95); border: 2px solid #D4AF37; border-radius: 20px; padding: 30px; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #D4AF37; margin: 0;">? How to Use SBS Media Hub</h2>
                <button onclick="hideHelp()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;">?</button>
            </div>
            
            <div style="color: #00ff41; line-height: 1.6; font-size: 14px;">
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Security & Setup</h3>
                <p><strong>Important:</strong> This system now uses a secure API proxy for enhanced security.</p>
                <p><strong>Before using:</strong> Run <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"START-API-PROXY.bat"</span> to start the proxy server on port 3001.</p>
                <p>All API tokens are now stored server-side for security - no sensitive data in the browser!</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Loading Your Images</h3>
                <p><strong>Step 1:</strong> Click the <span style="background: rgba(139, 92, 246, 0.2); padding: 2px 6px; border-radius: 4px;">"? Quick Browse"</span> button to browse all your images from Cloudflare.</p>
                <p>This will load your inventory and display it in the grid view automatically.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? View Controls</h3>
                <p><strong>Grid View:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"?? Grid View"</span> to switch to the grid layout (default view).</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">??? Filtering by Tags</h3>
                <p><strong>Tag Dropdown:</strong> Use the dropdown menu to filter items by specific tags:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>?? Featured - Highlighted items</li>
                    <li>?? Sale - Items on sale</li>
                    <li>? New Arrivals - Recently added items</li>
                    <li>?? Trending - Popular items</li>
                    <li>? Staff Picks - Recommended by staff</li>
                    <li>? Limited Stock - Low inventory items</li>
                    <li>?? Bestseller - Top selling items</li>
                    <li>?? Premium - High-end items</li>
                    <li>??? Clearance - Discounted items</li>
                </ul>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Uploading New Images</h3>
                <p><strong>Upload Images:</strong> Click <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"?? Upload Images"</span> to add new images to your Cloudflare account.</p>
                <p>Select category, size, and tags before uploading JPEG files.</p>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Quick Start Guide</h3>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Click "? Quick Browse" to browse your inventory</li>
                    <li>Use the tag dropdown to filter specific items</li>
                    <li>Switch views using the "?? Grid View" button</li>
                    <li>Upload new items with "?? Upload Images"</li>
                </ol>

                <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <p style="color: #ffff00; margin: 0;"><strong>?? Tip:</strong> Always load your items first before using filters or view controls!</p>
                </div>

                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Recent Changes & Progress Tracker</h3>
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 1 - Clean Page (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Modernized upload controls (removed "test" terminology)</li>
                        <li><span style="color: #00ff41;">?</span> Added system font theme and iPhone-first design</li>
                        <li><span style="color: #00ff41;">?</span> Implemented in-app help system with progress tracking</li>
                        <li><span style="color: #00ff41;">?</span> Cleaned up legacy test controls while keeping functionality</li>
                    </ul>
                </div>
                
                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 2 - API Proxy Security (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Created PowerShell API proxy server (api-proxy-server.ps1)</li>
                        <li><span style="color: #00ff41;">?</span> Added START-API-PROXY.bat for easy server startup</li>
                        <li><span style="color: #00ff41;">?</span> Removed all API tokens from client-side code</li>
                        <li><span style="color: #00ff41;">?</span> Updated all API calls to use secure proxy</li>
                        <li><span style="color: #00ff41;">?</span> Enhanced security with server-side token storage</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 3 - Tag Filtering System (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Replaced individual filter buttons with dropdown</li>
                        <li><span style="color: #00ff41;">?</span> Added comprehensive tag options (Featured, Sale, New, etc.)</li>
                        <li><span style="color: #00ff41;">?</span> Implemented filterByTag() function for dropdown filtering</li>
                        <li><span style="color: #00ff41;">?</span> Created loadImagesAndShowSection() for combined operations</li>
                    </ul>
                </div>

                <div style="background: rgba(26, 26, 46, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">? Step 4 - Help System Implementation (COMPLETED)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #00ff41;">?</span> Added "? Help" button in header</li>
                        <li><span style="color: #00ff41;">?</span> Created comprehensive help modal with step-by-step guides</li>
                        <li><span style="color: #00ff41;">?</span> Documented all features and new functionality</li>
                        <li><span style="color: #00ff41;">?</span> Added progress tracker for transparency</li>
                    </ul>
                </div>

                <div style="background: rgba(46, 26, 26, 0.9); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">? Next Planned Steps (From Build Plan)</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li><span style="color: #ff8800;">?</span> Step 5 - Items API (JSON store + CRUD + audit)</li>
                        <li><span style="color: #ff8800;">?</span> Step 6 - Grid with View More 9 (virtualization)</li>
                        <li><span style="color: #ff8800;">?</span> Step 7 - Constants Wired (preset validation)</li>
                        <li><span style="color: #ff8800;">?</span> Step 8 - Bulk Selection Model (select all filtered)</li>
                        <li><span style="color: #ff8800;">?</span> Step 9 - Bulk Actions System (add/remove tags, set status)</li>
                    </ul>
                </div>

                <div style="background: rgba(35, 35, 15, 0.9); border: 1px solid #D4AF37; border-radius: 8px; padding: 10px; margin: 15px 0 5px 0; text-align: center;">
                    <p style="color: #D4AF37; margin: 0; font-size: 12px;"><strong>?? Feedback Welcome:</strong> Each step will be documented here for review and iteration</p>
                </div>

                <!-- LOCAL STORAGE & SYSTEM INSPECTOR -->
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? System Inspector & Local Storage</h3>
                
                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #00ff41; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #00ff41; margin: 0 0 10px 0;">?? Current System Status</h4>
                    <div id="systemStatusInspector" style="font-family: monospace; font-size: 12px; color: #00ff41;">
                        <div>Loading system status...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #ff8800; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #ff8800; margin: 0 0 10px 0;">?? Local Storage Contents</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Diagnostics.refreshLocalStorage()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Refresh</button>
                        <button onclick="Diagnostics.clearAllLocalStorage()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">??? Clear All</button>
                    </div>
                    <div id="localStorageInspector" style="font-family: monospace; font-size: 11px; color: #ff8800; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Refresh" to view local storage contents...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #8a2be2; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #8a2be2; margin: 0 0 10px 0;">?? Live Activity Log</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Diagnostics.refreshActivityLog()" style="background: #8a2be2; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Refresh</button>
                        <button onclick="Diagnostics.downloadLogs()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">?? Download Logs</button>
                    </div>
                    <div id="activityLogInspector" style="font-family: monospace; font-size: 11px; color: #8a2be2; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Activity log will appear here...</div>
                    </div>
                </div>

                <div style="background: rgba(20, 20, 40, 0.8); border: 1px solid #D4AF37; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #D4AF37; margin: 0 0 10px 0;">?? Database Connection Test</h4>
                    <div style="margin-bottom: 10px;">
                        <button onclick="Database.testConnection()" style="background: #D4AF37; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-right: 10px;">?? Test Connection</button>
                        <button onclick="Database.viewStats()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">?? View Stats</button>
                    </div>
                    <div id="databaseTestResult" style="font-family: monospace; font-size: 11px; color: #D4AF37; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3);">
                        <div>Click "Test Connection" to check database status...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15, 15, 35, 0.95); border: 2px solid #D4AF37; border-radius: 20px; padding: 30px; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #D4AF37; margin: 0;">? How to Use SBS Media Hub</h2>
                <button onclick="hideHelp()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;">?</button>
            </div>
            
            <div style="color: #00ff41; line-height: 1.6; font-size: 14px;">
                <h3 style="color: #D4AF37; margin: 20px 0 10px 0;">?? Security & Setup</h3>
                <p><strong>Important:</strong> This system now uses a secure API proxy for enhanced security.</p>
                <p><strong>Before using:</strong> Run <span style="background: rgba(212, 175, 55, 0.2); padding: 2px 6px; border-radius: 4px;">"START-API-PROXY.bat"</span> to start the proxy server on port 3001.</p>
                    if (cleanDescription) {
                        filename = `DESC-${cleanDescription}-CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'category-first':
                    // Category first with markers: CAT-SIZE-DESC-DATE-BATCH-ITEM
                    if (cleanDescription) {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DESC-${cleanDescription}-DATE-${dateStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    } else {
                        filename = `CAT-${category}-SIZE-${cleanSize}-DATE-${dateStr}-TIME-${timeStr}-BATCH-B${batchNum}-ITEM-##ITEM##.jpeg`;
                    }
                    break;
                    
                case 'clean':
                    // Clean underscores format with markers
                    if (cleanDescription) {
                        filename = `SBS_DESC_${cleanDescription.replace('-', '_')}_CAT_${category.replace('-', '_')}_SIZE_${cleanSize.replace('-', '_')}_DATE_${dateStr}_BATCH_B${batchNum}_ITEM_##ITEM##.jpeg`;
            // Actually upload the file to Cloudflare Images
            const formData = new FormData();
            formData.append('file', file);
            formData.append('metadata', JSON.stringify({
                filename: filename,
                category: category,
                size: size,
                section: siteSection,
                additionalTag: additionalTag || '',
                uploadedAt: new Date().toISOString(),
                batchNumber: batchNum
            }));

            const response = await fetch(`${API_CONFIG.proxyUrl}/images`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(`Upload failed: ${result.error}`);
            }

            // Return the complete item object from the server (includes id, createdAt, etc.)
            return {
                ...result.item,
                image: `https://imagedelivery.net/${API_CONFIG.accountHash}/${result.item.cloudflareId}/w=1080,h=1920`
            };
        }

        // Initialize when page loads - Frontend ready message
        document.addEventListener('DOMContentLoaded', function() {
            logMessage("✅ Frontend initialized. Ready to connect to API server.");
        });
    </script>
</body>
</html>
