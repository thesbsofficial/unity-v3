<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBS Unity Admin - Overview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #fff;
            line-height: 1.6;
        }

        /* Header */
        .admin-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #999;
        }

        .btn-logout {
            background: #dc2626;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: #b91c1c;
        }

        /* Sidebar */
        .admin-layout {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 60px);
        }

        .sidebar {
            width: 250px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-title {
            padding: 0 20px;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            color: #999;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .nav-link.active {
            background: #2563eb;
            color: #fff;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #999;
            font-size: 14px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
        }

        .stat-trend {
            font-size: 12px;
            color: #10b981;
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .action-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .action-btn:hover {
            background: #333;
            border-color: #3b82f6;
        }

        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .action-label {
            font-size: 14px;
            font-weight: 500;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Auth Check */
        .auth-check {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
            gap: 20px;
        }
    </style>
</head>

<body>
    <!-- Auth Check Screen -->
    <div id="authCheck" class="auth-check">
        <div class="loading">üîê Checking authentication...</div>
    </div>

    <!-- Main Admin Interface (hidden until auth confirmed) -->
    <div id="adminInterface" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/"
                        style="color: #999; text-decoration: none; font-size: 14px; padding: 6px 12px; border: 1px solid #333; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.color='#3b82f6'; this.style.borderColor='#3b82f6';"
                        onmouseout="this.style.color='#999'; this.style.borderColor='#333';">
                        ‚Üê Back to Shop
                    </a>
                    <div class="logo">üéõÔ∏è SBS Unity Admin</div>
                </div>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Layout -->
        <div class="admin-layout">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Main</div>
                    <a href="/admin/" class="nav-link active">
                        <span>üè†</span> Overview
                    </a>
                    <a href="/admin/inventory/" class="nav-link">
                        <span>üì¶</span> Inventory
                    </a>
                    <a href="/admin/requests/" class="nav-link">
                        <span>üìã</span> Requests
                    </a>
                    <a href="/admin/customers/" class="nav-link">
                        <span>üë•</span> Customers
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">System</div>
                    <a href="/admin/analytics.html" class="nav-link">
                        <span>üìä</span> Analytics
                    </a>
                    <a href="/admin/data/" class="nav-link">
                        <span>üíæ</span> Data
                    </a>
                    <a href="/admin/logs/" class="nav-link">
                        <span>ÔøΩ</span> Logs
                    </a>
                    <a href="/admin/security/" class="nav-link">
                        <span>üîí</span> Security
                    </a>
                    <a href="/admin/audit/" class="nav-link">
                        <span>üìú</span> Audit
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Utilities</div>
                    <a href="/debug.html" class="nav-link"
                        style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                        <span>üî¨</span> System Test
                    </a>
                    <a href="/admin/system-check.html" class="nav-link">
                        <span>üîç</span> System Check
                    </a>
                    <a href="/admin/status.html" class="nav-link">
                        <span>üì°</span> API Status
                    </a>
                    <a href="/admin/diagnostic.html" class="nav-link">
                        <span>üõ†Ô∏è</span> Diagnostics
                    </a>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <div class="page-header">
                    <h1 class="page-title">Overview</h1>
                    <p class="page-subtitle">Your admin dashboard at a glance</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Inventory</div>
                        <div class="stat-value" id="statInventory">-</div>
                        <div class="stat-trend">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Requests</div>
                        <div class="stat-value" id="statRequests">-</div>
                        <div class="stat-trend">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Customers</div>
                        <div class="stat-value" id="statCustomers">-</div>
                        <div class="stat-trend">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Today's Sales</div>
                        <div class="stat-value" id="statSales">-</div>
                        <div class="stat-trend">Loading...</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2 class="section-title">Quick Actions</h2>
                    <div class="actions-grid">
                        <div class="action-btn" onclick="window.location.href='/admin/inventory/'">
                            <div class="action-icon">üì¶</div>
                            <div class="action-label">Manage Inventory</div>
                        </div>
                        <div class="action-btn" onclick="window.location.href='/admin/requests/'">
                            <div class="action-icon">üìã</div>
                            <div class="action-label">Review Requests</div>
                        </div>
                        <div class="action-btn" onclick="window.location.href='/admin/customers/'">
                            <div class="action-icon">üë•</div>
                            <div class="action-label">Manage Customers</div>
                        </div>
                        <div class="action-btn" onclick="window.location.href='/debug.html'"
                            style="border: 2px solid #3b82f6;">
                            <div class="action-icon">üî¨</div>
                            <div class="action-label">System Test</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Auth Check (Session-based, NO PASSWORD)
        async function checkAuth() {
            try {
                const response = await fetch('/api/users/me');

                if (!response.ok) {
                    // Not authenticated - redirect to login
                    window.location.replace('/login.html?redirect=/admin/');
                    return;
                }

                const data = await response.json();

                if (data.success && data.user?.role === 'admin') {
                    // Admin authenticated - show interface
                    document.getElementById('authCheck').style.display = 'none';
                    document.getElementById('adminInterface').style.display = 'block';
                    document.getElementById('userName').textContent = `@${data.user.social_handle || 'admin'}`;

                    // Load dashboard data
                    loadDashboardData();
                } else {
                    // Not admin - redirect to login
                    window.location.replace('/login.html?redirect=/admin/');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.replace('/login.html?redirect=/admin/');
            }
        }

        // Load Dashboard Stats
        async function loadDashboardData() {
            const session = sessionStorage.getItem('sbs_admin_session') || localStorage.getItem('sbs_admin_session');
            const authHeaders = session ? { 'Authorization': `Bearer ${session}` } : {};

            const updateTrend = (elementId, text, color = '#999') => {
                const trendEl = document.getElementById(elementId)?.nextElementSibling;
                if (trendEl) {
                    trendEl.textContent = text;
                    trendEl.style.color = color;
                }
            };

            try {
                const [inventoryRes, requestsRes, customersRes, ordersRes] = await Promise.all([
                    fetch('/api/products-smart?smart'),
                    fetch('/api/sell-submissions?status=pending'),
                    fetch('/api/analytics-v2?view=customers&period=month'),
                    fetch('/api/admin/orders', { headers: authHeaders })
                ]);

                const inventoryData = await inventoryRes.json().catch(() => ({}));
                const requestsData = await requestsRes.json().catch(() => ({}));
                const customersData = await customersRes.json().catch(() => ({}));
                let ordersData = { stats: { revenue: 0 }, orders: [] };

                if (ordersRes.ok) {
                    ordersData = await ordersRes.json();
                } else {
                    console.warn('Orders endpoint unavailable for dashboard summary.');
                }

                const liveInventory = inventoryData.total || inventoryData.products?.length || 0;
                const pendingSubmissions = requestsData.count ?? 0;
                const activeCustomers = customersData.summary?.total_active ?? 0;
                const todaysRevenue = ordersData.stats?.revenue ?? 0;

                document.getElementById('statInventory').textContent = liveInventory;
                updateTrend('statInventory', `${inventoryData.d1_sync?.upserted || 0} new items auto-synced`, '#22c55e');

                document.getElementById('statRequests').textContent = pendingSubmissions;
                updateTrend('statRequests', pendingSubmissions === 0 ? 'All caught up üéâ' : 'Awaiting review', pendingSubmissions === 0 ? '#22c55e' : '#f97316');

                document.getElementById('statCustomers').textContent = activeCustomers;
                updateTrend('statCustomers', 'Top advocates highlighted in analytics', '#60a5fa');

                document.getElementById('statSales').textContent = `¬£${Number(todaysRevenue).toFixed(2)}`;
                updateTrend('statSales', 'Today‚Äôs completed order value', '#a855f7');

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                document.querySelectorAll('.stat-trend').forEach(el => {
                    el.textContent = 'Data unavailable';
                    el.style.color = '#ef4444';
                });
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/users/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout failed:', error);
            }
            window.location.replace('/login.html');
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>

</html>
