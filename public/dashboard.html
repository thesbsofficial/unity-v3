<!--
    ==============================================================
    SBS DASHBOARD ‚Äî INLINE GUIDE FOR QUICK EDITS (Non-coder friendly)
    ==============================================================
    What this file is:
    - The HTML, CSS, and JS for the My Account (Dashboard) page.
    - Everything is in one file so you can edit in place.

    How the page is structured (search these markers):
    1) HEADER/NAV               ‚Äî starts at: <header class="header">
    2) MOBILE MENU              ‚Äî starts at: <div class="mobile-menu" ...>
    3) MAIN CONTAINER           ‚Äî starts at: <div class="container">
         3a) PAGE HEADER (title)  ‚Äî inside container: <div class="page-header"> with .page-title and .page-subtitle
         3b) DASHBOARD GRID       ‚Äî <div class="dashboard-grid"> splits sidebar + content
                 3b-i) SIDEBAR        ‚Äî <aside class="sidebar"> (profile + menu links)
                 3b-ii) MAIN CONTENT  ‚Äî <main class="main-content" id="mainContent"> (loads dynamic sections)

    Quick things you may want to change:
    - Page title/subtitle text: Search for "<h1 class=\"page-title\">My Account" and edit that line and the <p class="page-subtitle"> below it.
    - Sidebar menu items: Search for "<ul class=\"sidebar-menu\">" and edit/add/remove the <li><a ...> links.
    - Colors: At the top of the CSS there is a :root section with variables like --primary-gold and --bg-dark. Change those values to adjust the theme.
    - Spacing on mobile: Search for "@media (max-width: 768px)" ‚Äî values inside there control phone layout (font-sizes, paddings, gaps).
    - Logo size: Search for ".logo img" and change max-height.
    - Reduce the big title on phones: In the same mobile block, adjust .page-title font-size.

    Safe editing tips:
    - Only edit values on the right side of ":" in CSS. Example: font-size: 1.5rem; ‚Äî change 1.5rem to 1.25rem.
    - For text, edit between the tags. Example: <h1>New Title</h1>.
    - Avoid deleting entire blocks unless you are sure. Instead, comment them out by wrapping with <!-- ... --> in HTML or /* ... */ in CSS.
    - Keep class names as-is; they are used by the JavaScript.

    How to make the mobile layout tighter (most common requests):
    - Reduce container padding (search: ".container { padding:")
    - Reduce page header margin (search: ".page-header { margin-bottom:")
    - Reduce title size (search: ".page-title { font-size:")
    - Adjust grid gap (search: ".dashboard-grid { gap:")

    How the sidebar links work:
    - Each link has data-section (e.g., data-section="overview"). When you tap it, JS loads that section into <main id="mainContent">.

    How to deploy your changes (PowerShell):
    - npx wrangler pages deploy public --project-name=unity-v3 --branch=MAIN --commit-dirty=true
    (We usually run this from the folder: unity-v3/public (4))

    If you break something:
    - Undo the last change (Ctrl+Z), save, deploy again.
    - Or ask for help and mention what you changed.

    This entire guide is a comment and won‚Äôt show on the page. You can safely leave it here.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - SBS</title>

    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           DASHBOARD PAGE STYLES (Base styles in global.css)
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 0;
            }

            .nav {
                padding: 0 1rem;
                gap: 1rem;
            }

            .logo img {
                max-height: 35px;
            }

            .container {
                padding: 1.25rem 1rem;
            }

            .page-header {
                margin-bottom: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
                line-height: 1.2;
            }

            .page-subtitle {
                font-size: 0.875rem;
                line-height: 1.4;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid var(--border-subtle);
        }

        .profile-section {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--primary-gold);
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-black);
        }

        .profile-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .profile-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a,
        .sidebar-menu button {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            cursor: pointer;
            font-family: inherit;
        }

        .sidebar-menu a:hover,
        .sidebar-menu button:hover {
            background: rgba(255, 215, 0, 0.1);
            color: var(--primary-gold);
        }

        .sidebar-menu a.active {
            background: var(--primary-gold);
            color: var(--primary-black);
            font-weight: 600;
        }

        /* Main Content Area */
        .main-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-subtle);
        }

        .section {
            margin-bottom: 3rem;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .section-link {
            color: var(--primary-gold);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-pending {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning-orange);
        }

        .badge-delivered {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-green);
        }

        .badge-reviewing {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .badge-offered {
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
        }

        .card-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .order-card {
            margin-bottom: 1.5rem;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .order-card-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .order-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .order-meta strong {
            display: block;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .order-items {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem;
        }

        .order-item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-hover);
        }

        .order-item-details {
            flex: 1;
        }

        .order-item-details h4 {
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .order-item-details p {
            margin: 0.15rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .order-badge-note {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-gold);
            background: rgba(255, 215, 0, 0.08);
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .badge-ready {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .badge-completed {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-green);
        }

        .badge-cancelled {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger-red);
        }

        .orders-empty-state {
            text-align: center;
            padding: 2.5rem 1rem;
            border: 1px dashed var(--border-subtle);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .orders-empty-state p {
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
        }

        .orders-grid {
            display: grid;
            gap: 1.5rem;
        }

        .bids-grid {
            display: grid;
            gap: 1.5rem;
        }

        .bid-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bid-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .order-status-timeline {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-subtle);
        }

        .order-status-timeline div {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-summary-card {
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.02);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .status-summary-card.primary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.18), rgba(255, 215, 0, 0.05));
            border-color: rgba(255, 215, 0, 0.45);
        }

        .status-summary-card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-summary-metric {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .status-summary-meta {
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .submission-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .submission-filter-bar button {
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            padding: 0.5rem 0.9rem;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .submission-filter-bar button:hover {
            border-color: var(--primary-gold);
            color: var(--primary-gold);
        }

        .submission-filter-bar button.active {
            background: var(--primary-gold);
            border-color: var(--primary-gold);
            color: var(--primary-black);
            font-weight: 600;
        }

        .submission-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .submission-card-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .submission-card-header h3 {
            font-size: 1.15rem;
            font-weight: 700;
        }

        .submission-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .submission-meta span {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .submission-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .submission-value {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0.85rem 1rem;
        }

        .submission-value strong {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .submission-items {
            margin-top: 1.25rem;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
        }

        .submission-items ul {
            margin-top: 0.75rem;
            padding-left: 1.25rem;
            line-height: 1.65;
        }

        .submission-note,
        .submission-offer,
        .submission-outcome {
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .submission-note {
            background: rgba(255, 215, 0, 0.08);
            border-left: 3px solid var(--primary-gold);
            color: var(--primary-gold);
        }

        .submission-offer {
            background: rgba(33, 150, 243, 0.08);
            border-left: 3px solid #2196f3;
        }

        .submission-outcome {
            background: rgba(76, 175, 80, 0.08);
            border-left: 3px solid var(--success-green);
        }

        .submission-empty {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--text-secondary);
        }

        .submission-load-more {
            text-align: center;
            margin-top: 2rem;
        }

        .submission-load-more button {
            min-width: 220px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-subtle);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* GDPR Section */
        .gdpr-section {
            background: rgba(255, 68, 68, 0.05);
            border: 1px solid rgba(255, 68, 68, 0.2);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 3rem;
        }

        .gdpr-section h3 {
            color: var(--danger-red);
            margin-bottom: 1rem;
        }

        .gdpr-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .gdpr-actions {
                flex-direction: column;
            }

            .bids-grid {
                gap: 1rem;
            }

            .bid-card {
                padding: 1rem !important;
            }

            .bid-card img {
                width: 60px !important;
                height: 60px !important;
            }

            .bid-card .btn-outline {
                padding: 0.4rem 0.75rem !important;
                font-size: 0.8rem !important;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
    </style>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/mobile.css">
    <link rel="stylesheet" href="/css/cart-overlay.css">
    <script src="/js/analytics-tracker.js" defer></script>
    <script src="/js/cart-manager.js" defer></script>
    <script src="/js/cart-ui.js" defer></script>
    <script src="/js/mobile-menu.js" defer></script>
    <script src="/js/app.js" defer></script>
</head>

<body>
    <!-- SECTION: HEADER / NAV -->
    <header class="header">
        <nav class="nav">
            <div class="nav-left">
                <a href="/" class="logo">
                    <img src="/SBS (Your Story).png" alt="SBS"
                        onerror="this.style.display='none'; this.parentNode.innerHTML='SBS'">
                </a>
            </div>
            <div class="nav-right">
                <!-- Auth state dynamically updates this section -->
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <button type="button" class="btn-outline hero-signout-btn" id="heroSignOutBtn">Sign Out</button>
                <button class="cart-toggle" type="button">
                    Basket
                    <span class="cart-count" id="cart-count">0</span>
                </button>
                <!-- Hamburger Menu Button (Mobile Only) - FAR RIGHT -->
                <button class="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <!-- SECTION: MOBILE MENU (Slide-in) -->
    <div class="mobile-menu-backdrop"></div>
    <div class="mobile-menu" aria-hidden="true">
        <div class="mobile-menu-header">
            <a href="/" class="logo">SBS</a>
        </div>
        <div class="mobile-menu-items">
            <a href="/shop" class="mobile-menu-item">üõçÔ∏è Shop</a>
            <a href="/sell" class="mobile-menu-item">üí∞ Sell</a>
            <a href="/dashboard" class="mobile-menu-item">üìä Dashboard</a>
        </div>
    </div>

    <!-- SECTION: MAIN CONTAINER (Page header + grid) -->
    <div class="container">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">My Account</h1>
                <p class="page-subtitle">Manage your orders, sell submissions, and account settings</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- SECTION: SIDEBAR (Profile + Menu) -->
            <aside class="sidebar">
                <div class="profile-section">
                    <div class="profile-avatar" id="profileAvatar">?</div>
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-email" id="profileEmail"></div>
                </div>

                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-section="overview">Overview</a></li>
                    <li style="margin-top: 1rem; padding: 0.5rem 0; border-top: 1px solid var(--border-subtle);">
                        <strong
                            style="color: var(--primary-gold); font-size: 0.85rem; padding: 0 1rem; display: block; margin-bottom: 0.5rem;">BUY</strong>
                    </li>
                    <li><a href="#" data-section="orders">My Orders <small>(Coming Soon)</small></a></li>
                    <li><a href="#" data-section="bids">My Bids üí∞</a></li>
                    <li style="margin-top: 1rem; padding: 0.5rem 0; border-top: 1px solid var(--border-subtle);">
                        <strong
                            style="color: var(--primary-gold); font-size: 0.85rem; padding: 0 1rem; display: block; margin-bottom: 0.5rem;">SELL</strong>
                    </li>
                    <li><a href="#" data-section="submissions">My Sell Requests</a></li>
                    <li style="margin-top: 1rem; padding: 0.5rem 0; border-top: 1px solid var(--border-subtle);">
                        <strong
                            style="color: var(--primary-gold); font-size: 0.85rem; padding: 0 1rem; display: block; margin-bottom: 0.5rem;">SETTINGS</strong>
                    </li>
                    <li><a href="#" data-section="profile">Edit Profile</a></li>
                    <li><a href="#" data-section="settings">Privacy & Data</a></li>
                </ul>
            </aside>

            <!-- SECTION: MAIN CONTENT (Dynamic sections render here) -->
            <main class="main-content" id="mainContent">
                <!-- Content loads here dynamically -->
            </main>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Delete Account</h3>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                    This action cannot be undone. All your data will be permanently deleted.
                </p>
            </div>
            <div>
                <p style="margin-bottom: 1rem;">Please type <strong>DELETE</strong> to confirm:</p>
                <input type="text" id="deleteConfirm" placeholder="Type DELETE"
                    style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
            </div>
            <div class="modal-actions">
                <button class="btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmDelete()">Delete Account</button>
            </div>
        </div>
    </div>

    <script>
        // Auth Check
        function checkAuth() {
            const user = sessionStorage.getItem('sbs_user');
            const token = sessionStorage.getItem('sbs_csrf_token');

            if (!user || !token) {
                window.location.href = '/login.html';
                return null;
            }

            return JSON.parse(user);
        }

        function escapeHTML(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function escapeAttr(value) {
            return escapeHTML(value)
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        const STATUS_CONFIG = {
            pending: {
                label: 'Pending Review',
                badgeClass: 'badge badge-pending',
                summaryBg: 'rgba(255, 152, 0, 0.18)',
                summaryBorder: 'rgba(255, 152, 0, 0.4)',
                icon: '‚è≥'
            },
            reviewing: {
                label: 'Under Review',
                badgeClass: 'badge badge-reviewing',
                summaryBg: 'rgba(33, 150, 243, 0.14)',
                summaryBorder: 'rgba(33, 150, 243, 0.35)',
                icon: 'üîç'
            },
            offer_sent: {
                label: 'Offer Sent',
                badgeClass: 'badge badge-offered',
                summaryBg: 'rgba(156, 39, 176, 0.14)',
                summaryBorder: 'rgba(156, 39, 176, 0.35)',
                icon: 'üí¨'
            },
            offer_pending: {
                label: 'Offer Pending',
                badgeClass: 'badge badge-offered',
                summaryBg: 'rgba(255, 193, 7, 0.16)',
                summaryBorder: 'rgba(255, 193, 7, 0.4)',
                icon: '‚è±Ô∏è'
            },
            offer_accepted: {
                label: 'Offer Accepted',
                badgeClass: 'badge badge-delivered',
                summaryBg: 'rgba(76, 175, 80, 0.16)',
                summaryBorder: 'rgba(76, 175, 80, 0.4)',
                icon: '‚úÖ'
            },
            completed: {
                label: 'Completed',
                badgeClass: 'badge badge-delivered',
                summaryBg: 'rgba(76, 175, 80, 0.16)',
                summaryBorder: 'rgba(76, 175, 80, 0.4)',
                icon: 'üèÅ'
            },
            rejected: {
                label: 'Declined',
                badgeClass: 'badge badge-pending',
                summaryBg: 'rgba(244, 67, 54, 0.16)',
                summaryBorder: 'rgba(244, 67, 54, 0.45)',
                icon: 'üö´'
            },
            cancelled: {
                label: 'Cancelled',
                badgeClass: 'badge badge-pending',
                summaryBg: 'rgba(158, 158, 158, 0.14)',
                summaryBorder: 'rgba(158, 158, 158, 0.35)',
                icon: 'üóëÔ∏è'
            }
        };

        const STATUS_ORDER = ['pending', 'reviewing', 'offer_sent', 'offer_pending', 'offer_accepted', 'completed', 'rejected', 'cancelled'];

    const ORDER_STATUS_KEYS = ['pending', 'confirmed', 'processing', 'shipped', 'completed', 'cancelled'];

        const currencyFormatter = new Intl.NumberFormat('en-IE', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2
        });

        const dateFormatter = new Intl.DateTimeFormat('en-IE', {
            dateStyle: 'medium',
            timeStyle: 'short'
        });

        const ORDER_STATUS_CONFIG = {
            pending: {
                label: 'Awaiting Confirmation',
                description: 'We have your order and will confirm shortly.',
                badgeClass: 'badge badge-pending',
                summaryBg: 'rgba(255, 152, 0, 0.18)',
                summaryBorder: 'rgba(255, 152, 0, 0.4)',
                icon: '‚è≥'
            },
            confirmed: {
                label: 'Confirmed',
                description: 'Your order is confirmed and being prepared.',
                badgeClass: 'badge badge-ready',
                summaryBg: 'rgba(33, 150, 243, 0.16)',
                summaryBorder: 'rgba(33, 150, 243, 0.35)',
                icon: 'üì¶'
            },
            processing: {
                label: 'Processing',
                description: 'Our team is working on your order.',
                badgeClass: 'badge badge-reviewing',
                summaryBg: 'rgba(156, 39, 176, 0.14)',
                summaryBorder: 'rgba(156, 39, 176, 0.35)',
                icon: '‚öôÔ∏è'
            },
            shipped: {
                label: 'Shipped',
                description: 'Your order is on the way to you.',
                badgeClass: 'badge badge-delivered',
                summaryBg: 'rgba(100, 181, 246, 0.16)',
                summaryBorder: 'rgba(100, 181, 246, 0.4)',
                icon: 'ÔøΩ'
            },
            completed: {
                label: 'Completed',
                description: 'Order fulfilled. Thank you for shopping with SBS!',
                badgeClass: 'badge badge-completed',
                summaryBg: 'rgba(76, 175, 80, 0.18)',
                summaryBorder: 'rgba(76, 175, 80, 0.45)',
                icon: '‚úÖ'
            },
            cancelled: {
                label: 'Cancelled',
                description: 'This order was cancelled. Contact us if you have questions.',
                badgeClass: 'badge badge-cancelled',
                summaryBg: 'rgba(244, 67, 54, 0.16)',
                summaryBorder: 'rgba(244, 67, 54, 0.45)',
                icon: 'üö´'
            }
        };

        function getOrderStatusConfig(status) {
            const key = normaliseStatus(status);
            if (ORDER_STATUS_CONFIG[key]) return ORDER_STATUS_CONFIG[key];
            return {
                label: String(status || 'Unknown').replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase()),
                description: 'Status update in progress.',
                badgeClass: 'badge badge-reviewing',
                summaryBg: 'rgba(255, 255, 255, 0.08)',
                summaryBorder: 'rgba(255, 255, 255, 0.2)',
                icon: '‚Ä¢'
            };
        }

        function normaliseOrderItems(items) {
            if (!Array.isArray(items)) {
                if (typeof items === 'string') {
                    try {
                        const parsed = JSON.parse(items);
                        items = Array.isArray(parsed) ? parsed : [];
                    } catch (err) {
                        console.warn('Failed to parse order items_json', err);
                        items = [];
                    }
                } else {
                    return [];
                }
            }

            return items.map(item => ({
                name: item.product_name || item.name || item.product_category || item.category || 'SBS Item',
                category: item.product_category || item.category || 'General',
                size: item.product_size || item.size || 'One Size',
                quantity: Number(item.quantity) || 1,
                price: Number(item.price) || 0,
                brand: item.product_brand || item.brand || '',
                image_url: item.image_url || item.image || null
            }));
        }

        function normalizeCustomerOrder(order = {}) {
            const items = normaliseOrderItems(order.items ?? order.items_json);
            return {
                ...order,
                status: normaliseStatus(order.status),
                total: Number(order.total) || 0,
                subtotal: Number(order.subtotal) || 0,
                delivery_fee: Number(order.delivery_fee) || 0,
                delivery_method: order.delivery_method || 'delivery',
                items,
                // Note: Production schema doesn't have admin_notes, customer_notes, or completed_at columns
                created_at: order.created_at,
                updated_at: order.updated_at || order.created_at
            };
        }

        let ordersCache = null;
        let ordersCacheFetchedAt = 0;

        async function fetchOrders(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && ordersCache && now - ordersCacheFetchedAt < 15000) {
                return ordersCache;
            }

            const token = sessionStorage.getItem('sbs_csrf_token');
            const response = await fetch('/api/users/me/orders', {
                method: 'GET',
                headers: {
                    'X-CSRF-Token': token || ''
                },
                credentials: 'include'
            });

            if (response.status === 401) {
                handleSignOut();
                return [];
            }

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Failed to load orders');
            }

            const orders = (data.orders || []).map(normalizeCustomerOrder);
            ordersCache = orders;
            ordersCacheFetchedAt = now;
            return orders;
        }

        function computeOrderStats(orders) {
            const stats = {
                total: orders.length
            };

            for (const key of ORDER_STATUS_KEYS) {
                stats[key] = 0;
            }

            orders.forEach(order => {
                const key = normaliseStatus(order.status);
                stats[key] = (stats[key] || 0) + 1;
            });

            return stats;
        }

        function renderOrdersSummaryHtml(orders) {
            const stats = computeOrderStats(orders);
            const activeStatuses = ORDER_STATUS_KEYS.filter(key => stats[key] > 0);

            const statusCards = activeStatuses.map(key => {
                const config = getOrderStatusConfig(key);
                return `
                    <div class="status-summary-card" style="background: ${config.summaryBg}; border-color: ${config.summaryBorder};">
                        <h3>${config.icon} ${config.label}</h3>
                        <div class="status-summary-metric">${stats[key]}</div>
                        <div class="status-summary-meta">Orders in this state</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="status-summary-grid">
                    <div class="status-summary-card primary">
                        <h3>üì¶ Total Orders</h3>
                        <div class="status-summary-metric">${stats.total}</div>
                        <div class="status-summary-meta">Track your deliveries and pickups</div>
                    </div>
                    ${statusCards}
                </div>
            `;
        }

        function renderOrderItems(order) {
            if (!order.items.length) {
                return `
                    <div class="order-item">
                        <div class="order-item-details">
                            <h4>Items on File</h4>
                            <p>We'll update this with item details shortly.</p>
                        </div>
                    </div>
                `;
            }

            return order.items.map(item => `
                <div class="order-item">
                    ${item.image_url ? `<img src="${item.image_url}" alt="${escapeHTML(item.name)}" class="order-item-image">` : ''}
                    <div class="order-item-details">
                        <h4>${escapeHTML(item.name)}</h4>
                        <p>${escapeHTML(item.category)} ‚Ä¢ Size ${escapeHTML(item.size)}</p>
                        <p>Qty ${item.quantity}${item.price ? ` ‚Ä¢ ${formatCurrency(item.price)}` : ''}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderOrderCard(order) {
            const config = getOrderStatusConfig(order.status);
            const timeline = [
                `<div><strong>Placed:</strong> ${formatDateTime(order.created_at)}</div>`,
                `<div><strong>Updated:</strong> ${formatDateTime(order.updated_at)}</div>`
            ];
            if (order.completed_at) {
                timeline.push(`<div><strong>Completed:</strong> ${formatDateTime(order.completed_at)}</div>`);
            }

            const address = order.delivery_method === 'delivery'
                ? [order.delivery_address, order.delivery_city, order.delivery_eircode].filter(Boolean).map(escapeHTML).join(', ')
                : 'Collect in-store';

            return `
                <div class="card order-card">
                    <div class="order-card-header">
                        <h3>${escapeHTML(order.order_number)}</h3>
                        <span class="${config.badgeClass}">${config.icon} ${config.label}</span>
                    </div>
                    <div class="order-meta">
                        <div>
                            <strong>Total</strong>
                            ${formatCurrency(order.total)}
                        </div>
                        <div>
                            <strong>Delivery</strong>
                            ${escapeHTML(order.delivery_method === 'collection' ? 'Collection' : 'Delivery')}
                        </div>
                        <div>
                            <strong>Destination</strong>
                            ${address || '‚Äî'}
                        </div>
                        <div>
                            <strong>Status Message</strong>
                            ${escapeHTML(config.description)}
                        </div>
                    </div>
                    <div class="order-items">
                        ${renderOrderItems(order)}
                    </div>
                    ${order.admin_notes ? `<div class="order-badge-note">${escapeHTML(order.admin_notes)}</div>` : ''}
                    ${order.customer_notes ? `<div class="order-badge-note" style="border-left-color: var(--primary-black); background: rgba(255, 255, 255, 0.05);">Customer note: ${escapeHTML(order.customer_notes)}</div>` : ''}
                    <div class="order-status-timeline">
                        ${timeline.join('')}
                    </div>
                </div>
            `;
        }

        function renderOrderPreview(order) {
            const config = getOrderStatusConfig(order.status);
            const firstItem = order.items[0];
            const itemSummary = firstItem
                ? `${escapeHTML(firstItem.name)}${order.items.length > 1 ? ` +${order.items.length - 1} more` : ''}`
                : 'Awaiting item details';

            return `
                <div class="card order-card">
                    <div class="order-card-header">
                        <h3>${escapeHTML(order.order_number)}</h3>
                        <span class="${config.badgeClass}">${config.icon} ${config.label}</span>
                    </div>
                    <div class="order-meta">
                        <div>
                            <strong>Total</strong>
                            ${formatCurrency(order.total)}
                        </div>
                        <div>
                            <strong>Placed</strong>
                            ${formatDateTime(order.created_at)}
                        </div>
                    </div>
                    <div class="order-item-details">
                        <p>${itemSummary}</p>
                    </div>
                </div>
            `;
        }

        function renderOrdersContent(orders) {
            const summaryEl = document.getElementById('ordersSummary');
            const listEl = document.getElementById('ordersList');
            if (!summaryEl || !listEl) return;

            if (!orders.length) {
                summaryEl.innerHTML = `
                    <div class="orders-empty-state">
                        <p>You haven't placed any orders yet.</p>
                        <a href="/shop.html" class="btn-gold">Browse Shop</a>
                    </div>
                `;
                listEl.innerHTML = `
                    <div class="orders-empty-state">
                        <p>Your order history will appear here once you place an order.</p>
                    </div>
                `;
                return;
            }

            summaryEl.innerHTML = renderOrdersSummaryHtml(orders);
            listEl.innerHTML = orders.map(renderOrderCard).join('');
        }

        let submissionsState = {
            entries: [],
            summary: [],
            filter: 'all',
            visible: 20
        };

        function normaliseStatus(value) {
            return String(value || 'pending').toLowerCase();
        }

        function getStatusConfig(status) {
            const key = normaliseStatus(status);
            if (STATUS_CONFIG[key]) {
                return STATUS_CONFIG[key];
            }
            const label = key
                .split('_')
                .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' ');
            return {
                label,
                badgeClass: 'badge badge-reviewing',
                summaryBg: 'rgba(255, 255, 255, 0.08)',
                summaryBorder: 'rgba(255, 255, 255, 0.2)',
                icon: '‚Ä¢'
            };
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || value === '') return '‚Äî';
            const numberValue = Number(value);
            if (!Number.isFinite(numberValue)) return '‚Äî';
            return currencyFormatter.format(numberValue);
        }

        function formatDateTime(value) {
            if (!value) return '‚Äî';
            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) return escapeHTML(String(value));
            return dateFormatter.format(parsed);
        }

        function computeSummaryFromEntries(entries) {
            const map = new Map();
            entries.forEach(entry => {
                const key = normaliseStatus(entry.status);
                const items = Array.isArray(entry.items) ? entry.items.length : Number(entry.item_count) || 0;
                const current = map.get(key) || { status: key, count: 0, items: 0 };
                current.count += 1;
                current.items += items;
                map.set(key, current);
            });
            return Array.from(map.values());
        }

        function getFilteredSubmissions() {
            if (submissionsState.filter === 'all') {
                return submissionsState.entries;
            }
            return submissionsState.entries.filter(entry => normaliseStatus(entry.status) === submissionsState.filter);
        }

        function setSubmissionFilter(status) {
            submissionsState.filter = status || 'all';
            submissionsState.visible = 20;
            renderSubmissionFilters();
            renderSubmissionList();
        }

        function loadMoreSubmissions() {
            submissionsState.visible += 20;
            renderSubmissionList();
        }

        function showProfileMessage(type, text) {
            const messageDiv = document.getElementById('profile-message');
            if (!messageDiv) return;

            messageDiv.textContent = '';
            messageDiv.style.display = 'block';

            let background = 'rgba(76, 175, 80, 0.1)';
            let border = '3px solid var(--success-green)';
            let color = 'var(--success-green)';

            if (type === 'error') {
                background = 'rgba(244, 67, 54, 0.1)';
                border = '3px solid var(--danger-red)';
                color = 'var(--danger-red)';
            } else if (type === 'notice') {
                background = 'rgba(255, 215, 0, 0.1)';
                border = '3px solid var(--primary-gold)';
                color = 'var(--primary-gold)';
            }

            messageDiv.style.background = background;
            messageDiv.style.borderLeft = border;

            const strong = document.createElement('strong');
            strong.style.color = color;
            strong.textContent = text ?? '';
            messageDiv.appendChild(strong);
        }

        // Load user profile
        function loadProfile() {
            const user = checkAuth();
            if (!user) return;

            // Set profile info
            const firstName = user.first_name || 'User';
            const lastName = user.last_name || '';
            const initials = (firstName[0] + (lastName[0] || '')).toUpperCase();

            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('profileName').textContent = `${firstName} ${lastName}`.trim();
            document.getElementById('profileEmail').textContent = user.email || '';
        }

        async function handleSignOut(e) {
            if (e) {
                e.preventDefault(); // Prevent default link behavior
                e.stopPropagation(); // Stop cart-ui.js from interfering
            }
            
            try {
                await fetch('/api/users/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear all storage
            sessionStorage.clear();
            localStorage.clear();
            
            // Force hard redirect with cache busting to prevent showing cached dashboard
            window.location.replace('/login.html?logout=true&t=' + Date.now());
        }

        // Use event delegation to handle all sign out buttons
        document.addEventListener('click', function(e) {
            const target = e.target.closest('#signOutBtn, #heroSignOutBtn, #mobile-signout, .hero-signout-btn');
            if (target) {
                e.preventDefault();
                handleSignOut(e);
            }
        });

        // Load section content
        async function loadSection(section) {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

            // Update active menu item
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.toggle('active', link.dataset.section === section);
            });

            // Load appropriate content
            switch (section) {
                case 'overview':
                    await loadOverview();
                    break;
                case 'orders':
                    await loadOrders();
                    break;
                case 'bids':
                    await loadBids();
                    break;
                case 'submissions':
                    await loadSubmissions();
                    break;
                case 'profile':
                    loadProfileEdit();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // üéØ SHARED: Render Bid Card (used by Overview and My Bids)
        function renderBidCard(bid, compact = false) {
            const statusColors = {
                'pending': '#ff9800',
                'accepted': '#4caf50',
                'rejected': '#f44336',
                'countered': '#2196f3'
            };

            const statusLabels = {
                'pending': '‚è≥ Pending',
                'accepted': '‚úÖ Accepted',
                'rejected': '‚ùå Rejected',
                'countered': 'üîÑ Counter Offer'
            };

            // HTML escape function to prevent XSS
            const escapeHtml = (text) => {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            // Safe data extraction with defaults
            const statusColor = statusColors[bid.status] || '#999';
            const statusLabel = statusLabels[bid.status] || escapeHtml(bid.status);
            const isHighest = bid.is_highest_offer;
            const offerAmount = typeof bid.offer_amount === 'number' ? bid.offer_amount.toFixed(2) : '0.00';
            const counterAmount = typeof bid.counter_offer_amount === 'number' ? bid.counter_offer_amount.toFixed(2) : null;
            const productCategory = escapeHtml(bid.product_category) || 'Product';
            const productSize = escapeHtml(bid.product_size) || 'N/A';
            const adminNotes = escapeHtml(bid.admin_notes);
            const productImage = bid.product_image || '/placeholder.svg';
            const productId = bid.product_id || '';

            // Safe date formatting
            let dateString = 'Unknown date';
            try {
                if (bid.created_at) {
                    const date = new Date(bid.created_at);
                    if (!isNaN(date.getTime())) {
                        dateString = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                }
            } catch (e) {
                console.warn('Date parsing error:', e);
            }

            return `
                <div class="bid-card" style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-subtle);">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex-shrink: 0;">
                            <img src="${productImage}" 
                                 alt="Product" 
                                 style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='/placeholder.svg'">
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">
                                        ‚Ç¨${offerAmount}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">
                                        ${productCategory} ‚Ä¢ ${productSize}
                                    </div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">
                                    ${statusLabel}
                                </span>
                            </div>
                            ${isHighest ? `
                                <div style="background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: #000; padding: 0.5rem; border-radius: 6px; font-size: 0.8rem; font-weight: 700; text-align: center; margin-top: 0.5rem;">
                                    üî• HIGHEST BID
                                </div>
                            ` : ''}
                            ${counterAmount ? `
                                <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid #2196f3; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                                    <strong style="color: #2196f3;">Counter Offer:</strong> ‚Ç¨${counterAmount}
                                    ${adminNotes ? `<br><span style="color: var(--text-secondary); font-size: 0.8rem;">${adminNotes}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div style="padding-top: 1rem; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">
                            ${dateString}
                        </span>
                        <a href="/shop?product=${productId}" class="btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                            View Product
                        </a>
                    </div>
                </div>
            `;
        }

        // Load Overview
        async function loadOverview() {
            const content = document.getElementById('mainContent');
            const user = JSON.parse(sessionStorage.getItem('sbs_user'));
            const token = sessionStorage.getItem('sbs_csrf_token');

            content.innerHTML = `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üí∞ My Bids</h2>
                        <a href="#" class="section-link" onclick="loadSection('bids'); return false;">View all</a>
                    </div>
                    <div id="recentBids" class="loading"><div class="spinner"></div></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Orders</h2>
                        <a href="#" class="section-link" onclick="loadSection('orders'); return false;">View all</a>
                    </div>
                    <div id="recentOrders" class="loading"><div class="spinner"></div></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Submissions</h2>
                        <a href="#" class="section-link" onclick="loadSection('submissions'); return false;">View all</a>
                    </div>
                    <div id="recentSubmissions" class="loading"><div class="spinner"></div></div>
                </div>
            `;

            // Load Recent Bids
            const recentBidsEl = document.getElementById('recentBids');
            if (recentBidsEl) {
                recentBidsEl.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 0.5rem;">Loading your recent bids...</p>
                    </div>
                `;

                try {
                    const response = await fetch('/api/users/me/bids', {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (!response.ok || !data.success || !data.bids || data.bids.length === 0) {
                        recentBidsEl.innerHTML = `
                            <div class="empty-state">
                                <p>No bids yet. <a href="/shop.html" style="color: var(--primary-gold);">Start bidding!</a></p>
                            </div>
                        `;
                    } else {
                        recentBidsEl.innerHTML = data.bids.slice(0, 3).map(bid => renderBidCard(bid, true)).join('');
                    }
                } catch (bidsError) {
                    console.warn('Recent bids load error:', bidsError);
                    recentBidsEl.innerHTML = `
                        <div class="empty-state">
                            <p>We couldn't fetch your bids right now. Try refreshing shortly.</p>
                        </div>
                    `;
                }
            }

            const recentOrdersEl = document.getElementById('recentOrders');
            if (recentOrdersEl) {
                recentOrdersEl.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 0.5rem;">Loading your recent orders...</p>
                    </div>
                `;

                try {
                    const orders = await fetchOrders();
                    if (!orders.length) {
                        recentOrdersEl.innerHTML = `
                            <div class="empty-state">
                                <p>No orders yet. <a href="/shop.html" style="color: var(--primary-gold);">Start shopping!</a></p>
                            </div>
                        `;
                    } else {
                        recentOrdersEl.innerHTML = orders.slice(0, 3).map(renderOrderPreview).join('');
                    }
                } catch (ordersError) {
                    console.warn('Recent orders load error:', ordersError);
                    recentOrdersEl.innerHTML = `
                        <div class="empty-state">
                            <p>We couldn't fetch your orders right now. Try refreshing shortly.</p>
                        </div>
                    `;
                }
            }

            const recentSubmissionsEl = document.getElementById('recentSubmissions');
            if (!recentSubmissionsEl) return;

            try {
                const response = await fetch('/api/sell-submissions?limit=5', {
                    method: 'GET',
                    headers: {
                        'X-CSRF-Token': token || ''
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok || !data.success || !(data.submissions || []).length) {
                    recentSubmissionsEl.innerHTML = `
                        <div class="empty-state">
                            <p>No submissions yet. <a href="/sell.html" style="color: var(--primary-gold);">Sell your items!</a></p>
                        </div>
                    `;
                    return;
                }

                const previews = (data.submissions || []).slice(0, 3).map(renderSubmissionPreview).join('');
                recentSubmissionsEl.innerHTML = previews;

            } catch (error) {
                console.error('Recent submissions load error:', error);
                recentSubmissionsEl.innerHTML = `
                    <div class="empty-state">
                        <p>We couldn't fetch your submissions right now. Try refreshing the page shortly.</p>
                    </div>
                `;
            }
        }

        // Load Orders
        async function loadOrders() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">My Orders</h2>
                        <button type="button" class="btn-outline" id="refreshOrdersBtn">üîÑ Refresh</button>
                    </div>
                    <div id="ordersSummary" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 0.5rem;">Loading your orders...</p>
                    </div>
                </div>
                <div class="section">
                    <div id="ordersList" class="orders-grid"></div>
                </div>
            `;

            async function refreshOrders(force = false) {
                const summaryEl = document.getElementById('ordersSummary');
                const listEl = document.getElementById('ordersList');

                try {
                    if (summaryEl) {
                        summaryEl.classList.add('loading');
                    }

                    const orders = await fetchOrders(force);
                    renderOrdersContent(orders);

                    if (summaryEl) {
                        summaryEl.classList.remove('loading');
                    }
                } catch (error) {
                    console.error('Orders load error:', error);
                    if (summaryEl) {
                        summaryEl.classList.remove('loading');
                        summaryEl.innerHTML = `
                            <div class="orders-empty-state">
                                <p>${escapeHTML(error.message || 'We could not load your orders right now.')}</p>
                                <button type="button" class="btn-outline" id="retryOrdersBtn">Retry</button>
                            </div>
                        `;

                        const retryBtn = document.getElementById('retryOrdersBtn');
                        if (retryBtn) {
                            retryBtn.addEventListener('click', () => {
                                summaryEl.innerHTML = `
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p style="margin-top: 0.5rem;">Retrying...</p>
                                    </div>
                                `;
                                refreshOrders(true);
                            });
                        }
                    }

                    if (listEl) listEl.innerHTML = '';
                }
            }

            await refreshOrders(true);

            const refreshBtn = document.getElementById('refreshOrdersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    const summaryEl = document.getElementById('ordersSummary');
                    if (summaryEl) {
                        summaryEl.innerHTML = `
                            <div class="loading">
                                <div class="spinner"></div>
                                <p style="margin-top: 0.5rem;">Refreshing...</p>
                            </div>
                        `;
                    }
                    refreshOrders(true);
                });
            }
        }

        // Load Bids
        async function loadBids() {
            // Get user data for bidding username display
            const user = JSON.parse(sessionStorage.getItem('sbs_user') || '{}');
            
            // Check if there's a new bid submitted from shop page
            const newBidTimestamp = localStorage.getItem('sbs_new_bid_submitted');
            const hasNewBid = newBidTimestamp && (Date.now() - parseInt(newBidTimestamp) < 60000); // Within last minute
            
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="section">
                    ${hasNewBid ? `
                        <div id="newBidNotice" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; color: white; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <div>
                                <strong style="display: block; margin-bottom: 0.25rem;">Bid Submitted Successfully!</strong>
                                <span style="opacity: 0.9; font-size: 0.9rem;">Your new bid appears below.</span>
                            </div>
                        </div>
                    ` : ''}
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%); border: 1px solid rgba(255, 215, 0, 0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">üèÜ</span>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Bidding As</div>
                                    <div id="biddingUsernameDisplay" style="font-size: 1.1rem; font-weight: 700; color: var(--primary-gold);">
                                        ${user?.bidding_username || '<span style="color: var(--text-secondary); font-style: italic;">Not set</span>'}
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn-outline" onclick="loadSection('profile'); return false;" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                                ‚úèÔ∏è Edit
                            </button>
                        </div>
                    </div>
                    <div class="section-header">
                        <h2 class="section-title">üí∞ My Bids</h2>
                        <button type="button" class="btn-outline" id="refreshBidsBtn">üîÑ Refresh</button>
                    </div>
                    <div id="bidsLoading" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 0.5rem;">Loading your bids...</p>
                    </div>
                    <div id="bidsContainer" style="display: none;">
                        <div id="bidsSummary" class="stats-grid" style="margin-bottom: 2rem;"></div>
                        <div id="bidsList"></div>
                    </div>
                </div>
            `;
            
            // Clear the new bid flag after showing notice
            if (hasNewBid) {
                localStorage.removeItem('sbs_new_bid_submitted');
                
                // Auto-hide notice after 5 seconds
                setTimeout(() => {
                    const notice = document.getElementById('newBidNotice');
                    if (notice) {
                        notice.style.transition = 'opacity 0.3s ease';
                        notice.style.opacity = '0';
                        setTimeout(() => notice.remove(), 300);
                    }
                }, 5000);
            }

            async function refreshBids() {
                const loadingBlock = document.getElementById('bidsLoading');
                const container = document.getElementById('bidsContainer');

                try {
                    if (loadingBlock) loadingBlock.style.display = 'flex';
                    if (container) container.style.display = 'none';

                    const response = await fetch('/api/users/me/bids', {
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'Failed to load bids');
                    }

                    renderBids(data.bids || []);

                    if (loadingBlock) loadingBlock.style.display = 'none';
                    if (container) container.style.display = 'block';
                } catch (error) {
                    console.error('Bids load error:', error);
                    if (loadingBlock) {
                        loadingBlock.innerHTML = `
                            <p style="color: var(--danger-red);">‚ùå Failed to load bids</p>
                            <button type="button" class="btn-outline" onclick="loadSection('bids')">Try Again</button>
                        `;
                    }
                }
            }

            function renderBids(bids) {
                const summaryEl = document.getElementById('bidsSummary');
                const listEl = document.getElementById('bidsList');

                // Ensure bids is an array
                if (!Array.isArray(bids)) {
                    bids = [];
                }

                // Calculate stats with safe defaults
                const totalBids = bids.length;
                const activeBids = bids.filter(b => b && b.status === 'pending').length;
                const acceptedBids = bids.filter(b => b && b.status === 'accepted').length;
                const totalAmount = bids.reduce((sum, b) => {
                    const amount = parseFloat(b?.offer_amount);
                    return sum + (isNaN(amount) ? 0 : amount);
                }, 0);

                // Render summary
                if (summaryEl) {
                    summaryEl.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${totalBids}</div>
                            <div class="stat-label">Total Bids</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${activeBids}</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${acceptedBids}</div>
                            <div class="stat-label">Accepted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">‚Ç¨${totalAmount.toFixed(2)}</div>
                            <div class="stat-label">Total Offered</div>
                        </div>
                    `;
                }

                // Render bids list
                if (listEl) {
                    if (bids.length === 0) {
                        listEl.innerHTML = `
                            <div class="empty-state">
                                <p style="font-size: 3rem; margin-bottom: 1rem;">üí∞</p>
                                <h3>No Bids Yet</h3>
                                <p>Start making offers on items you love!</p>
                                <a href="/shop" class="btn-primary" style="margin-top: 1rem; display: inline-block;">Browse Shop</a>
                            </div>
                        `;
                    } else {
                        listEl.innerHTML = `
                            <div class="bids-grid">
                                ${bids.map(bid => renderBidCard(bid)).join('')}
                            </div>
                        `;
                    }
                }
            }

            // Refresh button handler
            const refreshBtn = document.getElementById('refreshBidsBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshBids);
            }

            // Initial load
            refreshBids();
        }

        // Load Submissions
        async function loadSubmissions() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">My Sell Submissions</h2>
                        <button type="button" class="btn-outline" id="refreshSubmissionsBtn">üîÑ Refresh</button>
                    </div>
                    <div id="submissionsLoading" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 0.5rem;">Fetching your submissions...</p>
                    </div>
                    <div id="submissionsContainer" style="display: none;">
                        <div id="submissionsSummary"></div>
                        <div id="submissionsFilters" class="submission-filter-bar"></div>
                        <div id="submissionsList"></div>
                        <div id="submissionsLoadMore" class="submission-load-more" style="display: none;">
                            <button type="button" class="btn-outline" id="submissionsLoadMoreBtn">Show more</button>
                        </div>
                    </div>
                </div>
            `;

            const refreshBtn = document.getElementById('refreshSubmissionsBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => loadSubmissions());
            }

            try {
                const token = sessionStorage.getItem('sbs_csrf_token');
                const response = await fetch('/api/sell-submissions?limit=1500', {
                    method: 'GET',
                    headers: {
                        'X-CSRF-Token': token || ''
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to load sell submissions');
                }

                submissionsState = {
                    entries: (data.submissions || []).map(entry => ({
                        ...entry,
                        items: Array.isArray(entry.items) ? entry.items : []
                    })),
                    summary: Array.isArray(data.summary) ? data.summary : [],
                    filter: 'all',
                    visible: 20
                };

                const loadingBlock = document.getElementById('submissionsLoading');
                if (loadingBlock) loadingBlock.style.display = 'none';

                const container = document.getElementById('submissionsContainer');
                if (container) container.style.display = 'block';

                renderSubmissionSummary();
                renderSubmissionFilters();
                renderSubmissionList();

                const loadMoreBtn = document.getElementById('submissionsLoadMoreBtn');
                if (loadMoreBtn) {
                    loadMoreBtn.addEventListener('click', () => {
                        loadMoreSubmissions();
                    });
                }

            } catch (error) {
                console.error('Load submissions error:', error);
                const loadingBlock = document.getElementById('submissionsLoading');
                if (loadingBlock) {
                    loadingBlock.innerHTML = `
                        <div class="submission-empty">
                            <p style="color: var(--danger-red); font-weight: 600;">${escapeHTML(error.message || 'Failed to load submissions.')}</p>
                            <button type="button" class="btn-outline" style="margin-top: 1rem;" id="retrySubmissionsBtn">Retry</button>
                        </div>
                    `;

                    const retryBtn = document.getElementById('retrySubmissionsBtn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => loadSubmissions());
                    }
                }
            }
        }

        function renderSubmissionSummary() {
            const summaryEl = document.getElementById('submissionsSummary');
            const filtersEl = document.getElementById('submissionsFilters');
            const loadMoreEl = document.getElementById('submissionsLoadMore');
            const listEl = document.getElementById('submissionsList');

            if (!summaryEl) return;

            if (!submissionsState.entries.length) {
                summaryEl.innerHTML = `
                    <div class="submission-empty">
                        <p>You haven't submitted any items yet.</p>
                        <a href="/sell.html" class="btn-gold" style="display: inline-block; margin-top: 1rem;">Sell Items</a>
                    </div>
                `;

                if (filtersEl) filtersEl.style.display = 'none';
                if (listEl) {
                    listEl.innerHTML = `
                        <div class="submission-empty">
                            <p>Your submission history will appear here once you send us items to review.</p>
                        </div>
                    `;
                }
                if (loadMoreEl) loadMoreEl.style.display = 'none';
                return;
            }

            if (filtersEl) filtersEl.style.display = 'flex';

            const summaryData = submissionsState.summary.length
                ? submissionsState.summary.map(item => ({
                    status: normaliseStatus(item.status),
                    count: Number(item.count || 0),
                    items: Number(item.items || 0)
                }))
                : computeSummaryFromEntries(submissionsState.entries);

            const totalSubmissions = submissionsState.entries.length;
            const totalItems = submissionsState.entries.reduce((acc, entry) => {
                if (Array.isArray(entry.items)) return acc + entry.items.length;
                const count = Number(entry.item_count) || 0;
                return acc + count;
            }, 0);

            const orderedStatuses = STATUS_ORDER.filter(status =>
                summaryData.some(item => item.status === status)
            );

            const additionalStatuses = summaryData
                .map(item => item.status)
                .filter(status => !orderedStatuses.includes(status));

            const combinedStatuses = [...orderedStatuses, ...new Set(additionalStatuses)];

            const cardsHtml = combinedStatuses.map(statusKey => {
                const summaryItem = summaryData.find(item => item.status === statusKey);
                if (!summaryItem) return '';
                const config = getStatusConfig(statusKey);
                const count = summaryItem.count;
                const items = summaryItem.items;
                return `
                    <div class="status-summary-card" style="background: ${config.summaryBg}; border-color: ${config.summaryBorder};">
                        <h3>${config.icon} ${config.label}</h3>
                        <div class="status-summary-metric">${count}</div>
                        <div class="status-summary-meta">${items} item${items === 1 ? '' : 's'}</div>
                    </div>
                `;
            }).join('');

            summaryEl.innerHTML = `
                <div class="status-summary-grid">
                    <div class="status-summary-card primary">
                        <h3>üì¶ Total Submissions</h3>
                        <div class="status-summary-metric">${totalSubmissions}</div>
                        <div class="status-summary-meta">${totalItems} item${totalItems === 1 ? '' : 's'} total</div>
                    </div>
                    ${cardsHtml}
                </div>
            `;
        }

        function renderSubmissionFilters() {
            const filtersEl = document.getElementById('submissionsFilters');
            if (!filtersEl) return;

            if (!submissionsState.entries.length) {
                filtersEl.innerHTML = '';
                filtersEl.style.display = 'none';
                return;
            }

            const statusCounts = new Map();
            submissionsState.entries.forEach(entry => {
                const key = normaliseStatus(entry.status);
                statusCounts.set(key, (statusCounts.get(key) || 0) + 1);
            });

            const sortedStatuses = STATUS_ORDER.filter(status => statusCounts.has(status));
            statusCounts.forEach((_, key) => {
                if (!sortedStatuses.includes(key)) {
                    sortedStatuses.push(key);
                }
            });

            const buttons = [`<button type="button" data-status="all" class="${submissionsState.filter === 'all' ? 'active' : ''}">All (${submissionsState.entries.length})</button>`]
                .concat(sortedStatuses.map(status => {
                    const config = getStatusConfig(status);
                    const count = statusCounts.get(status) || 0;
                    return `<button type="button" data-status="${status}" class="${submissionsState.filter === status ? 'active' : ''}">${config.icon} ${config.label} (${count})</button>`;
                }));

            filtersEl.innerHTML = buttons.join('');

            filtersEl.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    setSubmissionFilter(button.dataset.status);
                });
            });
        }

        function renderSubmissionList() {
            const listEl = document.getElementById('submissionsList');
            const loadMoreEl = document.getElementById('submissionsLoadMore');
            if (!listEl) return;

            const filtered = getFilteredSubmissions();

            if (!filtered.length) {
                listEl.innerHTML = `
                    <div class="submission-empty">
                        <p>No submissions in this filter yet.</p>
                        <a href="/sell.html" class="btn-gold" style="display: inline-block; margin-top: 1rem;">Sell Items</a>
                    </div>
                `;
                if (loadMoreEl) loadMoreEl.style.display = 'none';
                return;
            }

            const visible = filtered.slice(0, submissionsState.visible);
            listEl.innerHTML = visible.map(renderSubmissionCard).join('');

            if (loadMoreEl) {
                loadMoreEl.style.display = filtered.length > submissionsState.visible ? 'block' : 'none';
            }
        }

        function renderSubmissionCard(submission) {
            const statusKey = normaliseStatus(submission.status);
            const statusConfig = getStatusConfig(statusKey);
            const batchLabel = submission.batch_id ? escapeHTML(submission.batch_id) : `Submission #${escapeHTML(String(submission.id || ''))}`;
            const createdAt = formatDateTime(submission.created_at);
            const updatedAt = submission.updated_at && submission.updated_at !== submission.created_at
                ? formatDateTime(submission.updated_at)
                : null;

            const items = Array.isArray(submission.items) ? submission.items : [];
            const itemCount = items.length || Number(submission.item_count) || 0;

            const itemsList = items.slice(0, 6).map((item, idx) => {
                const brand = escapeHTML(item.brand || 'Unknown');
                const category = escapeHTML(item.category || 'Item');
                const size = item.size ? ` ‚Äî Size ${escapeHTML(item.size)}` : '';
                const condition = escapeHTML(item.condition || 'Condition N/A');
                const defects = item.defects ? `<span style="color: var(--warning-orange);"> ‚Ä¢ Issues: ${escapeHTML(item.defects)}</span>` : '';
                return `<li><strong>${idx + 1}.</strong> ${brand} ${category}${size} ‚Ä¢ ${condition}${defects}</li>`;
            }).join('');

            const hiddenItemsCount = Math.max(itemCount - 6, 0);
            const moreItemsHint = hiddenItemsCount > 0
                ? `<p style="color: var(--text-secondary); margin-top: 0.5rem;">+ ${hiddenItemsCount} more item${hiddenItemsCount === 1 ? '' : 's'}.</p>`
                : '';

            const contactBits = [];
            if (submission.contact_channel) {
                const channel = escapeHTML(submission.contact_channel);
                const handle = submission.contact_handle ? ` ‚Ä¢ ${escapeHTML(submission.contact_handle)}` : '';
                contactBits.push(`${channel}${handle}`);
            } else if (submission.contact_handle) {
                contactBits.push(escapeHTML(submission.contact_handle));
            }
            if (submission.contact_phone) {
                contactBits.push(escapeHTML(submission.contact_phone));
            }
            if (submission.contact_email) {
                contactBits.push(escapeHTML(submission.contact_email));
            }

            const metaBits = [];
            metaBits.push(`üìÖ ${createdAt}`);
            if (updatedAt) metaBits.push(`üîÅ Updated ${updatedAt}`);
            metaBits.push(`üßæ ${itemCount} item${itemCount === 1 ? '' : 's'}`);
            if (submission.city || submission.eircode) {
                const city = submission.city ? escapeHTML(submission.city) : '';
                const eir = submission.eircode ? ` ${escapeHTML(submission.eircode)}` : '';
                metaBits.push(`üìç ${city}${eir}`.trim());
            }
            if (contactBits.length) {
                metaBits.push(`üì£ ${contactBits.join(' ‚Ä¢ ')}`);
            }

            const sellerNotes = submission.seller_message ? `
                <div class="submission-note">
                    <strong>Your Notes</strong>
                    <p style="margin-top: 0.4rem;">${escapeHTML(submission.seller_message)}</p>
                </div>
            ` : '';

            const extraNotes = submission.notes && submission.notes !== submission.seller_message ? `
                <div class="submission-note" style="background: rgba(255, 255, 255, 0.03); border-left-color: rgba(255, 255, 255, 0.2); color: var(--text-secondary);">
                    <strong>Submission Notes</strong>
                    <p style="margin-top: 0.4rem;">${escapeHTML(submission.notes)}</p>
                </div>
            ` : '';

            const offerSection = submission.offer_message || submission.offer_sent_at || submission.offer_expires_at || submission.offered_price ? `
                <div class="submission-offer">
                    <strong>SBS Offer</strong>
                    ${submission.offer_message ? `<p style="margin-top: 0.4rem;">${escapeHTML(submission.offer_message)}</p>` : '<p style="margin-top: 0.4rem;">We have reviewed your items and shared an offer.</p>'}
                    ${submission.offer_sent_at ? `<p style="margin-top: 0.5rem; color: var(--text-secondary);">Sent ${formatDateTime(submission.offer_sent_at)}</p>` : ''}
                    ${submission.offer_expires_at ? `<p style="margin-top: 0.25rem; color: var(--text-secondary);">Expires ${formatDateTime(submission.offer_expires_at)}</p>` : ''}
                </div>
            ` : '';

            const responseSection = submission.seller_response || submission.seller_response_message || submission.seller_response_at ? `
                <div class="submission-offer" style="background: rgba(255, 215, 0, 0.12); border-left-color: var(--primary-gold);">
                    <strong>Your Response</strong>
                    ${submission.seller_response ? `<p style="margin-top: 0.4rem;">Status: ${escapeHTML(submission.seller_response)}</p>` : ''}
                    ${submission.seller_response_message ? `<p style="margin-top: 0.4rem;">${escapeHTML(submission.seller_response_message)}</p>` : ''}
                    ${submission.seller_response_at ? `<p style="margin-top: 0.4rem; color: var(--text-secondary);">Responded ${formatDateTime(submission.seller_response_at)}</p>` : ''}
                </div>
            ` : '';

            const outcomeSection = submission.final_price ? `
                <div class="submission-outcome">
                    <strong>Outcome</strong>
                    <p style="margin-top: 0.4rem;">Final agreed price: ${formatCurrency(submission.final_price)}</p>
                    ${submission.admin_notes ? `<p style="margin-top: 0.4rem; color: var(--text-secondary);">${escapeHTML(submission.admin_notes)}</p>` : ''}
                </div>
            ` : '';

            return `
                <div class="submission-card">
                    <div class="submission-card-header">
                        <h3>${batchLabel}</h3>
                        <span class="${statusConfig.badgeClass}">${statusConfig.icon} ${statusConfig.label}</span>
                    </div>
                    <div class="submission-meta">
                        ${metaBits.map(bit => `<span>${bit}</span>`).join('')}
                    </div>
                    <div class="submission-values">
                        <div class="submission-value">
                            <strong>Your Asking</strong>
                            <span>${formatCurrency(submission.seller_price)}</span>
                        </div>
                        <div class="submission-value">
                            <strong>SBS Estimate</strong>
                            <span>${formatCurrency(submission.estimated_value)}</span>
                        </div>
                        <div class="submission-value">
                            <strong>Offer</strong>
                            <span>${formatCurrency(submission.offered_price)}</span>
                        </div>
                        <div class="submission-value">
                            <strong>Final</strong>
                            <span>${formatCurrency(submission.final_price)}</span>
                        </div>
                    </div>
                    ${sellerNotes}
                    ${extraNotes}
                    ${offerSection}
                    ${responseSection}
                    ${outcomeSection}
                    <div class="submission-items">
                        <strong>Items</strong>
                        <ul>${itemsList || '<li>No item details captured.</li>'}</ul>
                        ${moreItemsHint}
                    </div>
                </div>
            `;
        }

        function renderSubmissionPreview(submission) {
            const statusConfig = getStatusConfig(submission.status);
            const items = Array.isArray(submission.items) ? submission.items : [];
            const itemCount = items.length || Number(submission.item_count) || 0;
            const createdAt = formatDateTime(submission.created_at);
            const batchLabel = submission.batch_id ? escapeHTML(submission.batch_id) : `Submission #${escapeHTML(String(submission.id || ''))}`;

            let priceSnippet = '';
            if (submission.offered_price) {
                priceSnippet = `${formatCurrency(submission.offered_price)} offer`;
            } else if (submission.seller_price) {
                priceSnippet = `${formatCurrency(submission.seller_price)} asking`;
            }

            return `
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; align-items: center;">
                        <div>
                            <div class="card-title">${batchLabel}</div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.35rem;">
                                ${itemCount} item${itemCount === 1 ? '' : 's'} ‚Ä¢ ${createdAt}
                            </div>
                        </div>
                        <span class="${statusConfig.badgeClass}" style="flex-shrink: 0;">${statusConfig.label}</span>
                    </div>
                    ${priceSnippet ? `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">${priceSnippet}</p>` : ''}
                </div>
            `;
        }

        // Load Edit Profile Form
        function loadProfileEdit() {
            const user = JSON.parse(sessionStorage.getItem('sbs_user'));
            const content = document.getElementById('mainContent');

            const safeUser = {
                firstName: escapeAttr(user?.first_name || ''),
                lastName: escapeAttr(user?.last_name || ''),
                handle: escapeAttr(user?.social_handle || ''),
                biddingUsername: escapeAttr(user?.bidding_username || ''),
                email: escapeAttr(user?.email || ''),
                phone: escapeAttr(user?.phone || ''),
                address: escapeAttr(user?.address || ''),
                city: escapeAttr(user?.city || 'Dublin'),
                eircode: escapeAttr(user?.eircode || ''),
                instagram: escapeAttr(user?.instagram || ''),
                snapchat: escapeAttr(user?.snapchat || '')
            };

            content.innerHTML = `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Edit Profile</h2>
                    </div>

                    <form id="profileForm" style="max-width: 600px;">
                        <div class="card">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary-gold);">Personal Information</h3>

                            <div style="display: grid; gap: 1.5rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">First Name</label>
                                        <input type="text" id="edit-first-name" value="${safeUser.firstName}"
                                               style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Last Name</label>
                                        <input type="text" id="edit-last-name" value="${safeUser.lastName}"
                                               style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    </div>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Username (Social Handle)</label>
                                    <input type="text" id="edit-social-handle" value="${safeUser.handle}"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Used for login</small>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">üèÜ Bidding Username</label>
                                    <input type="text" id="edit-bidding-username" value="${safeUser.biddingUsername}"
                                           placeholder="Enter your bidding alias" maxlength="30"
                                           style="width: 100%; padding: 0.75rem; background: rgba(212,175,55,0.1); border: 2px solid rgba(212,175,55,0.3); border-radius: 8px; color: var(--primary-gold); font-size: 1rem; font-weight: 600;">
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                                        üí° This name will appear publicly on your bids (others won't see your real name). 
                                        <strong style="color: var(--primary-gold);">We can still contact you!</strong>
                                    </small>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                    <input type="email" id="edit-email" value="${safeUser.email}"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone</label>
                                    <input type="tel" id="edit-phone" value="${safeUser.phone}" placeholder="+353..."
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary-gold);">Address</h3>

                            <div style="display: grid; gap: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Street Address</label>
                                    <input type="text" id="edit-address" value="${safeUser.address}"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">City</label>
                                        <input type="text" id="edit-city" value="${safeUser.city}"
                                               style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Eircode</label>
                                        <input type="text" id="edit-eircode" value="${safeUser.eircode}"
                                               style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary-gold);">Social Media Handles</h3>

                            <div style="display: grid; gap: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">üì∏ Instagram</label>
                                    <input type="text" id="edit-instagram" value="${safeUser.instagram}" placeholder="@yourusername"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">üëª Snapchat</label>
                                    <input type="text" id="edit-snapchat" value="${safeUser.snapchat}" placeholder="yourusername"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Preferred Contact Method</label>
                                    <select id="edit-preferred-contact"
                                            style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                        <option value="instagram" ${user.preferred_contact === 'instagram' ? 'selected' : ''}>Instagram</option>
                                        <option value="snapchat" ${user.preferred_contact === 'snapchat' ? 'selected' : ''}>Snapchat</option>
                                        <option value="phone" ${user.preferred_contact === 'phone' ? 'selected' : ''}>Phone</option>
                                        <option value="email" ${user.preferred_contact === 'email' ? 'selected' : ''}>Email</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1.5rem; background: rgba(255, 215, 0, 0.05); border-color: rgba(255, 215, 0, 0.2);">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary-gold);">üîí Change Password</h3>

                            <div style="display: grid; gap: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Current Password</label>
                                    <input type="password" id="edit-current-password" placeholder="Enter current password"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">New Password</label>
                                    <input type="password" id="edit-new-password" placeholder="Enter new password"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Leave blank to keep current password</small>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Confirm New Password</label>
                                    <input type="password" id="edit-confirm-password" placeholder="Confirm new password"
                                           style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="submit" class="btn-gold" style="flex: 1; padding: 1rem; font-size: 1rem; border: none; cursor: pointer;">
                                üíæ Save Changes
                            </button>
                            <button type="button" onclick="loadSection('overview')" class="btn-outline" style="padding: 1rem 2rem; font-size: 1rem; cursor: pointer;">
                                Cancel
                            </button>
                        </div>

                        <div id="profile-message" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                    </form>
                </div>
            `;

            // Handle form submission
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveProfile();
            });
        }

        // Save profile updates
        async function saveProfile() {
            const messageDiv = document.getElementById('profile-message');
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
                messageDiv.style.background = '';
                messageDiv.style.borderLeft = '';
            }

            const updates = {
                first_name: document.getElementById('edit-first-name').value,
                last_name: document.getElementById('edit-last-name').value,
                social_handle: document.getElementById('edit-social-handle').value,
                bidding_username: document.getElementById('edit-bidding-username').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                address: document.getElementById('edit-address').value,
                city: document.getElementById('edit-city').value,
                eircode: document.getElementById('edit-eircode').value,
                instagram: document.getElementById('edit-instagram').value,
                snapchat: document.getElementById('edit-snapchat').value,
                preferred_contact: document.getElementById('edit-preferred-contact').value
            };

            const currentPassword = document.getElementById('edit-current-password').value;
            const newPassword = document.getElementById('edit-new-password').value;
            const confirmPassword = document.getElementById('edit-confirm-password').value;

            if (newPassword) {
                if (newPassword !== confirmPassword) {
                    showProfileMessage('error', '‚ö†Ô∏è Passwords don\'t match!');
                    return;
                }
                if (!currentPassword) {
                    showProfileMessage('error', '‚ö†Ô∏è Current password required to change password!');
                    return;
                }
                updates.current_password = currentPassword;
                updates.new_password = newPassword;
            }

            const token = sessionStorage.getItem('sbs_csrf_token');

            try {
                const response = await fetch('/api/users/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify(updates)
                });

                const data = await response.json();

                if (data.success) {
                    // Update session storage with new user data
                    sessionStorage.setItem('sbs_user', JSON.stringify(data.user));

                    showProfileMessage('success', '‚úÖ Profile updated successfully!');

                    // Clear password fields
                    document.getElementById('edit-current-password').value = '';
                    document.getElementById('edit-new-password').value = '';
                    document.getElementById('edit-confirm-password').value = '';

                    // Reload profile display
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const errorText = data.error ? `‚ö†Ô∏è ${data.error}` : '‚ö†Ô∏è Update failed';
                    showProfileMessage('error', errorText);
                }
            } catch (error) {
                console.error('Update error:', error);
                showProfileMessage('error', '‚ö†Ô∏è Network error. Please try again.');
            }
        }

        // Load Settings (Privacy & GDPR)
        function loadSettings() {
            const user = JSON.parse(sessionStorage.getItem('sbs_user'));
            const content = document.getElementById('mainContent');

            const safeFirstName = escapeHTML(user?.first_name || '');
            const safeLastName = escapeHTML(user?.last_name || '');
            const safeHandle = escapeHTML(user?.social_handle || 'Not set');
            const safeEmail = escapeHTML(user?.email || 'Not set');
            const safePhone = escapeHTML(user?.phone || 'Not set');
            const safeInstagram = escapeHTML(user?.instagram || 'Not set');
            const safeSnapchat = escapeHTML(user?.snapchat || 'Not set');

            content.innerHTML = `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Privacy & Data Settings</h2>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 1rem;">Account Information</h3>
                        <div class="card-details">
                            <p><strong>Name:</strong> ${safeFirstName} ${safeLastName}</p>
                            <p><strong>Username:</strong> ${safeHandle}</p>
                            <p><strong>Email:</strong> ${safeEmail}</p>
                            <p><strong>Phone:</strong> ${safePhone}</p>
                            <p><strong>Instagram:</strong> ${safeInstagram}</p>
                            <p><strong>Snapchat:</strong> ${safeSnapchat}</p>
                        </div>
                        <button onclick="loadSection('profile')" class="btn-outline" style="margin-top: 1rem; cursor: pointer;">‚úèÔ∏è Edit Profile</button>
                    </div>

                    <div class="gdpr-section">
                        <h3>üîí Data & Privacy (GDPR Compliant)</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            You have full control over your personal data. You can request your data or delete your account at any time.
                        </p>
                        <div class="gdpr-actions">
                            <button class="btn-outline" onclick="downloadMyData()">üì• Download My Data</button>
                            <button class="btn-danger" onclick="openDeleteModal()">üóëÔ∏è Delete Account</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // GDPR Functions
        function downloadMyData() {
            const user = JSON.parse(sessionStorage.getItem('sbs_user'));
            const dataStr = JSON.stringify(user, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sbs-account-data-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function openDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            document.getElementById('deleteConfirm').value = '';
        }

        async function confirmDelete() {
            const confirmText = document.getElementById('deleteConfirm').value;

            if (confirmText !== 'DELETE') {
                alert('Please type DELETE to confirm');
                return;
            }

            const user = JSON.parse(sessionStorage.getItem('sbs_user'));
            const token = sessionStorage.getItem('sbs_csrf_token');

            try {
                const response = await fetch('/api/users/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({ user_id: user.id })
                });

                if (response.ok) {
                    sessionStorage.clear();
                    alert('Your account has been deleted. We\'re sorry to see you go!');
                    window.location.href = '/';
                } else {
                    const data = await response.json();
                    alert(data.message || 'Failed to delete account. Please contact support.');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete account. Please try again or contact support.');
            }
        }

        // Menu click handlers
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                loadSection(link.dataset.section);
            });
        });

        // Initialize
        loadProfile();
        loadSection('overview');
    </script>
</body>

</html>
